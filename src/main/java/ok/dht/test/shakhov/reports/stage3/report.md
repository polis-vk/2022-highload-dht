Все результаты получены при 3 запущенных в разных процессах нодах на одном компьютере.

# Нагрузчное тестирование

Я стрелял только в одну ноду, она проксировала запросы к другим. Необходимо ожидать, что
результаты будут хуже, чем в предыдущем этапе, так как ресурсы моего компьютера остались те же, но их использование увеличилось в 3 раза,
и также добавилось сетевое взаимодействие между нодами, оно нужно для коммуникации между разными хостами, но оно не бесплатное. 

## PUT
```
math.randomseed(os.time())

function request()
  path = "/v0/entity?id=" .. tostring(math.random(1, 10000000))
  body = tostring(math.random(1, 10000000))
  return wrk.format("PUT", path, wrk.headers, body)
end
```
Методом дихотомии была найдена точка разладки на 10K RPS, сервис не смог справиться с заданным RPS.
График latency очень быстро растет.

```
wrk -d 120 -t 4 -c 64 -R 10000 -L -s ./put.lua http://localhost:19234
Running 2m test @ http://localhost:19234
  4 threads and 64 connections
  Thread calibration: mean lat.: 1.556ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.552ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.568ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.570ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.27s     1.24s    4.00s    60.24%
    Req/Sec     2.54k   362.40     4.44k    74.65%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%  918.53ms
 75.000%    2.24s
 90.000%    3.23s
 99.000%    3.90s
 99.900%    3.96s
 99.990%    3.98s
 99.999%    3.99s
100.000%    4.00s

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.085     0.000000            1         1.00
       3.201     0.100000       105987         1.11
      41.471     0.200000       211897         1.25
     183.423     0.300000       317865         1.43
     493.311     0.400000       423820         1.67
     918.527     0.500000       529750         2.00
    1129.471     0.550000       582804         2.22
    1368.063     0.600000       635833         2.50
    1645.567     0.650000       688772         2.86
    1922.047     0.700000       741680         3.33
    2236.415     0.750000       794855         4.00
    2400.255     0.775000       821262         4.44
    2576.383     0.800000       847618         5.00
    2768.895     0.825000       874346         5.71
    2918.399     0.850000       900789         6.67
    3065.855     0.875000       927499         8.00
    3145.727     0.887500       940312         8.89
    3227.647     0.900000       953646        10.00
    3371.007     0.912500       966903        11.43
    3440.639     0.925000       980023        13.33
    3530.751     0.937500       993637        16.00
    3575.807     0.943750      1000091        17.78
    3624.959     0.950000      1006646        20.00
    3678.207     0.956250      1013392        22.86
    3727.359     0.962500      1019771        26.67
    3772.415     0.968750      1026410        32.00
    3784.703     0.971875      1029873        35.56
    3801.087     0.975000      1033098        40.00
    3823.615     0.978125      1036327        45.71
    3844.095     0.981250      1039688        53.33
    3868.671     0.984375      1043261        64.00
    3876.863     0.985938      1044731        71.11
    3885.055     0.987500      1046261        80.00
    3893.247     0.989062      1048059        91.43
    3899.391     0.990625      1049570       106.67
    3909.631     0.992188      1051555       128.00
    3913.727     0.992969      1052324       142.22
    3917.823     0.993750      1053186       160.00
    3921.919     0.994531      1054028       182.86
    3926.015     0.995313      1054728       213.33
    3932.159     0.996094      1055482       256.00
    3936.255     0.996484      1055934       284.44
    3940.351     0.996875      1056396       320.00
    3942.399     0.997266      1056630       365.71
    3946.495     0.997656      1057059       426.67
    3950.591     0.998047      1057434       512.00
    3954.687     0.998242      1057755       568.89
    3956.735     0.998437      1057927       640.00
    3958.783     0.998633      1058107       731.43
    3960.831     0.998828      1058282       853.33
    3964.927     0.999023      1058559      1024.00
    3964.927     0.999121      1058559      1137.78
    3966.975     0.999219      1058738      1280.00
    3969.023     0.999316      1058897      1462.86
    3969.023     0.999414      1058897      1706.67
    3971.071     0.999512      1059025      2048.00
    3971.071     0.999561      1059025      2275.56
    3973.119     0.999609      1059098      2560.00
    3975.167     0.999658      1059181      2925.71
    3975.167     0.999707      1059181      3413.33
    3977.215     0.999756      1059260      4096.00
    3977.215     0.999780      1059260      4551.11
    3979.263     0.999805      1059301      5120.00
    3979.263     0.999829      1059301      5851.43
    3981.311     0.999854      1059337      6826.67
    3983.359     0.999878      1059383      8192.00
    3983.359     0.999890      1059383      9102.22
    3983.359     0.999902      1059383     10240.00
    3985.407     0.999915      1059399     11702.86
    3987.455     0.999927      1059431     13653.33
    3987.455     0.999939      1059431     16384.00
    3987.455     0.999945      1059431     18204.44
    3987.455     0.999951      1059431     20480.00
    3989.503     0.999957      1059442     23405.71
    3989.503     0.999963      1059442     27306.67
    3991.551     0.999969      1059464     32768.00
    3991.551     0.999973      1059464     36408.89
    3991.551     0.999976      1059464     40960.00
    3991.551     0.999979      1059464     46811.43
    3991.551     0.999982      1059464     54613.33
    3991.551     0.999985      1059464     65536.00
    3991.551     0.999986      1059464     72817.78
    3993.599     0.999988      1059474     81920.00
    3993.599     0.999989      1059474     93622.86
    3993.599     0.999991      1059474    109226.67
    3993.599     0.999992      1059474    131072.00
    3993.599     0.999993      1059474    145635.56
    3993.599     0.999994      1059474    163840.00
    3993.599     0.999995      1059474    187245.71
    3993.599     0.999995      1059474    218453.33
    3993.599     0.999996      1059474    262144.00
    3995.647     0.999997      1059476    291271.11
    3995.647     0.999997      1059476    327680.00
    3995.647     0.999997      1059476    374491.43
    3995.647     0.999998      1059476    436906.67
    3995.647     0.999998      1059476    524288.00
    3997.695     0.999998      1059477    582542.22
    3997.695     0.999998      1059477    655360.00
    3997.695     0.999999      1059477    748982.86
    3997.695     0.999999      1059477    873813.33
    3997.695     0.999999      1059477   1048576.00
    3999.743     0.999999      1059478   1165084.44
    3999.743     1.000000      1059478          inf
#[Mean    =     1268.814, StdDeviation   =     1235.396]
#[Max     =     3997.696, Total count    =      1059478]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  1159925 requests in 2.00m, 68.22MB read
Requests/sec:   9666.04
Transfer/sec:    582.18KB
```

Отступив на 20% от точки разладки (на 8K RPS) видим, что сервис уже справляется. 
График latency растет сильно медленее, но максимум latency сильно отличается от среднего, присутствуют скачки в latency у крайне правых перцентилей.
По сравнению с предыдущим этапом PUT сделал в 5 раз меньше RPS.

```
wrk -d 120 -t 4 -c 64 -R 8000 -L -s ./put.lua http://localhost:19234
Running 2m test @ http://localhost:19234
  4 threads and 64 connections
  Thread calibration: mean lat.: 1.410ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.385ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.321ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.744ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.95ms    1.06ms  18.29ms   74.87%
    Req/Sec     2.11k   339.88     3.67k    78.68%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.80ms
 75.000%    2.48ms
 90.000%    3.16ms
 99.000%    5.55ms
 99.900%    9.01ms
 99.990%   12.02ms
 99.999%   15.62ms
100.000%   18.30ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.066     0.000000            1         1.00
       0.799     0.100000        88180         1.11
       1.102     0.200000       175987         1.25
       1.344     0.300000       264053         1.43
       1.573     0.400000       352071         1.67
       1.805     0.500000       439838         2.00
       1.925     0.550000       484004         2.22
       2.051     0.600000       528264         2.50
       2.181     0.650000       571948         2.86
       2.321     0.700000       615761         3.33
       2.477     0.750000       659865         4.00
       2.563     0.775000       681913         4.44
       2.655     0.800000       703691         5.00
       2.757     0.825000       725621         5.71
       2.871     0.850000       747569         6.67
       3.003     0.875000       769620         8.00
       3.079     0.887500       780537         8.89
       3.165     0.900000       791552        10.00
       3.261     0.912500       802573        11.43
       3.373     0.925000       813432        13.33
       3.509     0.937500       824424        16.00
       3.593     0.943750       829988        17.78
       3.687     0.950000       835482        20.00
       3.799     0.956250       840934        22.86
       3.937     0.962500       846407        26.67
       4.115     0.968750       851883        32.00
       4.231     0.971875       854667        35.56
       4.367     0.975000       857391        40.00
       4.523     0.978125       860160        45.71
       4.711     0.981250       862901        53.33
       4.943     0.984375       865637        64.00
       5.075     0.985938       866999        71.11
       5.235     0.987500       868402        80.00
       5.419     0.989062       869747        91.43
       5.635     0.990625       871133       106.67
       5.895     0.992188       872495       128.00
       6.047     0.992969       873173       142.22
       6.227     0.993750       873871       160.00
       6.431     0.994531       874553       182.86
       6.663     0.995313       875239       213.33
       6.931     0.996094       875927       256.00
       7.099     0.996484       876274       284.44
       7.291     0.996875       876616       320.00
       7.507     0.997266       876954       365.71
       7.747     0.997656       877297       426.67
       8.019     0.998047       877643       512.00
       8.191     0.998242       877811       568.89
       8.367     0.998437       877988       640.00
       8.559     0.998633       878162       731.43
       8.783     0.998828       878330       853.33
       9.055     0.999023       878499      1024.00
       9.183     0.999121       878585      1137.78
       9.327     0.999219       878670      1280.00
       9.487     0.999316       878757      1462.86
       9.719     0.999414       878843      1706.67
       9.911     0.999512       878927      2048.00
      10.055     0.999561       878971      2275.56
      10.191     0.999609       879015      2560.00
      10.343     0.999658       879055      2925.71
      10.575     0.999707       879098      3413.33
      10.815     0.999756       879142      4096.00
      10.951     0.999780       879162      4551.11
      11.071     0.999805       879184      5120.00
      11.223     0.999829       879205      5851.43
      11.407     0.999854       879227      6826.67
      11.623     0.999878       879248      8192.00
      11.807     0.999890       879259      9102.22
      12.119     0.999902       879270     10240.00
      12.367     0.999915       879280     11702.86
      12.527     0.999927       879291     13653.33
      12.711     0.999939       879302     16384.00
      12.847     0.999945       879307     18204.44
      13.119     0.999951       879313     20480.00
      13.519     0.999957       879318     23405.71
      13.831     0.999963       879323     27306.67
      14.087     0.999969       879329     32768.00
      14.223     0.999973       879331     36408.89
      14.375     0.999976       879334     40960.00
      14.495     0.999979       879337     46811.43
      14.639     0.999982       879339     54613.33
      15.135     0.999985       879342     65536.00
      15.223     0.999986       879343     72817.78
      15.511     0.999988       879345     81920.00
      15.623     0.999989       879347     93622.86
      15.623     0.999991       879347    109226.67
      16.247     0.999992       879349    131072.00
      16.247     0.999993       879349    145635.56
      16.271     0.999994       879350    163840.00
      16.295     0.999995       879351    187245.71
      16.295     0.999995       879351    218453.33
      16.511     0.999996       879352    262144.00
      16.511     0.999997       879352    291271.11
      16.943     0.999997       879353    327680.00
      16.943     0.999997       879353    374491.43
      16.943     0.999998       879353    436906.67
      17.727     0.999998       879354    524288.00
      17.727     0.999998       879354    582542.22
      17.727     0.999998       879354    655360.00
      17.727     0.999999       879354    748982.86
      17.727     0.999999       879354    873813.33
      18.303     0.999999       879355   1048576.00
      18.303     1.000000       879355          inf
#[Mean    =        1.948, StdDeviation   =        1.056]
#[Max     =       18.288, Total count    =       879355]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  957793 requests in 2.00m, 56.34MB read
Requests/sec:   7981.49
Transfer/sec:    480.74KB
```


## GET
Скрипт:
```
math.randomseed(os.time())

function request()
  path = "/v0/entity?id=" .. tostring(math.random(1, 1000000))
  return wrk.format("GET", path, wrk.headers, wrk.body)
end
```
Методом дихотомии была найдена точка разладки на 7K RPS, сервис не смог справиться с заданным RPS.
Как и в случае с PUT график latency очень быстро растет.

```
wrk -d 120 -t 4 -c 64 -R 7000 -L -s ../get.lua http://localhost:19234
Running 2m test @ http://localhost:19234
  4 threads and 64 connections
  Thread calibration: mean lat.: 2.412ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 2.373ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 2.350ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 2.362ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     4.21s     3.63s   11.30s    53.85%
    Req/Sec     1.66k   273.72     3.00k    75.65%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    3.52s
 75.000%    7.37s
 90.000%    9.77s
 99.000%   11.10s
 99.900%   11.25s
 99.990%   11.29s
 99.999%   11.30s
100.000%   11.31s

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.095     0.000000            1         1.00
       5.747     0.100000        69112         1.11
     188.159     0.200000       138197         1.25
    1177.599     0.300000       207273         1.43
    2234.367     0.400000       276369         1.67
    3520.511     0.500000       345458         2.00
    4202.495     0.550000       380135         2.22
    5009.407     0.600000       414634         2.50
    5799.935     0.650000       449120         2.86
    6561.791     0.700000       483708         3.33
    7372.799     0.750000       518295         4.00
    7741.439     0.775000       535550         4.44
    8163.327     0.800000       552786         5.00
    8552.447     0.825000       570307         5.71
    8970.239     0.850000       587348         6.67
    9379.839     0.875000       604687         8.00
    9576.447     0.887500       613437         8.89
    9773.055     0.900000       621880        10.00
    9961.471     0.912500       630619        11.43
   10141.695     0.925000       639258        13.33
   10313.727     0.937500       647750        16.00
   10412.031     0.943750       652417        17.78
   10493.951     0.950000       656504        20.00
   10584.063     0.956250       660712        22.86
   10690.559     0.962500       665276        26.67
   10780.671     0.968750       669338        32.00
   10829.823     0.971875       671543        35.56
   10878.975     0.975000       673979        40.00
   10919.935     0.978125       675822        45.71
   10977.279     0.981250       678271        53.33
   11018.239     0.984375       680331        64.00
   11042.815     0.985938       681359        71.11
   11067.391     0.987500       682444        80.00
   11083.775     0.989062       683370        91.43
   11108.351     0.990625       684703       106.67
   11124.735     0.992188       685746       128.00
   11132.927     0.992969       686257       142.22
   11141.119     0.993750       686701       160.00
   11157.503     0.994531       687501       182.86
   11165.695     0.995313       687850       213.33
   11182.079     0.996094       688490       256.00
   11182.079     0.996484       688490       284.44
   11190.271     0.996875       688778       320.00
   11198.463     0.997266       689052       365.71
   11206.655     0.997656       689291       426.67
   11223.039     0.998047       689736       512.00
   11223.039     0.998242       689736       568.89
   11231.231     0.998437       689959       640.00
   11239.423     0.998633       690178       731.43
   11239.423     0.998828       690178       853.33
   11247.615     0.999023       690371      1024.00
   11247.615     0.999121       690371      1137.78
   11247.615     0.999219       690371      1280.00
   11255.807     0.999316       690507      1462.86
   11255.807     0.999414       690507      1706.67
   11263.999     0.999512       690623      2048.00
   11263.999     0.999561       690623      2275.56
   11272.191     0.999609       690714      2560.00
   11272.191     0.999658       690714      2925.71
   11272.191     0.999707       690714      3413.33
   11280.383     0.999756       690784      4096.00
   11280.383     0.999780       690784      4551.11
   11280.383     0.999805       690784      5120.00
   11288.575     0.999829       690846      5851.43
   11288.575     0.999854       690846      6826.67
   11288.575     0.999878       690846      8192.00
   11288.575     0.999890       690846      9102.22
   11288.575     0.999902       690846     10240.00
   11296.767     0.999915       690886     11702.86
   11296.767     0.999927       690886     13653.33
   11296.767     0.999939       690886     16384.00
   11296.767     0.999945       690886     18204.44
   11296.767     0.999951       690886     20480.00
   11296.767     0.999957       690886     23405.71
   11296.767     0.999963       690886     27306.67
   11296.767     0.999969       690886     32768.00
   11304.959     0.999973       690901     36408.89
   11304.959     0.999976       690901     40960.00
   11304.959     0.999979       690901     46811.43
   11304.959     0.999982       690901     54613.33
   11304.959     0.999985       690901     65536.00
   11304.959     0.999986       690901     72817.78
   11304.959     0.999988       690901     81920.00
   11304.959     0.999989       690901     93622.86
   11304.959     0.999991       690901    109226.67
   11304.959     0.999992       690901    131072.00
   11313.151     0.999993       690906    145635.56
   11313.151     1.000000       690906          inf
#[Mean    =     4208.713, StdDeviation   =     3629.498]
#[Max     =    11304.960, Total count    =       690906]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  761218 requests in 2.00m, 45.85MB read
  Non-2xx or 3xx responses: 152
Requests/sec:   6343.27
Transfer/sec:    391.20KB
```

Отступив на 20% от точки разладки (на 5.5K RPS) видим, что сервис уже справляется.
Как и в случае с PUT график latency растет сильно медленее, максимум latency сильно отличается от среднего, присутствуют скачки в latency у крайне правых перцентилей.
Значения как среднего, так и максимального latency больше, чем у PUT, график latency начиная с ~99.5 перцентиля меняется и растет быстрее. Это объясняется тем,
что для некоторых ключей нужно обойти все sstables.
По сравнению с предыдущим этапом GET потерял ~9% RPS, что не очень много.


```
wrk -d 120 -t 4 -c 64 -R 5500 -L -s ../get.lua http://localhost:19234
Running 2m test @ http://localhost:19234
  4 threads and 64 connections
  Thread calibration: mean lat.: 1.791ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.804ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.782ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 2.331ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     2.53ms    1.49ms  25.71ms   74.83%
    Req/Sec     1.45k   277.45     2.89k    74.60%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    2.30ms
 75.000%    3.30ms
 90.000%    4.31ms
 99.000%    6.89ms
 99.900%   14.49ms
 99.990%   20.83ms
 99.999%   22.70ms
100.000%   25.73ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.098     0.000000            1         1.00
       0.962     0.100000        60486         1.11
       1.313     0.200000       121019         1.25
       1.626     0.300000       181443         1.43
       1.947     0.400000       241850         1.67
       2.295     0.500000       302513         2.00
       2.479     0.550000       332838         2.22
       2.667     0.600000       362834         2.50
       2.865     0.650000       393087         2.86
       3.075     0.700000       423409         3.33
       3.301     0.750000       453481         4.00
       3.427     0.775000       468559         4.44
       3.563     0.800000       483762         5.00
       3.711     0.825000       498819         5.71
       3.877     0.850000       513903         6.67
       4.073     0.875000       529096         8.00
       4.183     0.887500       536594         8.89
       4.311     0.900000       544255        10.00
       4.447     0.912500       551688        11.43
       4.607     0.925000       559306        13.33
       4.787     0.937500       566833        16.00
       4.895     0.943750       570596        17.78
       5.019     0.950000       574413        20.00
       5.155     0.956250       578134        22.86
       5.319     0.962500       581947        26.67
       5.515     0.968750       585708        32.00
       5.627     0.971875       587548        35.56
       5.755     0.975000       589480        40.00
       5.907     0.978125       591370        45.71
       6.079     0.981250       593256        53.33
       6.295     0.984375       595112        64.00
       6.427     0.985938       596055        71.11
       6.587     0.987500       597014        80.00
       6.775     0.989062       597947        91.43
       6.991     0.990625       598886       106.67
       7.287     0.992188       599828       128.00
       7.483     0.992969       600307       142.22
       7.699     0.993750       600779       160.00
       7.959     0.994531       601249       182.86
       8.327     0.995313       601717       213.33
       8.847     0.996094       602198       256.00
       9.231     0.996484       602425       284.44
       9.815     0.996875       602666       320.00
      10.503     0.997266       602897       365.71
      11.191     0.997656       603134       426.67
      11.863     0.998047       603371       512.00
      12.263     0.998242       603489       568.89
      12.655     0.998437       603607       640.00
      13.103     0.998633       603724       731.43
      13.823     0.998828       603843       853.33
      14.583     0.999023       603961      1024.00
      14.975     0.999121       604019      1137.78
      15.399     0.999219       604079      1280.00
      15.855     0.999316       604139      1462.86
      16.351     0.999414       604196      1706.67
      16.911     0.999512       604255      2048.00
      17.247     0.999561       604285      2275.56
      17.455     0.999609       604314      2560.00
      17.887     0.999658       604344      2925.71
      18.399     0.999707       604373      3413.33
      18.735     0.999756       604403      4096.00
      18.879     0.999780       604419      4551.11
      19.151     0.999805       604432      5120.00
      19.471     0.999829       604447      5851.43
      19.871     0.999854       604462      6826.67
      20.495     0.999878       604477      8192.00
      20.751     0.999890       604484      9102.22
      20.847     0.999902       604491     10240.00
      21.087     0.999915       604499     11702.86
      21.327     0.999927       604507     13653.33
      21.455     0.999939       604514     16384.00
      21.615     0.999945       604517     18204.44
      21.727     0.999951       604521     20480.00
      21.951     0.999957       604525     23405.71
      22.031     0.999963       604529     27306.67
      22.127     0.999969       604532     32768.00
      22.223     0.999973       604535     36408.89
      22.319     0.999976       604536     40960.00
      22.415     0.999979       604538     46811.43
      22.495     0.999982       604539     54613.33
      22.607     0.999985       604541     65536.00
      22.639     0.999986       604542     72817.78
      22.655     0.999988       604543     81920.00
      22.703     0.999989       604544     93622.86
      22.719     0.999991       604545    109226.67
      22.767     0.999992       604546    131072.00
      22.767     0.999993       604546    145635.56
      22.879     0.999994       604547    163840.00
      22.879     0.999995       604547    187245.71
      22.895     0.999995       604548    218453.33
      22.895     0.999996       604548    262144.00
      22.895     0.999997       604548    291271.11
      23.519     0.999997       604549    327680.00
      23.519     0.999997       604549    374491.43
      23.519     0.999998       604549    436906.67
      23.519     0.999998       604549    524288.00
      23.519     0.999998       604549    582542.22
      25.727     0.999998       604550    655360.00
      25.727     1.000000       604550          inf
#[Mean    =        2.531, StdDeviation   =        1.488]
#[Max     =       25.712, Total count    =       604550]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  658491 requests in 2.00m, 39.66MB read
  Non-2xx or 3xx responses: 274
Requests/sec:   5487.15
Transfer/sec:    338.40KB
```

# Профилирование

С приходом HTTP Client профиль существенно изменился.

## CPU

### PUT

1. ~74% сэмплов - сетевое взаимодействие между нодами, из которых ~15% сэмплов - это наш воркер, который блокируется пока не получит ответ от ноды,
остальные сэмплы из-за того, что на самом деле это реализовано асинхронно
2. ~9% сэмплов - воркер пишет ответ в сеть 
3. ~3% сэмплов - селекторы читают из сокета, процессят данные и кладут в очередь воркеров
4. ~1% сэмплов - работа по вставке в memtable

Можно разгрузить воркеров (те 15% сэмплов), перейдя на асинхронное
взаимодействие между нодами, это будет в следующем этапе

Скачки в latency можно объяснить работой GC, его видно на профиле.

На профиле видно белые квадратики раз в 6 секунд, в каждом из них есть вызов malloc_consolidate (в исходниках libc написано "malloc_consolidate is a specialized version of free() that tears
down chunks held in fastbins."), видимо это JVM отчищает память.

### GET

1. ~53% сэмплов - сетевое взаимодействие между нодами, из которых ~10% сэмплов - это наш воркер, который блокируется пока не получит ответ от ноды,
   остальные сэмплы из-за того, что на самом деле это реализовано асинхронно
2. ~25% сэмплов - воркер ищет данные по своим sstables
3. ~8% сэмплов - воркер пишет ответ в сеть
4. ~4% сэмплов - селекторы читают из сокета, процессят данные и кладут в очередь воркеров

Как и в случае с PUT:

Можно разгрузить воркеров (те 10% сэмплов), перейдя на асинхронное
взаимодействие между нодами, это будет в следующем этапе

Скачки в latency также можно объяснить работой GC, его видно на профиле.

На профиле видно белые квадратики раз в 6 секунд, в каждом из них есть вызов malloc_consolidate (в исходниках libc написано "malloc_consolidate is a specialized version of free() that tears
down chunks held in fastbins."), видимо это JVM отчищает память.

## ALLOC

### PUT

1. ~55% сэмплов - аллокации селектора при приема запроса и вставки в очередь
2. ~41% сэмплов - аллокации от HTTP Client

По сравнению с прошлым этапом стало гораздо меньше сэмплов аллокаций во время вставки записи в memtable, это объясняется тем, что
у нас упал RPS + эти аллокации теперь размазаны по разным нодам

### GET

1. ~67% сэмплов - аллокации от HTTP Client
2. ~16% сэмплов - аллокации во время поиска по sstable
3. ~10% сэмплов - аллокации селектора при приема запроса и вставки в очередь

Также как и у PUT по сравнению с прошлым этапом стало меньше сэмплов аллокаций во время работы с DAO ноды (поиск по sstable),
это объясняется тем, что у нас упал немного RPS + эти аллокации теперь размазаны по разным нодам

HTTP Client оказался очень аллоцирующей штукой.

## LOCK

Как в PUT, так и в GET:

1. ~52% сэмплов - лок на SelectorManager, когда происходит регистрация события, которого селектор ждет
2. ~30% сэмплов - лок на SelectorManager, когда в цикле обрабатывает зарегистрированные события
3. ~10% сэмплов - лок флажка прерывания в реализации Selector, когда происходит сброс флажка прерывания

Почти весь lock contention связан с селекторами HTTP Client, а именно с регистрацией событий в селектор.
Так как нам известны все узлы кластера, и известно что мы отправляем, и как мы обрабатываем ответ, преполагаю,
что можно в начале зарегистрировать все события, которые нам нужны и избавиться от такого lock contention.