# Отчет по Stage 1
### Победоносцев Кирилл

Была взята референсная реализация с прошлого семестра
Начал профилировать с put запросов

```
request = function()
    key = math.random(0, 100000000)
    path = "/v0/entity?id=k" .. key
    body = "v" .. key
    return wrk.format("PUT", path, nil, body)
end
```

После нескольких запусков выяснилось, что база неплохо справляется в один поток с рейтом в 17К

`wrk2 -c 1 -d 1m -t 1 -R 17000 -L -s lua/put.lua "http://localhost:19234"`

```
Running 1m test @ http://localhost:19234
  1 threads and 1 connections
  Thread calibration: mean lat.: 0.818ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency   769.79us  670.37us   8.02ms   92.86%
    Req/Sec    17.94k     1.41k   20.67k    55.62%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%  695.00us
 75.000%    1.00ms
 90.000%    1.19ms
 99.000%    3.86ms
 99.900%    7.11ms
 99.990%    7.82ms
 99.999%    8.01ms
100.000%    8.03ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.048     0.000000            2         1.00
       0.194     0.100000        85334         1.11
       0.321     0.200000       170618         1.25
       0.448     0.300000       255302         1.43
       0.573     0.400000       340617         1.67
       0.695     0.500000       425404         2.00
       0.756     0.550000       468032         2.22
       0.817     0.600000       510264         2.50
       0.879     0.650000       552663         2.86
       0.941     0.700000       595019         3.33
       1.004     0.750000       637882         4.00
       1.035     0.775000       658934         4.44
       1.066     0.800000       680061         5.00
       1.097     0.825000       701282         5.71
       1.128     0.850000       722599         6.67
       1.159     0.875000       744046         8.00
       1.175     0.887500       754947         8.89
       1.190     0.900000       764973        10.00
       1.207     0.912500       775811        11.43
       1.225     0.925000       786640        13.33
       1.251     0.937500       797057        16.00
       1.275     0.943750       802182        17.78
       1.318     0.950000       807495        20.00
       1.403     0.956250       812743        22.86
       1.559     0.962500       818043        26.67
       1.815     0.968750       823350        32.00
       2.027     0.971875       826006        35.56
       2.285     0.975000       828673        40.00
       2.557     0.978125       831322        45.71
       2.845     0.981250       833978        53.33
       3.193     0.984375       836639        64.00
       3.357     0.985938       837974        71.11
       3.515     0.987500       839301        80.00
       3.713     0.989062       840614        91.43
       3.953     0.990625       841943       106.67
       4.555     0.992188       843278       128.00
       4.815     0.992969       843933       142.22
       5.035     0.993750       844606       160.00
       5.231     0.994531       845271       182.86
       5.435     0.995313       845925       213.33
       5.611     0.996094       846592       256.00
       5.671     0.996484       846922       284.44
       5.771     0.996875       847261       320.00
       5.883     0.997266       847593       365.71
       6.055     0.997656       847918       426.67
       6.263     0.998047       848252       512.00
       6.363     0.998242       848416       568.89
       6.483     0.998437       848582       640.00
       6.687     0.998633       848746       731.43
       6.879     0.998828       848913       853.33
       7.147     0.999023       849079      1024.00
       7.251     0.999121       849165      1137.78
       7.331     0.999219       849244      1280.00
       7.423     0.999316       849330      1462.86
       7.475     0.999414       849410      1706.67
       7.547     0.999512       849494      2048.00
       7.595     0.999561       849534      2275.56
       7.635     0.999609       849578      2560.00
       7.671     0.999658       849618      2925.71
       7.707     0.999707       849665      3413.33
       7.723     0.999756       849707      4096.00
       7.727     0.999780       849721      4551.11
       7.743     0.999805       849745      5120.00
       7.755     0.999829       849766      5851.43
       7.771     0.999854       849785      6826.67
       7.803     0.999878       849806      8192.00
       7.815     0.999890       849815      9102.22
       7.831     0.999902       849827     10240.00
       7.847     0.999915       849836     11702.86
       7.867     0.999927       849846     13653.33
       7.891     0.999939       849856     16384.00
       7.915     0.999945       849864     18204.44
       7.927     0.999951       849867     20480.00
       7.943     0.999957       849872     23405.71
       7.963     0.999963       849877     27306.67
       7.983     0.999969       849882     32768.00
       7.987     0.999973       849884     36408.89
       7.991     0.999976       849888     40960.00
       7.995     0.999979       849890     46811.43
       7.999     0.999982       849892     54613.33
       8.003     0.999985       849896     65536.00
       8.003     0.999986       849896     72817.78
       8.007     0.999988       849898     81920.00
       8.007     0.999989       849898     93622.86
       8.011     0.999991       849900    109226.67
       8.015     0.999992       849903    131072.00
       8.015     0.999993       849903    145635.56
       8.015     0.999994       849903    163840.00
       8.015     0.999995       849903    187245.71
       8.019     0.999995       849904    218453.33
       8.019     0.999996       849904    262144.00
       8.023     0.999997       849905    291271.11
       8.023     0.999997       849905    327680.00
       8.023     0.999997       849905    374491.43
       8.027     0.999998       849907    436906.67
       8.027     1.000000       849907          inf
#[Mean    =        0.770, StdDeviation   =        0.670]
#[Max     =        8.024, Total count    =       849907]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  1019979 requests in 1.00m, 65.17MB read
Requests/sec:  16999.73
Transfer/sec:      1.09MB
```

Но при рейте в 17,5К лэтенси резко возрастает. Причем рост начинается с 90 перцентиля
А с 99 перцентиля лэтенси возрастает почти в 17 раз

`wrk2 -c 1 -d 1m -t 1 -R 17500 -L -s lua/put.lua "http://localhost:19234"`

```
Running 1m test @ http://localhost:19234
  1 threads and 1 connections
  Thread calibration: mean lat.: 0.931ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     7.89ms   23.02ms 126.85ms   91.58%
    Req/Sec    18.46k     1.37k   20.67k    59.20%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%  832.00us
 75.000%    1.19ms
 90.000%   13.95ms
 99.000%  117.82ms
 99.900%  126.14ms
 99.990%  126.65ms
 99.999%  126.91ms
100.000%  126.91ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.048     0.000000            4         1.00
       0.231     0.100000        87534         1.11
       0.386     0.200000       175160         1.25
       0.536     0.300000       262659         1.43
       0.685     0.400000       350370         1.67
       0.832     0.500000       437731         2.00
       0.904     0.550000       481744         2.22
       0.974     0.600000       525285         2.50
       1.044     0.650000       568975         2.86
       1.117     0.700000       612628         3.33
       1.191     0.750000       656412         4.00
       1.233     0.775000       678438         4.44
       1.343     0.800000       699986         5.00
       1.844     0.825000       721839         5.71
       3.311     0.850000       743697         6.67
       5.971     0.875000       765584         8.00
       8.567     0.887500       776510         8.89
      13.951     0.900000       787456        10.00
      27.087     0.912500       798378        11.43
      41.471     0.925000       809326        13.33
      54.527     0.937500       820259        16.00
      60.383     0.943750       825748        17.78
      67.903     0.950000       831228        20.00
      75.967     0.956250       836673        22.86
      83.455     0.962500       842150        26.67
      88.895     0.968750       847630        32.00
      93.055     0.971875       850343        35.56
      97.279     0.975000       853060        40.00
     100.799     0.978125       855851        45.71
     104.895     0.981250       858575        53.33
     108.927     0.984375       861282        64.00
     111.487     0.985938       862663        71.11
     113.855     0.987500       864022        80.00
     116.735     0.989062       865367        91.43
     118.271     0.990625       866731       106.67
     119.551     0.992188       868127       128.00
     120.895     0.992969       868780       142.22
     121.855     0.993750       869527       160.00
     122.367     0.994531       870182       182.86
     123.327     0.995313       870897       213.33
     124.287     0.996094       871600       256.00
     124.735     0.996484       871876       284.44
     125.311     0.996875       872213       320.00
     125.503     0.997266       872558       365.71
     125.695     0.997656       873036       426.67
     125.823     0.998047       873264       512.00
     125.887     0.998242       873436       568.89
     125.951     0.998437       873618       640.00
     126.015     0.998633       873764       731.43
     126.079     0.998828       873921       853.33
     126.143     0.999023       874172      1024.00
     126.143     0.999121       874172      1137.78
     126.207     0.999219       874395      1280.00
     126.207     0.999316       874395      1462.86
     126.271     0.999414       874553      1706.67
     126.271     0.999512       874553      2048.00
     126.271     0.999561       874553      2275.56
     126.335     0.999609       874618      2560.00
     126.399     0.999658       874664      2925.71
     126.463     0.999707       874737      3413.33
     126.463     0.999756       874737      4096.00
     126.463     0.999780       874737      4551.11
     126.527     0.999805       874770      5120.00
     126.591     0.999829       874800      5851.43
     126.655     0.999854       874842      6826.67
     126.655     0.999878       874842      8192.00
     126.655     0.999890       874842      9102.22
     126.719     0.999902       874860     10240.00
     126.719     0.999915       874860     11702.86
     126.783     0.999927       874884     13653.33
     126.783     0.999939       874884     16384.00
     126.783     0.999945       874884     18204.44
     126.847     0.999951       874914     20480.00
     126.847     0.999957       874914     23405.71
     126.847     0.999963       874914     27306.67
     126.847     0.999969       874914     32768.00
     126.847     0.999973       874914     36408.89
     126.847     0.999976       874914     40960.00
     126.847     0.999979       874914     46811.43
     126.847     0.999982       874914     54613.33
     126.911     0.999985       874929     65536.00
     126.911     1.000000       874929          inf
#[Mean    =        7.894, StdDeviation   =       23.019]
#[Max     =      126.848, Total count    =       874929]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  1049987 requests in 1.00m, 67.09MB read
Requests/sec:  17499.85
Transfer/sec:      1.12MB
```

### GET

Все замеры проводились на заполненной базе, таблички по ~1mb, суммарно данные занимают чуть больше 4Gb
```
request = function()
    key = math.random(1, 100000000)
    path = "/v0/entity?id=k" .. key
    return wrk.format("GET", path)
end
```

Погоняв wrk понял, что даже при 200 рейта база показывает ужаснейшие результаты

`wrk2 -c 1 -d 1m -t 1 -R 200 -L -s lua/get.lua "http://localhost:19234"`

```
Running 1m test @ http://localhost:19234
  1 threads and 1 connections
  Thread calibration: mean lat.: 137.572ms, rate sampling interval: 494ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency   172.70ms  111.38ms 445.95ms   59.22%
    Req/Sec   200.59     23.70   271.00     71.29%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%  162.18ms
 75.000%  253.95ms
 90.000%  338.17ms
 99.000%  414.46ms
 99.900%  433.15ms
 99.990%  442.37ms
 99.999%  446.21ms
100.000%  446.21ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.435     0.000000            1         1.00
      27.135     0.100000         1005         1.11
      55.199     0.200000         2010         1.25
      98.815     0.300000         3013         1.43
     136.191     0.400000         4017         1.67
     162.175     0.500000         5027         2.00
     175.999     0.550000         5524         2.22
     192.511     0.600000         6026         2.50
     211.967     0.650000         6528         2.86
     235.647     0.700000         7031         3.33
     253.951     0.750000         7534         4.00
     263.935     0.775000         7783         4.44
     279.551     0.800000         8035         5.00
     296.447     0.825000         8287         5.71
     309.759     0.850000         8536         6.67
     324.863     0.875000         8787         8.00
     331.519     0.887500         8914         8.89
     338.175     0.900000         9041        10.00
     344.319     0.912500         9165        11.43
     349.439     0.925000         9291        13.33
     355.327     0.937500         9421        16.00
     358.399     0.943750         9480        17.78
     362.751     0.950000         9541        20.00
     369.663     0.956250         9606        22.86
     377.599     0.962500         9666        26.67
     387.583     0.968750         9729        32.00
     391.679     0.971875         9764        35.56
     395.007     0.975000         9793        40.00
     398.847     0.978125         9825        45.71
     402.431     0.981250         9854        53.33
     407.807     0.984375         9886        64.00
     410.111     0.985938         9902        71.11
     411.647     0.987500         9917        80.00
     413.951     0.989062         9934        91.43
     414.975     0.990625         9948       106.67
     417.279     0.992188         9967       128.00
     417.535     0.992969         9972       142.22
     419.839     0.993750         9983       160.00
     421.375     0.994531         9989       182.86
     422.143     0.995313         9995       213.33
     423.935     0.996094        10003       256.00
     424.703     0.996484        10008       284.44
     425.727     0.996875        10011       320.00
     427.263     0.997266        10015       365.71
     428.287     0.997656        10019       426.67
     429.823     0.998047        10023       512.00
     431.359     0.998242        10026       568.89
     431.871     0.998437        10028       640.00
     432.383     0.998633        10030       731.43
     432.895     0.998828        10031       853.33
     434.431     0.999023        10033      1024.00
     435.967     0.999121        10034      1137.78
     436.223     0.999219        10035      1280.00
     436.479     0.999316        10036      1462.86
     436.991     0.999414        10037      1706.67
     437.503     0.999512        10038      2048.00
     437.503     0.999561        10038      2275.56
     440.575     0.999609        10039      2560.00
     440.575     0.999658        10039      2925.71
     441.343     0.999707        10040      3413.33
     441.343     0.999756        10040      4096.00
     441.343     0.999780        10040      4551.11
     442.367     0.999805        10041      5120.00
     442.367     0.999829        10041      5851.43
     442.367     0.999854        10041      6826.67
     442.367     0.999878        10041      8192.00
     442.367     0.999890        10041      9102.22
     446.207     0.999902        10042     10240.00
     446.207     1.000000        10042          inf
#[Mean    =      172.700, StdDeviation   =      111.377]
#[Max     =      445.952, Total count    =        10042]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  11989 requests in 1.00m, 829.88KB read
Requests/sec:    199.81
Transfer/sec:     13.83KB
```

Как видим средняя latency около 172ms. Немного по профилировав пришел к выводу, что основное время приходится на 
`MemorySegment.getLongAtOffset`. По сути мы были вынуждены просматривать в среднем половину файлов бинарным поиском. 
А по скольку размер моих табличек был всего 1mb, всего их вышло около 4000. Просматривать все чрезвычайно долго.
Первое улучшение, которое пришло мне в голову - это сделать оптимизацию. Вместо того чтобы проверять каждый файл.
Сначала я проверяю первый ключ и последний, если искомый ключ меньше первого или больше последнего, то очевидно, что
в данном файле искомый ключ отсутствует, т.к. внутри файла ключи отсортированы.

В конечном итоге это действительно дало неплохой прирост производительности.

`wrk2 -c 1 -d 1m -t 1 -R 1100 -L -s lua/get.lua "http://localhost:19234"`

```
Running 1m test @ http://localhost:19234
  1 threads and 1 connections
  Thread calibration: mean lat.: 1.860ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.79ms    0.89ms   6.74ms   69.00%
    Req/Sec     1.16k   144.27     1.78k    64.38%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.69ms
 75.000%    2.34ms
 90.000%    2.98ms
 99.000%    4.28ms
 99.900%    5.29ms
 99.990%    6.11ms
 99.999%    6.60ms
100.000%    6.75ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.130     0.000000            1         1.00
       0.738     0.100000         5507         1.11
       1.026     0.200000        11018         1.25
       1.259     0.300000        16519         1.43
       1.465     0.400000        22005         1.67
       1.686     0.500000        27515         2.00
       1.804     0.550000        30252         2.22
       1.925     0.600000        33009         2.50
       2.049     0.650000        35790         2.86
       2.185     0.700000        38498         3.33
       2.337     0.750000        41276         4.00
       2.419     0.775000        42643         4.44
       2.507     0.800000        44024         5.00
       2.607     0.825000        45396         5.71
       2.715     0.850000        46746         6.67
       2.841     0.875000        48142         8.00
       2.905     0.887500        48811         8.89
       2.985     0.900000        49509        10.00
       3.069     0.912500        50188        11.43
       3.163     0.925000        50872        13.33
       3.279     0.937500        51562        16.00
       3.343     0.943750        51908        17.78
       3.411     0.950000        52253        20.00
       3.489     0.956250        52596        22.86
       3.583     0.962500        52940        26.67
       3.677     0.968750        53279        32.00
       3.729     0.971875        53449        35.56
       3.797     0.975000        53622        40.00
       3.867     0.978125        53798        45.71
       3.955     0.981250        53964        53.33
       4.053     0.984375        54136        64.00
       4.107     0.985938        54222        71.11
       4.167     0.987500        54312        80.00
       4.235     0.989062        54394        91.43
       4.303     0.990625        54481       106.67
       4.383     0.992188        54568       128.00
       4.435     0.992969        54612       142.22
       4.483     0.993750        54652       160.00
       4.547     0.994531        54699       182.86
       4.611     0.995313        54742       213.33
       4.699     0.996094        54781       256.00
       4.751     0.996484        54803       284.44
       4.799     0.996875        54824       320.00
       4.863     0.997266        54846       365.71
       4.931     0.997656        54867       426.67
       5.027     0.998047        54888       512.00
       5.067     0.998242        54899       568.89
       5.123     0.998437        54910       640.00
       5.175     0.998633        54921       731.43
       5.235     0.998828        54931       853.33
       5.295     0.999023        54942      1024.00
       5.331     0.999121        54947      1137.78
       5.415     0.999219        54953      1280.00
       5.451     0.999316        54961      1462.86
       5.463     0.999414        54963      1706.67
       5.535     0.999512        54969      2048.00
       5.543     0.999561        54971      2275.56
       5.623     0.999609        54974      2560.00
       5.647     0.999658        54977      2925.71
       5.755     0.999707        54980      3413.33
       5.863     0.999756        54982      4096.00
       5.899     0.999780        54983      4551.11
       5.991     0.999805        54985      5120.00
       6.035     0.999829        54986      5851.43
       6.051     0.999854        54987      6826.67
       6.067     0.999878        54989      8192.00
       6.067     0.999890        54989      9102.22
       6.115     0.999902        54990     10240.00
       6.147     0.999915        54991     11702.86
       6.147     0.999927        54991     13653.33
       6.235     0.999939        54992     16384.00
       6.235     0.999945        54992     18204.44
       6.427     0.999951        54993     20480.00
       6.427     0.999957        54993     23405.71
       6.427     0.999963        54993     27306.67
       6.599     0.999969        54994     32768.00
       6.599     0.999973        54994     36408.89
       6.599     0.999976        54994     40960.00
       6.599     0.999979        54994     46811.43
       6.599     0.999982        54994     54613.33
       6.747     0.999985        54995     65536.00
       6.747     1.000000        54995          inf
#[Mean    =        1.794, StdDeviation   =        0.887]
#[Max     =        6.744, Total count    =        54995]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  65999 requests in 1.00m, 4.46MB read
Requests/sec:   1099.98
Transfer/sec:     76.15KB
```

Теперь даже при рейте в 1100 все еще средняя latency около 2мс. Второе улучшение которое может дать ощутимый прирост
это повышение размера sstable.

Однако, при повышении рейта хотя бы до 1200 уже начинаются проблемы.

`wrk2 -c 1 -d 1m -t 1 -R 1200 -L -s lua/get.lua "http://localhost:19234"`

```
Running 1m test @ http://localhost:19234
  1 threads and 1 connections
  Thread calibration: mean lat.: 1.893ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.90ms    1.38ms  19.82ms   87.11%
    Req/Sec     1.27k   160.30     2.00k    65.26%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.69ms
 75.000%    2.35ms
 90.000%    3.06ms
 99.000%    6.77ms
 99.900%   16.20ms
 99.990%   18.83ms
 99.999%   19.58ms
100.000%   19.84ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.126     0.000000            1         1.00
       0.739     0.100000         6013         1.11
       1.029     0.200000        12023         1.25
       1.256     0.300000        18014         1.43
       1.463     0.400000        24023         1.67
       1.691     0.500000        30006         2.00
       1.804     0.550000        33008         2.22
       1.926     0.600000        36002         2.50
       2.049     0.650000        39023         2.86
       2.187     0.700000        42016         3.33
       2.345     0.750000        45015         4.00
       2.435     0.775000        46505         4.44
       2.531     0.800000        48020         5.00
       2.639     0.825000        49499         5.71
       2.757     0.850000        50997         6.67
       2.887     0.875000        52496         8.00
       2.969     0.887500        53266         8.89
       3.061     0.900000        54006        10.00
       3.161     0.912500        54748        11.43
       3.281     0.925000        55508        13.33
       3.417     0.937500        56250        16.00
       3.495     0.943750        56620        17.78
       3.589     0.950000        56995        20.00
       3.701     0.956250        57374        22.86
       3.837     0.962500        57745        26.67
       3.991     0.968750        58122        32.00
       4.079     0.971875        58307        35.56
       4.211     0.975000        58500        40.00
       4.375     0.978125        58682        45.71
       4.595     0.981250        58873        53.33
       4.939     0.984375        59057        64.00
       5.275     0.985938        59152        71.11
       5.595     0.987500        59245        80.00
       6.243     0.989062        59338        91.43
       7.119     0.990625        59432       106.67
       8.655     0.992188        59528       128.00
       9.503     0.992969        59573       142.22
      10.135     0.993750        59620       160.00
      10.967     0.994531        59666       182.86
      11.567     0.995313        59714       213.33
      12.239     0.996094        59760       256.00
      12.775     0.996484        59784       284.44
      13.375     0.996875        59807       320.00
      13.927     0.997266        59830       365.71
      14.327     0.997656        59855       426.67
      14.831     0.998047        59877       512.00
      15.103     0.998242        59889       568.89
      15.375     0.998437        59901       640.00
      15.599     0.998633        59912       731.43
      15.951     0.998828        59924       853.33
      16.231     0.999023        59937      1024.00
      16.447     0.999121        59942      1137.78
      16.591     0.999219        59948      1280.00
      16.815     0.999316        59953      1462.86
      17.039     0.999414        59959      1706.67
      17.327     0.999512        59965      2048.00
      17.407     0.999561        59968      2275.56
      17.599     0.999609        59971      2560.00
      17.935     0.999658        59976      2925.71
      17.951     0.999707        59977      3413.33
      18.111     0.999756        59980      4096.00
      18.239     0.999780        59981      4551.11
      18.575     0.999805        59983      5120.00
      18.607     0.999829        59985      5851.43
      18.703     0.999854        59986      6826.67
      18.751     0.999878        59987      8192.00
      18.831     0.999890        59989      9102.22
      18.831     0.999902        59989     10240.00
      18.831     0.999915        59989     11702.86
      18.991     0.999927        59990     13653.33
      19.103     0.999939        59991     16384.00
      19.103     0.999945        59991     18204.44
      19.231     0.999951        59992     20480.00
      19.231     0.999957        59992     23405.71
      19.231     0.999963        59992     27306.67
      19.583     0.999969        59993     32768.00
      19.583     0.999973        59993     36408.89
      19.583     0.999976        59993     40960.00
      19.583     0.999979        59993     46811.43
      19.583     0.999982        59993     54613.33
      19.839     0.999985        59994     65536.00
      19.839     1.000000        59994          inf
#[Mean    =        1.896, StdDeviation   =        1.377]
#[Max     =       19.824, Total count    =        59994]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  71998 requests in 1.00m, 4.87MB read
Requests/sec:   1199.97
Transfer/sec:     83.07KB
```

## Результаты профилирования
### GET
[Server Get CPU](html/stage1/server-get-cpu.html)

[Server get alloc](html/stage1/server-get-alloc.html)
### PUT
[Server Put CPU](html/stage1/server-put-cpu.html)

[Server Put alloc](html/stage1/server-put-alloc.html)

## Анализ
### PUT
Анализируя результаты профилирования можно заметить, что на самом деле дао аллоцирует не так много в процессе вставки.
Основные аллокации производит сам one-nio.

По CPU видно что много времени приходится на запись Response в сокет, на чтение из сокета, а также на select. На
непосредственно upsert приходится 8,5% сэмплов, что логично потому что идет вставка в памяти. Хотя есть еще фоновый
поток скидывающий данные на диск который тоже забирает 17,5%. Тем не менее все равно это намного меньше по сравнению
с работами с сокетом. Предположу, что это ограничение сервера для одного потока.
## GET
Зато в гете сразу видно, что практически все аллокации приходятся на методы `checkRange` и `entryIndex`. `checkRange`
это тот метод проверяющий крайние ключи в файлах, чтобы пропустить ненужные. `entryIndex` бинарный поиск по файлу.

С CPU все обстоит похожим образом. Однако в отличие от put заметно насколько работа с сокетами занимает меньшее CPU.
На сам же метод гет приходится 71,5% сэмплов. Как я уже говорил еще один возможный способ оптимизации в этом случае -
увеличение размера табличек.
