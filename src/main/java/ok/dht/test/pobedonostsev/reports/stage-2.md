# Stage 2

Выполненная вторая работа профилировалась при -t=4 и -c=64. Lua скрипты использовались те же.

## GET

Первое, что выяснилось, что теперь наша база может обрабатывать больше гетов чем было раньше. Теперь при rps 2000, все
работает относительно стабильно.

Теперь нужно было подобрать хорошее соотношение количества потоков в тред пуле и размера очереди.

В моем случае это отношение оказалось 64/256. При таком соотношении достигалась вменяемая latency и
отсутствие таймаутов.

`wrk2 -c 64 -d 60s -t 4 -R 2000 -L -s lua/get.lua "http://localhost:19234"`

```
Running 1m test @ http://localhost:19234
4 threads and 64 connections
Thread calibration: mean lat.: 409.345ms, rate sampling interval: 2592ms
Thread calibration: mean lat.: 443.381ms, rate sampling interval: 2807ms
Thread calibration: mean lat.: 426.664ms, rate sampling interval: 2746ms
Thread calibration: mean lat.: 443.838ms, rate sampling interval: 2799ms
Thread Stats   Avg      Stdev     Max   +/- Stdev
Latency     3.17ms    2.26ms  18.34ms   64.01%
Req/Sec   499.65      0.65   501.00    100.00%
Latency Distribution (HdrHistogram - Recorded Latency)
50.000%    2.97ms
75.000%    5.03ms
90.000%    5.96ms
99.000%    8.68ms
99.900%   11.71ms
99.990%   15.53ms
99.999%   17.39ms
100.000%   18.35ms

Detailed Percentile spectrum:
Value   Percentile   TotalCount 1/(1-Percentile)

       0.159     0.000000            1         1.00
       0.655     0.100000         9985         1.11
       0.941     0.200000        19972         1.25
       1.207     0.300000        29981         1.43
       1.513     0.400000        39939         1.67
       2.975     0.500000        49919         2.00
       3.933     0.550000        54925         2.22
       4.291     0.600000        59939         2.50
       4.555     0.650000        64980         2.86
       4.791     0.700000        69972         3.33
       5.027     0.750000        74909         4.00
       5.151     0.775000        77440         4.44
       5.279     0.800000        79930         5.00
       5.415     0.825000        82391         5.71
       5.571     0.850000        84908         6.67
       5.751     0.875000        87385         8.00
       5.847     0.887500        88626         8.89
       5.959     0.900000        89866        10.00
       6.095     0.912500        91125        11.43
       6.239     0.925000        92361        13.33
       6.427     0.937500        93618        16.00
       6.535     0.943750        94223        17.78
       6.675     0.950000        94861        20.00
       6.835     0.956250        95474        22.86
       7.027     0.962500        96097        26.67
       7.263     0.968750        96733        32.00
       7.391     0.971875        97038        35.56
       7.535     0.975000        97350        40.00
       7.715     0.978125        97660        45.71
       7.915     0.981250        97971        53.33
       8.111     0.984375        98282        64.00
       8.255     0.985938        98442        71.11
       8.415     0.987500        98597        80.00
       8.575     0.989062        98748        91.43
       8.743     0.990625        98905       106.67
       8.927     0.992188        99059       128.00
       9.047     0.992969        99137       142.22
       9.175     0.993750        99218       160.00
       9.375     0.994531        99299       182.86
       9.543     0.995313        99371       213.33
       9.751     0.996094        99455       256.00
       9.839     0.996484        99488       284.44
      10.015     0.996875        99530       320.00
      10.183     0.997266        99566       365.71
      10.399     0.997656        99605       426.67
      10.623     0.998047        99644       512.00
      10.743     0.998242        99664       568.89
      10.991     0.998437        99685       640.00
      11.175     0.998633        99703       731.43
      11.447     0.998828        99722       853.33
      11.727     0.999023        99741      1024.00
      11.919     0.999121        99751      1137.78
      12.191     0.999219        99762      1280.00
      12.303     0.999316        99770      1462.86
      12.631     0.999414        99780      1706.67
      12.791     0.999512        99790      2048.00
      12.943     0.999561        99795      2275.56
      13.119     0.999609        99800      2560.00
      13.343     0.999658        99804      2925.71
      13.543     0.999707        99809      3413.33
      13.799     0.999756        99814      4096.00
      14.071     0.999780        99817      4551.11
      14.151     0.999805        99819      5120.00
      14.751     0.999829        99821      5851.43
      15.255     0.999854        99824      6826.67
      15.423     0.999878        99826      8192.00
      15.535     0.999890        99828      9102.22
      15.639     0.999902        99830     10240.00
      15.639     0.999915        99830     11702.86
      15.703     0.999927        99831     13653.33
      15.751     0.999939        99832     16384.00
      15.903     0.999945        99833     18204.44
      16.831     0.999951        99834     20480.00
      16.831     0.999957        99834     23405.71
      16.943     0.999963        99835     27306.67
      16.943     0.999969        99835     32768.00
      17.311     0.999973        99836     36408.89
      17.311     0.999976        99836     40960.00
      17.311     0.999979        99836     46811.43
      17.391     0.999982        99837     54613.33
      17.391     0.999985        99837     65536.00
      17.391     0.999986        99837     72817.78
      17.391     0.999988        99837     81920.00
      17.391     0.999989        99837     93622.86
      18.351     0.999991        99838    109226.67
      18.351     1.000000        99838          inf
#[Mean    =        3.171, StdDeviation   =        2.260]
#[Max     =       18.336, Total count    =        99838]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
119954 requests in 1.00m, 8.11MB read
Requests/sec:   1999.05
Transfer/sec:    138.38KB
```

При дальнейшем увеличении размера очереди, например до 1024 максимальная latency растет.

```
Running 1m test @ http://localhost:19234
  4 threads and 64 connections
  Thread calibration: mean lat.: 183.913ms, rate sampling interval: 1620ms
  Thread calibration: mean lat.: 163.261ms, rate sampling interval: 1462ms
  Thread calibration: mean lat.: 170.069ms, rate sampling interval: 1547ms
  Thread calibration: mean lat.: 173.366ms, rate sampling interval: 1556ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     3.52ms    2.61ms  26.03ms   67.73%
    Req/Sec   499.73      1.12   502.00     90.62%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    3.67ms
 75.000%    5.39ms
 90.000%    6.69ms
 99.000%   10.49ms
 99.900%   15.30ms
 99.990%   20.67ms
 99.999%   25.09ms
100.000%   26.05ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.154     0.000000            1         1.00
       0.671     0.100000        10003         1.11
       0.974     0.200000        19973         1.25
       1.257     0.300000        29962         1.43
       1.630     0.400000        39951         1.67
       3.675     0.500000        49927         2.00
       4.267     0.550000        54954         2.22
       4.599     0.600000        59957         2.50
       4.867     0.650000        64954         2.86
       5.127     0.700000        69938         3.33
       5.395     0.750000        74935         4.00
       5.535     0.775000        77416         4.44
       5.691     0.800000        79901         5.00
       5.871     0.825000        82384         5.71
       6.087     0.850000        84891         6.67
       6.343     0.875000        87389         8.00
       6.507     0.887500        88629         8.89
       6.691     0.900000        89861        10.00
       6.911     0.912500        91111        11.43
       7.179     0.925000        92354        13.33
       7.483     0.937500        93601        16.00
       7.659     0.943750        94229        17.78
       7.863     0.950000        94849        20.00
       8.079     0.956250        95472        22.86
       8.319     0.962500        96098        26.67
       8.623     0.968750        96727        32.00
       8.783     0.971875        97039        35.56
       8.967     0.975000        97351        40.00
       9.183     0.978125        97659        45.71
       9.431     0.981250        97968        53.33
       9.711     0.984375        98280        64.00
       9.895     0.985938        98440        71.11
      10.111     0.987500        98592        80.00
      10.343     0.989062        98754        91.43
      10.599     0.990625        98904       106.67
      10.879     0.992188        99067       128.00
      11.079     0.992969        99139       142.22
      11.359     0.993750        99219       160.00
      11.663     0.994531        99294       182.86
      11.951     0.995313        99372       213.33
      12.383     0.996094        99450       256.00
      12.575     0.996484        99490       284.44
      12.807     0.996875        99530       320.00
      13.159     0.997266        99567       365.71
      13.607     0.997656        99606       426.67
      13.999     0.998047        99645       512.00
      14.231     0.998242        99665       568.89
      14.471     0.998437        99684       640.00
      14.775     0.998633        99704       731.43
      15.063     0.998828        99723       853.33
      15.511     0.999023        99743      1024.00
      15.927     0.999121        99753      1137.78
      16.175     0.999219        99762      1280.00
      16.559     0.999316        99772      1462.86
      16.831     0.999414        99782      1706.67
      17.199     0.999512        99792      2048.00
      17.567     0.999561        99797      2275.56
      17.855     0.999609        99801      2560.00
      18.175     0.999658        99806      2925.71
      18.447     0.999707        99811      3413.33
      18.719     0.999756        99816      4096.00
      18.879     0.999780        99819      4551.11
      19.263     0.999805        99821      5120.00
      19.295     0.999829        99823      5851.43
      19.407     0.999854        99826      6826.67
      19.807     0.999878        99828      8192.00
      20.671     0.999890        99830      9102.22
      20.735     0.999902        99831     10240.00
      21.663     0.999915        99832     11702.86
      21.999     0.999927        99833     13653.33
      22.111     0.999939        99834     16384.00
      22.207     0.999945        99835     18204.44
      22.303     0.999951        99836     20480.00
      22.303     0.999957        99836     23405.71
      22.719     0.999963        99837     27306.67
      22.719     0.999969        99837     32768.00
      24.895     0.999973        99838     36408.89
      24.895     0.999976        99838     40960.00
      24.895     0.999979        99838     46811.43
      25.087     0.999982        99839     54613.33
      25.087     0.999985        99839     65536.00
      25.087     0.999986        99839     72817.78
      25.087     0.999988        99839     81920.00
      25.087     0.999989        99839     93622.86
      26.047     0.999991        99840    109226.67
      26.047     1.000000        99840          inf
#[Mean    =        3.521, StdDeviation   =        2.612]
#[Max     =       26.032, Total count    =        99840]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  119950 requests in 1.00m, 8.11MB read
Requests/sec:   1998.99
Transfer/sec:    138.38KB
```

При увеличении количества потоков в пуле - аналогично

```
Running 1m test @ http://localhost:19234
  4 threads and 64 connections
  Thread calibration: mean lat.: 157.683ms, rate sampling interval: 1330ms
  Thread calibration: mean lat.: 30.410ms, rate sampling interval: 209ms
  Thread calibration: mean lat.: 175.169ms, rate sampling interval: 1541ms
  Thread calibration: mean lat.: 169.547ms, rate sampling interval: 1498ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     4.31ms    3.04ms  25.57ms   64.04%
    Req/Sec   500.46     26.46   538.00     51.47%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    4.47ms
 75.000%    6.15ms
 90.000%    8.26ms
 99.000%   12.87ms
 99.900%   17.22ms
 99.990%   20.85ms
 99.999%   25.20ms
100.000%   25.58ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.182     0.000000            1         1.00
       0.829     0.100000        10007         1.11
       1.214     0.200000        19975         1.25
       1.658     0.300000        29969         1.43
       2.975     0.400000        39943         1.67
       4.471     0.500000        49935         2.00
       4.835     0.550000        54934         2.22
       5.143     0.600000        59914         2.50
       5.455     0.650000        64919         2.86
       5.779     0.700000        69903         3.33
       6.151     0.750000        74916         4.00
       6.363     0.775000        77390         4.44
       6.607     0.800000        79883         5.00
       6.903     0.825000        82389         5.71
       7.255     0.850000        84867         6.67
       7.707     0.875000        87376         8.00
       7.963     0.887500        88620         8.89
       8.255     0.900000        89871        10.00
       8.583     0.912500        91131        11.43
       8.927     0.925000        92371        13.33
       9.295     0.937500        93613        16.00
       9.503     0.943750        94228        17.78
       9.751     0.950000        94855        20.00
       9.999     0.956250        95479        22.86
      10.287     0.962500        96110        26.67
      10.623     0.968750        96730        32.00
      10.815     0.971875        97048        35.56
      11.015     0.975000        97343        40.00
      11.255     0.978125        97656        45.71
      11.559     0.981250        97970        53.33
      11.895     0.984375        98281        64.00
      12.111     0.985938        98436        71.11
      12.359     0.987500        98595        80.00
      12.663     0.989062        98750        91.43
      12.991     0.990625        98905       106.67
      13.391     0.992188        99061       128.00
      13.591     0.992969        99137       142.22
      13.887     0.993750        99217       160.00
      14.167     0.994531        99295       182.86
      14.495     0.995313        99372       213.33
      14.855     0.996094        99451       256.00
      15.047     0.996484        99488       284.44
      15.239     0.996875        99527       320.00
      15.487     0.997266        99566       365.71
      15.767     0.997656        99605       426.67
      16.031     0.998047        99644       512.00
      16.207     0.998242        99663       568.89
      16.527     0.998437        99683       640.00
      16.719     0.998633        99702       731.43
      17.039     0.998828        99722       853.33
      17.247     0.999023        99741      1024.00
      17.391     0.999121        99752      1137.78
      17.647     0.999219        99761      1280.00
      17.935     0.999316        99770      1462.86
      18.111     0.999414        99780      1706.67
      18.447     0.999512        99791      2048.00
      18.687     0.999561        99795      2275.56
      18.879     0.999609        99800      2560.00
      19.055     0.999658        99804      2925.71
      19.295     0.999707        99809      3413.33
      19.695     0.999756        99815      4096.00
      19.839     0.999780        99817      4551.11
      19.951     0.999805        99819      5120.00
      20.223     0.999829        99821      5851.43
      20.463     0.999854        99824      6826.67
      20.543     0.999878        99826      8192.00
      20.847     0.999890        99828      9102.22
      21.199     0.999902        99829     10240.00
      21.327     0.999915        99830     11702.86
      22.063     0.999927        99831     13653.33
      22.623     0.999939        99832     16384.00
      23.599     0.999945        99833     18204.44
      23.807     0.999951        99834     20480.00
      23.807     0.999957        99834     23405.71
      23.839     0.999963        99835     27306.67
      23.839     0.999969        99835     32768.00
      24.383     0.999973        99836     36408.89
      24.383     0.999976        99836     40960.00
      24.383     0.999979        99836     46811.43
      25.199     0.999982        99837     54613.33
      25.199     0.999985        99837     65536.00
      25.199     0.999986        99837     72817.78
      25.199     0.999988        99837     81920.00
      25.199     0.999989        99837     93622.86
      25.583     0.999991        99838    109226.67
      25.583     1.000000        99838          inf
#[Mean    =        4.310, StdDeviation   =        3.040]
#[Max     =       25.568, Total count    =        99838]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  119472 requests in 1.00m, 8.08MB read
Requests/sec:   1990.71
Transfer/sec:    137.81KB
```

Если же уменьшить очередь, то появятся таймауты, так как очередь будет успевать закончится и складывать задачи будет
некуда. После этого запросы будут отброшены.

## PUT

`wrk2 -c 64 -d 1m -t 4 -R 50000 -L -s lua/put.lua "http://localhost:19234"`

```
Running 1m test @ http://localhost:19234
  4 threads and 64 connections
  Thread calibration: mean lat.: 2.113ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.994ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 2.010ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 2.077ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.87ms    1.01ms  11.67ms   82.78%
    Req/Sec    13.19k     1.04k   17.56k    72.63%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.67ms
 75.000%    2.19ms
 90.000%    2.88ms
 99.000%    6.05ms
 99.900%    8.65ms
 99.990%   10.53ms
 99.999%   11.41ms
100.000%   11.68ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.083     0.000000            1         1.00
       0.956     0.100000       249935         1.11
       1.186     0.200000       500368         1.25
       1.355     0.300000       749992         1.43
       1.512     0.400000       999913         1.67
       1.671     0.500000      1248814         2.00
       1.755     0.550000      1373241         2.22
       1.845     0.600000      1498002         2.50
       1.944     0.650000      1622808         2.86
       2.057     0.700000      1748466         3.33
       2.187     0.750000      1872059         4.00
       2.265     0.775000      1935101         4.44
       2.353     0.800000      1997837         5.00
       2.453     0.825000      2060073         5.71
       2.569     0.850000      2122339         6.67
       2.707     0.875000      2184365         8.00
       2.787     0.887500      2215477         8.89
       2.879     0.900000      2246736        10.00
       2.987     0.912500      2277761        11.43
       3.123     0.925000      2309090        13.33
       3.305     0.937500      2340036        16.00
       3.429     0.943750      2355619        17.78
       3.593     0.950000      2371267        20.00
       3.801     0.956250      2386844        22.86
       4.061     0.962500      2402410        26.67
       4.379     0.968750      2418148        32.00
       4.555     0.971875      2425956        35.56
       4.751     0.975000      2433675        40.00
       4.959     0.978125      2441516        45.71
       5.195     0.981250      2449276        53.33
       5.459     0.984375      2457040        64.00
       5.615     0.985938      2460931        71.11
       5.775     0.987500      2464857        80.00
       5.947     0.989062      2468723        91.43
       6.139     0.990625      2472621       106.67
       6.383     0.992188      2476533       128.00
       6.523     0.992969      2478480       142.22
       6.675     0.993750      2480433       160.00
       6.835     0.994531      2482350       182.86
       7.019     0.995313      2484314       213.33
       7.215     0.996094      2486257       256.00
       7.319     0.996484      2487240       284.44
       7.439     0.996875      2488207       320.00
       7.583     0.997266      2489183       365.71
       7.747     0.997656      2490161       426.67
       7.959     0.998047      2491125       512.00
       8.071     0.998242      2491623       568.89
       8.187     0.998437      2492105       640.00
       8.319     0.998633      2492592       731.43
       8.479     0.998828      2493084       853.33
       8.679     0.999023      2493573      1024.00
       8.799     0.999121      2493810      1137.78
       8.927     0.999219      2494055      1280.00
       9.063     0.999316      2494298      1462.86
       9.191     0.999414      2494544      1706.67
       9.311     0.999512      2494786      2048.00
       9.407     0.999561      2494908      2275.56
       9.527     0.999609      2495031      2560.00
       9.615     0.999658      2495150      2925.71
       9.735     0.999707      2495267      3413.33
       9.903     0.999756      2495389      4096.00
       9.999     0.999780      2495450      4551.11
      10.119     0.999805      2495515      5120.00
      10.223     0.999829      2495577      5851.43
      10.303     0.999854      2495638      6826.67
      10.407     0.999878      2495693      8192.00
      10.479     0.999890      2495727      9102.22
      10.551     0.999902      2495761     10240.00
      10.607     0.999915      2495786     11702.86
      10.655     0.999927      2495815     13653.33
      10.759     0.999939      2495845     16384.00
      10.815     0.999945      2495860     18204.44
      10.911     0.999951      2495876     20480.00
      10.991     0.999957      2495891     23405.71
      11.063     0.999963      2495906     27306.67
      11.143     0.999969      2495921     32768.00
      11.167     0.999973      2495929     36408.89
      11.207     0.999976      2495937     40960.00
      11.231     0.999979      2495944     46811.43
      11.287     0.999982      2495952     54613.33
      11.335     0.999985      2495960     65536.00
      11.359     0.999986      2495963     72817.78
      11.391     0.999988      2495969     81920.00
      11.407     0.999989      2495971     93622.86
      11.431     0.999991      2495977    109226.67
      11.447     0.999992      2495978    131072.00
      11.455     0.999993      2495982    145635.56
      11.455     0.999994      2495982    163840.00
      11.479     0.999995      2495984    187245.71
      11.487     0.999995      2495987    218453.33
      11.495     0.999996      2495988    262144.00
      11.503     0.999997      2495989    291271.11
      11.511     0.999997      2495990    327680.00
      11.551     0.999997      2495991    374491.43
      11.567     0.999998      2495992    436906.67
      11.591     0.999998      2495993    524288.00
      11.591     0.999998      2495993    582542.22
      11.655     0.999998      2495994    655360.00
      11.655     0.999999      2495994    748982.86
      11.663     0.999999      2495995    873813.33
      11.663     0.999999      2495995   1048576.00
      11.663     0.999999      2495995   1165084.44
      11.671     0.999999      2495996   1310720.00
      11.671     0.999999      2495996   1497965.71
      11.671     0.999999      2495996   1747626.67
      11.671     1.000000      2495996   2097152.00
      11.671     1.000000      2495996   2330168.89
      11.679     1.000000      2495997   2621440.00
      11.679     1.000000      2495997          inf
#[Mean    =        1.871, StdDeviation   =        1.008]
#[Max     =       11.672, Total count    =      2495997]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  2998080 requests in 1.00m, 191.57MB read
Requests/sec:  49967.59
Transfer/sec:      3.19MB
```

## Результаты профилирования
### GET
[Server Get CPU](html/stage2/get_cpu.html)

[Server Get alloc](html/stage2/get_alloc.html)

[Server Get lock](html/stage2/get_alloc.html)
### PUT
[Server Put CPU](html/stage2/put_cpu.html)

[Server Put alloc](html/stage2/put_alloc.html)

[Server Put lock](html/stage2/put_lock.html)

## Анализ
Как мы видим из результатов профилирования, нам действительно удалось разгрузить SelectorThread'ы отдав задачи по работе
с дао в отдельный пул потоков. Однако теперь у нас появилась проблема с тем, что у нас появились довольно большие
промежутки с локами, а именно когда мы помещаем задачу в очередь (71%) и забираем задачу из очереди (27,5%). Таким
образом дополнительный пул потоков принес нам довольно большие накладные расходы. В хитмапе put cpu также видно, что
также видно как теперь ArrayBlockingQueue.take взял на себя 21% cpu, что довольно не мало.
В аллокациях также появились дополнительные расходы в ArrayBlockingQueue.take

### Вывод
На мой взгляд данное действие не принесло сильного эффекта, а только принесло накладные расходы. Немного улучшившиеся
показатели по сравнению с предыдущей реализацией я могу объяснить увеличенным количеством коннекшенов и потоков при
нагрузочном тестировании. Лучше на мой взгляд попробовать еще оптимизировать непосредственно get, так как он по прежнему
занимает много времени из-за долгого поиска по файлам. Например, на мне кажется, сильно может помочь организация уровней
хранения файлов, которую мы проходили в прошлом году на lsm