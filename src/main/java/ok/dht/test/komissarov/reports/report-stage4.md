# Этап 4. Репликация

## *Нагрузочное тестирование с помощью wrk*

Для тестирования был запущен кластер из 3 узлов, скрипты для добавления/поиска записей не менялись, то есть параметры *`ack`*  и *`from`* выбираются по дефолту: `2/3` соответственно. То есть для того, чтобы подтвердить операцию необходимо `2` ответа от `3` реплик. Фактор репликации для данного кластера равен параметру *`from`*. Алгоритм распределения данных по узлам остался неизменным - `rendezvous hashing `, только теперь выбирается не один узел для которого хеш-значение наибольшее, а *`from`* наибольших хешей, что в случае данного кластера означает, что каждый узел хранит все данные.

<hr>

### *PUT-запросы*

Сравним результаты нагрузочного тестирования до и после добавления реплицирования. Команда, которая использовалась для кластера без реплицирования `wrk -t4 -c4 -d30s -R15000 --latency -s put.lua http://localhost:19234`, для кластера с реплицированием `wrk -t4 -c4 -d30s -R6000 --latency -s put.lua http://localhost:19234`. Схожие результаты были получены только после понижения рейта более, чем в два раза, что отлично иллюстрирует, как много ресурсов требуется для того, чтобы узлы общались между собой.

| Cluster size | < 2ms percentile | Latency avg |   Rate    |
| :----------: | :--------------: | :---------: | :-------: |
|   *`0 RF`*   |     *`85%`*      | *`1.57ms`*  | *`15000`* |
|   *`3 RF`*   |     *`85%`*      | *`1.71ms`*  | *`6000`*  |



Перцентили для кластера, в котором не реализовано реплицирование:

  ```
  Detailed Percentile spectrum:
         Value   Percentile   TotalCount 1/(1-Percentile)
  
         0.034     0.000000            1         1.00
         0.416     0.100000        30016         1.11
         0.621     0.200000        60044         1.25
         0.807     0.300000        90122         1.43
         0.970     0.400000       120121         1.67
         1.113     0.500000       149980         2.00
         1.193     0.550000       165064         2.22
         1.284     0.600000       180001         2.50
         1.396     0.650000       194974         2.86
         1.529     0.700000       210040         3.33
         1.677     0.750000       224939         4.00
         1.760     0.775000       232506         4.44
         1.846     0.800000       239970         5.00
         1.943     0.825000       247466         5.71
         2.079     0.850000       255005         6.67
         2.419     0.875000       262427         8.00
         2.721     0.887500       266190         8.89
         3.047     0.900000       269943        10.00
         3.407     0.912500       273691        11.43
         3.807     0.925000       277443        13.33
         4.183     0.937500       281197        16.00
         4.379     0.943750       283070        17.78
         4.579     0.950000       284932        20.00
         4.795     0.956250       286823        22.86
         5.031     0.962500       288697        26.67
         5.291     0.968750       290560        32.00
         5.443     0.971875       291495        35.56
         5.615     0.975000       292438        40.00
         5.823     0.978125       293356        45.71
         6.067     0.981250       294301        53.33
         6.419     0.984375       295235        64.00
         6.679     0.985938       295701        71.11
         7.231     0.987500       296172        80.00
         7.939     0.989062       296639        91.43
         8.591     0.990625       297109       106.67
         9.439     0.992188       297576       128.00
        11.183     0.992969       297808       142.22
        12.959     0.993750       298043       160.00
        14.775     0.994531       298277       182.86
        16.863     0.995313       298513       213.33
        17.967     0.996094       298745       256.00
        18.591     0.996484       298865       284.44
        19.151     0.996875       298980       320.00
        19.743     0.997266       299097       365.71
        20.223     0.997656       299216       426.67
        20.783     0.998047       299333       512.00
        21.295     0.998242       299390       568.89
        22.463     0.998437       299449       640.00
        22.927     0.998633       299507       731.43
        23.839     0.998828       299567       853.33
        25.599     0.999023       299625      1024.00
        26.607     0.999121       299653      1137.78
        26.927     0.999219       299684      1280.00
        27.615     0.999316       299711      1462.86
        28.079     0.999414       299741      1706.67
        28.303     0.999512       299771      2048.00
        28.479     0.999561       299786      2275.56
        28.559     0.999609       299799      2560.00
        28.751     0.999658       299814      2925.71
        29.263     0.999707       299829      3413.33
        29.631     0.999756       299843      4096.00
        29.823     0.999780       299852      4551.11
        29.935     0.999805       299858      5120.00
        30.047     0.999829       299869      5851.43
        30.095     0.999854       299873      6826.67
        30.175     0.999878       299880      8192.00
        30.399     0.999890       299884      9102.22
        30.511     0.999902       299887     10240.00
        30.623     0.999915       299891     11702.86
        30.751     0.999927       299895     13653.33
        30.799     0.999939       299898     16384.00
        30.847     0.999945       299900     18204.44
        30.879     0.999951       299903     20480.00
        30.895     0.999957       299905     23405.71
        30.927     0.999963       299906     27306.67
        30.943     0.999969       299907     32768.00
        30.959     0.999973       299908     36408.89
        30.975     0.999976       299910     40960.00
        30.975     0.999979       299910     46811.43
        30.991     0.999982       299911     54613.33
        31.007     0.999985       299913     65536.00
        31.007     0.999986       299913     72817.78
        31.007     0.999988       299913     81920.00
        31.007     0.999989       299913     93622.86
        31.039     0.999991       299914    109226.67
        31.039     0.999992       299914    131072.00
        31.039     0.999993       299914    145635.56
        31.087     0.999994       299915    163840.00
        31.087     0.999995       299915    187245.71
        31.087     0.999995       299915    218453.33
        31.087     0.999996       299915    262144.00
        31.087     0.999997       299915    291271.11
        31.167     0.999997       299916    327680.00
        31.167     1.000000       299916          inf
  ```

Видно, что сервис отлично справляется с `85%` запросов, успевая им ответить быстрее, чем за `2ms`, после чего происходит планомерное повышение времени, необходимого для ответа, а после `99%` наблюдается резкий рост, что говорит о том, что сервис совершенно перестаёт справляться. Оптимальный рейт для кластера из трёх узлов без репликации -- *`12500`*, при таком рейте ответы быстрее `2ms` приходят в `95%` случаев.

Перцентили для кластера с `RF` равным `3`:

```
Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.234     0.000000            1         1.00
       0.621     0.100000        12027         1.11
       0.822     0.200000        24034         1.25
       1.005     0.300000        36011         1.43
       1.149     0.400000        48008         1.67
       1.277     0.500000        59989         2.00
       1.343     0.550000        66001         2.22
       1.428     0.600000        71977         2.50
       1.536     0.650000        78017         2.86
       1.654     0.700000        83992         3.33
       1.787     0.750000        89987         4.00
       1.852     0.775000        93011         4.44
       1.916     0.800000        96010         5.00
       1.980     0.825000        99017         5.71
       2.057     0.850000       102025         6.67
       2.175     0.875000       104971         8.00
       2.279     0.887500       106468         8.89
       2.421     0.900000       107966        10.00
       2.591     0.912500       109464        11.43
       2.783     0.925000       110963        13.33
       3.017     0.937500       112463        16.00
       3.149     0.943750       113218        17.78
       3.317     0.950000       113968        20.00
       3.513     0.956250       114708        22.86
       3.785     0.962500       115458        26.67
       4.235     0.968750       116214        32.00
       4.663     0.971875       116584        35.56
       5.503     0.975000       116958        40.00
       6.871     0.978125       117331        45.71
       8.383     0.981250       117707        53.33
      10.351     0.984375       118083        64.00
      11.711     0.985938       118271        71.11
      13.543     0.987500       118457        80.00
      14.623     0.989062       118644        91.43
      15.703     0.990625       118832       106.67
      16.767     0.992188       119020       128.00
      17.455     0.992969       119114       142.22
      18.159     0.993750       119208       160.00
      19.007     0.994531       119299       182.86
      19.775     0.995313       119394       213.33
      20.847     0.996094       119487       256.00
      21.487     0.996484       119534       284.44
      22.207     0.996875       119582       320.00
      22.799     0.997266       119627       365.71
      23.535     0.997656       119677       426.67
      24.335     0.998047       119722       512.00
      24.703     0.998242       119745       568.89
      25.167     0.998437       119769       640.00
      25.599     0.998633       119791       731.43
      26.255     0.998828       119815       853.33
      26.831     0.999023       119838      1024.00
      26.959     0.999121       119850      1137.78
      27.039     0.999219       119862      1280.00
      27.263     0.999316       119873      1462.86
      27.551     0.999414       119885      1706.67
      28.079     0.999512       119897      2048.00
      28.287     0.999561       119904      2275.56
      28.639     0.999609       119909      2560.00
      28.767     0.999658       119914      2925.71
      29.007     0.999707       119920      3413.33
      29.199     0.999756       119926      4096.00
      29.247     0.999780       119929      4551.11
      29.455     0.999805       119932      5120.00
      29.487     0.999829       119935      5851.43
      29.647     0.999854       119938      6826.67
      29.967     0.999878       119941      8192.00
      30.095     0.999890       119942      9102.22
      30.143     0.999902       119946     10240.00
      30.143     0.999915       119946     11702.86
      30.255     0.999927       119947     13653.33
      30.303     0.999939       119948     16384.00
      30.399     0.999945       119949     18204.44
      30.415     0.999951       119950     20480.00
      30.415     0.999957       119950     23405.71
      30.623     0.999963       119951     27306.67
      30.671     0.999969       119952     32768.00
      30.671     0.999973       119952     36408.89
      30.783     0.999976       119953     40960.00
      30.783     0.999979       119953     46811.43
      30.783     0.999982       119953     54613.33
      30.863     0.999985       119954     65536.00
      30.863     0.999986       119954     72817.78
      30.863     0.999988       119954     81920.00
      30.863     0.999989       119954     93622.86
      30.863     0.999991       119954    109226.67
      30.991     0.999992       119955    131072.00
```

Как можно увидеть, способность сервиса отвечать так же, как до внедрения реплицирования возможна теперь только при снижении рейта более, чем в два раза. Теперь вместо одной вставки на текущей ноде необходимо их делать на всех репликах, дожидаясь ответов от каждого узла, чтобы проанализировать и отправить результат клиенту. Общение узлов по сети -- очень дорогая операция, которая является необходимым трейдоффом для повышения надёжности сервиса, это узкое место требует оптимизаций. Оптимальным рейтом, при котором сервис справляется с `95%` запросами быстрее, чем за `2ms` - `4500`, что почти в `3` раза хуже, чем для сервиса, который не реализует реплицирование.

<hr>

### *GET-запросы*

Аналогично были протестированы *`get-запросы`*. Команда, которая использовалась для тестирования сервиса до внедрения реплицирования: `wrk -t4 -c4 -d30s -R15000 --latency -s get.lua http://localhost:19234`, для модернизированного сервиса рейт был снижен до `6000`, чтобы получить схожие результаты, причём при малейшем повышении перфоманс начинал ухудшаться в разы. Тестирование проводилось на заполненной базе.

| Cluster size | < 2ms percentile | Latency avg |   Rate    |
| :----------: | :--------------: | :---------: | :-------: |
|   *`0 RF`*   |     *`83%`*      | *`1.64ms`*  | *`15000`* |
|   *`3 RF`*   |     *`90%`*      | *`1.39ms`*  | *`6000`*  |

Перцентили для кластера, в котором не реализовано реплицирование:
```
Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.036     0.000000            1         1.00
       0.466     0.100000        30081         1.11
       0.683     0.200000        60057         1.25
       0.874     0.300000        90060         1.43
       1.037     0.400000       120115         1.67
       1.190     0.500000       150023         2.00
       1.276     0.550000       165070         2.22
       1.373     0.600000       179985         2.50
       1.487     0.650000       195051         2.86
       1.612     0.700000       209986         3.33
       1.750     0.750000       224950         4.00
       1.825     0.775000       232472         4.44
       1.906     0.800000       240005         5.00
       1.999     0.825000       247499         5.71
       2.121     0.850000       254998         6.67
       2.325     0.875000       262428         8.00
       2.483     0.887500       266185         8.89
       2.697     0.900000       269934        10.00
       3.017     0.912500       273671        11.43
       3.455     0.925000       277431        13.33
       4.007     0.937500       281176        16.00
       4.355     0.943750       283047        17.78
       4.743     0.950000       284920        20.00
       5.147     0.956250       286811        22.86
       5.571     0.962500       288673        26.67
       6.047     0.968750       290542        32.00
       6.347     0.971875       291476        35.56
       6.707     0.975000       292417        40.00
       7.223     0.978125       293353        45.71
       7.915     0.981250       294287        53.33
       8.623     0.984375       295229        64.00
       8.999     0.985938       295702        71.11
       9.423     0.987500       296162        80.00
      10.087     0.989062       296632        91.43
      10.647     0.990625       297098       106.67
      11.399     0.992188       297566       128.00
      12.095     0.992969       297803       142.22
      13.183     0.993750       298035       160.00
      14.351     0.994531       298270       182.86
      15.919     0.995313       298505       213.33
      16.943     0.996094       298743       256.00
      17.343     0.996484       298856       284.44
      17.791     0.996875       298973       320.00
      18.191     0.997266       299095       365.71
      18.495     0.997656       299211       426.67
      19.039     0.998047       299324       512.00
      19.247     0.998242       299385       568.89
      19.535     0.998437       299442       640.00
      19.743     0.998633       299503       731.43
      19.967     0.998828       299558       853.33
      20.239     0.999023       299617      1024.00
      20.463     0.999121       299646      1137.78
      20.607     0.999219       299676      1280.00
      20.783     0.999316       299704      1462.86
      21.023     0.999414       299735      1706.67
      21.423     0.999512       299763      2048.00
      21.551     0.999561       299779      2275.56
      21.743     0.999609       299792      2560.00
      22.015     0.999658       299807      2925.71
      22.479     0.999707       299823      3413.33
      22.911     0.999756       299836      4096.00
      23.103     0.999780       299844      4551.11
      23.215     0.999805       299851      5120.00
      23.359     0.999829       299859      5851.43
      23.471     0.999854       299866      6826.67
      23.567     0.999878       299873      8192.00
      23.695     0.999890       299877      9102.22
      23.727     0.999902       299880     10240.00
      23.807     0.999915       299884     11702.86
      23.935     0.999927       299889     13653.33
      24.143     0.999939       299891     16384.00
      24.351     0.999945       299893     18204.44
      24.495     0.999951       299896     20480.00
      24.527     0.999957       299897     23405.71
      24.559     0.999963       299899     27306.67
      24.751     0.999969       299900     32768.00
      24.767     0.999973       299901     36408.89
      24.815     0.999976       299902     40960.00
      24.879     0.999979       299903     46811.43
      24.911     0.999982       299904     54613.33
      24.975     0.999985       299905     65536.00
      24.975     0.999986       299905     72817.78
      24.991     0.999988       299906     81920.00
      24.991     0.999989       299906     93622.86
      25.039     0.999991       299907    109226.67
      25.039     0.999992       299907    131072.00
      25.039     0.999993       299907    145635.56
      25.071     0.999994       299908    163840.00
      25.071     0.999995       299908    187245.71
      25.071     0.999995       299908    218453.33
      25.071     0.999996       299908    262144.00
      25.071     0.999997       299908    291271.11
      25.183     0.999997       299909    327680.00
```

Без реплицирования ситуация такая же, как с `put-запросами`. Перфоманс очень схож с тем, что было получено при тестирование добавления элементов в базу. Быстрее, чем за `2ms` отвечают `83%` запросов.  По результатам тестов оптимальным рейтом для *`get-запросов`* в кластере без реплицированя является значение `-R 12500`.

Перцентили для кластера с `RF` равным `3`:

```
Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.237     0.000000            1         1.00
       0.593     0.100000        12026         1.11
       0.771     0.200000        24064         1.25
       0.934     0.300000        36065         1.43
       1.077     0.400000        48051         1.67
       1.205     0.500000        60072         2.00
       1.264     0.550000        66042         2.22
       1.323     0.600000        72011         2.50
       1.391     0.650000        77986         2.86
       1.486     0.700000        83991         3.33
       1.600     0.750000        89984         4.00
       1.662     0.775000        92983         4.44
       1.731     0.800000        95984         5.00
       1.805     0.825000        98972         5.71
       1.878     0.850000       102001         6.67
       1.953     0.875000       104969         8.00
       1.991     0.887500       106465         8.89
       2.033     0.900000       107970        10.00
       2.083     0.912500       109510        11.43
       2.155     0.925000       110976        13.33
       2.295     0.937500       112463        16.00
       2.423     0.943750       113207        17.78
       2.611     0.950000       113961        20.00
       2.873     0.956250       114718        22.86
       3.251     0.962500       115458        26.67
       3.757     0.968750       116207        32.00
       4.065     0.971875       116582        35.56
       4.399     0.975000       116956        40.00
       4.739     0.978125       117333        45.71
       5.127     0.981250       117709        53.33
       5.599     0.984375       118082        64.00
       5.879     0.985938       118268        71.11
       6.167     0.987500       118456        80.00
       6.535     0.989062       118643        91.43
       6.971     0.990625       118831       106.67
       7.447     0.992188       119017       128.00
       7.719     0.992969       119112       142.22
       7.959     0.993750       119205       160.00
       8.207     0.994531       119300       182.86
       8.463     0.995313       119392       213.33
       8.751     0.996094       119486       256.00
       8.951     0.996484       119533       284.44
       9.159     0.996875       119581       320.00
       9.439     0.997266       119628       365.71
       9.743     0.997656       119673       426.67
      10.199     0.998047       119720       512.00
      10.431     0.998242       119744       568.89
      10.671     0.998437       119767       640.00
      10.919     0.998633       119791       731.43
      11.303     0.998828       119817       853.33
      11.511     0.999023       119837      1024.00
      11.759     0.999121       119851      1137.78
      11.887     0.999219       119861      1280.00
      12.015     0.999316       119873      1462.86
      12.127     0.999414       119884      1706.67
      12.295     0.999512       119896      2048.00
      12.367     0.999561       119902      2275.56
      12.439     0.999609       119908      2560.00
      12.511     0.999658       119914      2925.71
      12.599     0.999707       119919      3413.33
      12.695     0.999756       119926      4096.00
      12.735     0.999780       119928      4551.11
      12.751     0.999805       119931      5120.00
      12.847     0.999829       119934      5851.43
      12.903     0.999854       119937      6826.67
      13.007     0.999878       119940      8192.00
      13.039     0.999890       119942      9102.22
      13.143     0.999902       119943     10240.00
      13.183     0.999915       119944     11702.86
      13.223     0.999927       119946     13653.33
      13.311     0.999939       119947     16384.00
      13.383     0.999945       119948     18204.44
      13.407     0.999951       119949     20480.00
      13.407     0.999957       119949     23405.71
      13.423     0.999963       119950     27306.67
      13.615     0.999969       119951     32768.00
      13.615     0.999973       119951     36408.89
      13.623     0.999976       119952     40960.00
      13.623     0.999979       119952     46811.43
      13.623     0.999982       119952     54613.33
      13.783     0.999985       119953     65536.00
      13.783     0.999986       119953     72817.78
      13.783     0.999988       119953     81920.00
      13.783     0.999989       119953     93622.86
      13.783     0.999991       119953    109226.67
      13.839     0.999992       119954    131072.00
      13.839     1.000000       119954          inf
```

По аналогии с `put-запросами` для схожего перфоманса пришлось значительно снижать рейт. Причем, среднее значение `Latency` возрастает более, чем в 10 раз при повышении рейта даже на `100` из чего можно сделать вывод, что `-R 6000` является оптимальным для данного сервиса, если рассматривать `get-запросы`. Проблемы, которые привели к такому падению показателей те же, что и для `put` -- общение между узлами, ожидание ответов, запросы в две базы на каждой из нод. 

<hr>

## *Async-profiler*

При профилировании основные различия с предыдущим этапом связаны с тем, что теперь используется отдельная база данных для хранения таймстемпов. При `put-запросах` теперь есть дополнительные аллокации при вставке данных во вторую базу, при `get-запросах` происходит точно такой же полномасштабный поиск данных по диску из-за чего, собственно, очень сильно падает общий перфоманс. Теперь большую часть блокировок занимает обработка `worker'a` (было `42%`, теперь `57%`). Для оптимизации нужно добавить дополнительный `ExecutorService`, который бы отдельно занимался обработкой и отправкой запросов на другие узлы, чтобы было возможно параллельно обрабатывать запросы к базе в рамках текущего узла. Помимо этого возросло процессорное время, которое используется для хеширования и выбора узлов, на которых должны быть данные. Для оптимизации можно реализовать `Skeleton variaton` или заменить алгоритм хеширования.  

<hr>

## *Выводы*

Решение использовать для хранения таймстемпов отдельную базу сильно сказалось на производительности из-за того, что теперь помимо обращений на диск для поиска значения, нужно также там искать значение таймстемпа по этому ключу, которое хранится отдельно. Для того, чтобы исправить это,  необходимо для каждой записи в LSM хранить время, когда она была добавлена, чтобы, доставая из базы значение сразу иметь его таймстемп.  То есть, просто хранить для каждой записи помимо смещения и размеров значений ещё и время произведённой операции. Это так же очевидно позволит сократить расходы на запись данных в базу, нужно будет сделать это только единожды.  

Общий перфоманс стал очевидно хуже из-за того, что теперь нам необходимо общаться каждый раз с репликами по сети, дожидаясь от них ответов, что существенно замедляет работу. То есть, большая часть дополнительных расходов ресурсов связана именно с тем, что необходимо общаться с большим количеством узлов, рассылать данные на большее количество узлов из чего следует, что связь между нодами является самым узким местом в системе, которое необходимо улучшать, например, за счет асинхронной связи между узлами. Мы должны не дожидаясь ответов от всех узлов, а используя минимально нужное количество данных, отправлять ответы клиенту. 

<hr>

Приложение было доработано, убраны обращения к ненужно БД с таймстемпами, теперь они хранятся вместе с данными.