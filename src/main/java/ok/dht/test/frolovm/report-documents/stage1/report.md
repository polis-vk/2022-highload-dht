# 2022-highload-dht
Курсовой проект 2022 года [курса "Проектирование высоконагруженных систем"](https://polis.vk.company/curriculum/program/discipline/1444/) [VK Образования](https://polis.vk.company/).

В своём Java package `ok.dht.test.<username>` реализуйте интерфейсы [`Service`](../../../../Service.java) и [`ServiceFactory.Factory`](../../../ServiceFactory.java) и поддержите следующий HTTP REST API протокол:
* HTTP `GET /v0/entity?id=<ID>` -- получить данные по ключу `<ID>`. Возвращает `200 OK` и данные или `404 Not Found`.
* HTTP `PUT /v0/entity?id=<ID>` -- создать/перезаписать (upsert) данные по ключу `<ID>`. Возвращает `201 Created`.
* HTTP `DELETE /v0/entity?id=<ID>` -- удалить данные по ключу `<ID>`. Возвращает `202 Accepted`.

Используем свою реализацию `DAO` из весеннего курса `2022-db-lsm`, либо берём референсную реализацию, если курс БД не был завершён.

Проведите нагрузочное тестирование с помощью [wrk2](https://github.com/giltene/wrk2) в **одно соединение**:
* `PUT` запросами на **стабильной** нагрузке (`wrk2` должен обеспечивать заданный с помощью `-R` rate запросов)
* `GET` запросами на **стабильной** нагрузке по **наполненной** БД

Для проведения нагрузочного тестирования для утилиты wrk были использованы Scripting(смотри [wrk2](https://github.com/giltene/wrk2), [wrk](https://github.com/wg/wrk/tree/master/scripts)) \
put-request.lua
```
cou = 0
request = function()
    cou = cou + 1
    path="/v0/entity?id=" .. cou
    body=cou
    return wrk.format("PUT", path, nil, body)
end
```

get-request.lua
```
cou = 0
request = function()
    cou = cou + 1
    path="/v0/entity?id=" .. cou
    return wrk.format("GET", path)
end
```

Проводим тестирование PUT запросами:

При rate=10000 сервер справляется с нагрузкой: среднее Latency 771.93us. Latency max 52ms.
Requests/sec:   9999.76
```
    wrk2 -t 1 -c 1 -d 60s -R 10000 -s requests-wrk/put-requests.lua --latency http://localhost:42342
Running 1m test @ http://localhost:42342
  1 threads and 1 connections
  Thread calibration: mean lat.: 1.266ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency   771.93us    1.53ms  52.00ms   99.73%
    Req/Sec    10.53k   805.09    21.33k    82.05%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%  700.00us
 75.000%    1.00ms
 90.000%    1.17ms
 99.000%    1.98ms
 99.900%   30.59ms
 99.990%   51.29ms
 99.999%   51.97ms
100.000%   52.03ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.034     0.000000            2         1.00
       0.193     0.100000        50267         1.11
       0.328     0.200000       100050         1.25
       0.455     0.300000       150171         1.43
       0.578     0.400000       200114         1.67
       0.700     0.500000       250307         2.00
       0.760     0.550000       275319         2.22
       0.819     0.600000       299991         2.50
       0.879     0.650000       325263         2.86
       0.937     0.700000       349973         3.33
       0.996     0.750000       375235         4.00
       1.025     0.775000       387808         4.44
       1.053     0.800000       400127         5.00
       1.082     0.825000       412877         5.71
       1.109     0.850000       425039         6.67
       1.138     0.875000       437826         8.00
       1.151     0.887500       443717         8.89
       1.166     0.900000       450367        10.00
       1.180     0.912500       456555        11.43
       1.196     0.925000       462698        13.33
       1.225     0.937500       468794        16.00
       1.258     0.943750       471860        17.78
       1.303     0.950000       474973        20.00
       1.371     0.956250       478090        22.86
       1.462     0.962500       481236        26.67
       1.562     0.968750       484356        32.00
       1.614     0.971875       485898        35.56
       1.670     0.975000       487480        40.00
       1.728     0.978125       489046        45.71
       1.788     0.981250       490602        53.33
       1.851     0.984375       492169        64.00
       1.884     0.985938       492943        71.11
       1.919     0.987500       493727        80.00
       1.956     0.989062       494494        91.43
       1.997     0.990625       495274       106.67
       2.042     0.992188       496060       128.00
       2.067     0.992969       496456       142.22
       2.091     0.993750       496841       160.00
       2.121     0.994531       497248       182.86
       2.149     0.995313       497637       213.33
       2.183     0.996094       498012       256.00
       2.203     0.996484       498214       284.44
       2.227     0.996875       498397       320.00
       2.271     0.997266       498592       365.71
       3.371     0.997656       498788       426.67
       9.607     0.998047       498983       512.00
      14.311     0.998242       499081       568.89
      18.639     0.998437       499178       640.00
      23.295     0.998633       499276       731.43
      27.103     0.998828       499374       853.33
      31.199     0.999023       499471      1024.00
      33.631     0.999121       499520      1137.78
      35.871     0.999219       499569      1280.00
      38.239     0.999316       499618      1462.86
      40.255     0.999414       499667      1706.67
      42.399     0.999512       499715      2048.00
      43.615     0.999561       499740      2275.56
      44.767     0.999609       499764      2560.00
      45.951     0.999658       499789      2925.71
      47.007     0.999707       499813      3413.33
      48.031     0.999756       499837      4096.00
      48.607     0.999780       499850      4551.11
      49.087     0.999805       499862      5120.00
      49.599     0.999829       499874      5851.43
      50.239     0.999854       499886      6826.67
      50.751     0.999878       499898      8192.00
      51.103     0.999890       499905      9102.22
      51.359     0.999902       499911     10240.00
      51.615     0.999915       499917     11702.86
      51.807     0.999927       499929     13653.33
      51.807     0.999939       499929     16384.00
      51.839     0.999945       499933     18204.44
      51.871     0.999951       499938     20480.00
      51.871     0.999957       499938     23405.71
      51.903     0.999963       499944     27306.67
      51.903     0.999969       499944     32768.00
      51.935     0.999973       499951     36408.89
      51.935     0.999976       499951     40960.00
      51.935     0.999979       499951     46811.43
      51.935     0.999982       499951     54613.33
      51.967     0.999985       499955     65536.00
      51.967     0.999986       499955     72817.78
      51.967     0.999988       499955     81920.00
      51.967     0.999989       499955     93622.86
      51.967     0.999991       499955    109226.67
      51.999     0.999992       499957    131072.00
      51.999     0.999993       499957    145635.56
      51.999     0.999994       499957    163840.00
      51.999     0.999995       499957    187245.71
      51.999     0.999995       499957    218453.33
      52.031     0.999996       499959    262144.00
      52.031     1.000000       499959          inf
#[Mean    =        0.772, StdDeviation   =        1.527]
#[Max     =       52.000, Total count    =       499959]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  599984 requests in 1.00m, 38.34MB read
Requests/sec:   9999.76
Transfer/sec:    654.28KB
```

При rate=15000 сервер уже плохо справляется: среднее Latency 403.26ms.
Requests/sec:  14999.57
```
wrk2 -t 1 -c 1 -d 60s -R 15000 -s requests-wrk/put-requests.lua --latency http://localhost:42342
Running 1m test @ http://localhost:42342
  1 threads and 1 connections
  Thread calibration: mean lat.: 1250.098ms, rate sampling interval: 6705ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency   403.26ms  881.92ms   3.38s    85.30%
    Req/Sec    16.08k     1.99k   20.70k    85.71%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%  820.00us
 75.000%    1.19ms
 90.000%    2.11s 
 99.000%    3.27s 
 99.900%    3.38s 
 99.990%    3.38s 
 99.999%    3.38s 
100.000%    3.38s 

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.034     0.000000            1         1.00
       0.205     0.100000        80424         1.11
       0.363     0.200000       160212         1.25
       0.521     0.300000       240490         1.43
       0.671     0.400000       320640         1.67
       0.820     0.500000       400735         2.00
       0.894     0.550000       440376         2.22
       0.968     0.600000       480411         2.50
       1.042     0.650000       520485         2.86
       1.115     0.700000       560438         3.33
       1.191     0.750000       600505         4.00
      31.023     0.775000       620441         4.44
     409.087     0.800000       640454         5.00
     802.303     0.825000       660480         5.71
    1238.015     0.850000       680488         6.67
    1653.759     0.875000       700508         8.00
    1879.039     0.887500       710505         8.89
    2105.343     0.900000       720623        10.00
    2303.999     0.912500       730521        11.43
    2504.703     0.925000       740813        13.33
    2568.191     0.937500       750707        16.00
    2594.815     0.943750       755543        17.78
    2691.071     0.950000       760593        20.00
    2772.991     0.956250       765555        22.86
    2844.671     0.962500       770623        26.67
    2947.071     0.968750       775636        32.00
    2977.791     0.971875       778204        35.56
    3018.751     0.975000       780627        40.00
    3074.047     0.978125       783118        45.71
    3121.151     0.981250       785612        53.33
    3170.303     0.984375       788088        64.00
    3198.975     0.985938       789352        71.11
    3227.647     0.987500       790625        80.00
    3254.271     0.989062       791824        91.43
    3284.991     0.990625       793140       106.67
    3311.615     0.992188       794318       128.00
    3323.903     0.992969       795020       142.22
    3332.095     0.993750       795711       160.00
    3338.239     0.994531       796270       182.86
    3344.383     0.995313       796866       213.33
    3352.575     0.996094       797545       256.00
    3356.671     0.996484       797879       284.44
    3360.767     0.996875       798243       320.00
    3362.815     0.997266       798422       365.71
    3366.911     0.997656       798812       426.67
    3368.959     0.998047       799018       512.00
    3371.007     0.998242       799228       568.89
    3373.055     0.998437       799416       640.00
    3375.103     0.998633       799793       731.43
    3375.103     0.998828       799793       853.33
    3375.103     0.999023       799793      1024.00
    3377.151     0.999121       800201      1137.78
    3377.151     0.999219       800201      1280.00
    3377.151     0.999316       800201      1462.86
    3377.151     0.999414       800201      1706.67
    3377.151     0.999512       800201      2048.00
    3379.199     0.999561       800567      2275.56
    3379.199     1.000000       800567          inf
#[Mean    =      403.261, StdDeviation   =      881.916]
#[Max     =     3377.152, Total count    =       800567]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  899970 requests in 1.00m, 57.50MB read
Requests/sec:  14999.57
Transfer/sec:      0.96MB
```

При rate=20000 сервер захлебнулся: среднее Latency 4.45s. \
Requests/sec:  18118.98
```
wrk2 -t 1 -c 1 -d 60s -R 20000 -s requests-wrk/put-requests.lua --latency http://localhost:42342
Running 1m test @ http://localhost:42342
  1 threads and 1 connections
  Thread calibration: mean lat.: 2432.935ms, rate sampling interval: 6565ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     4.45s     1.27s    6.35s    55.25%
    Req/Sec    19.02k     3.28k   22.89k    42.86%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    4.56s 
 75.000%    5.54s 
 90.000%    6.03s 
 99.000%    6.32s 
 99.900%    6.35s 
 99.990%    6.35s 
 99.999%    6.35s 
100.000%    6.35s 

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

    2026.495     0.000000           97         1.00
    2510.847     0.100000        96382         1.11
    2930.687     0.200000       190214         1.25
    3938.303     0.300000       285039         1.43
    4284.415     0.400000       383028         1.67
    4562.943     0.500000       475199         2.00
    4780.031     0.550000       523665         2.22
    4988.927     0.600000       570181         2.50
    5222.399     0.650000       617557         2.86
    5394.431     0.700000       666001         3.33
    5537.791     0.750000       712290         4.00
    5660.671     0.775000       736142         4.44
    5730.303     0.800000       759899         5.00
    5787.647     0.825000       783749         5.71
    5836.799     0.850000       809572         6.67
    5918.719     0.875000       830936         8.00
    5992.447     0.887500       843355         8.89
    6033.407     0.900000       854847        10.00
    6074.367     0.912500       867179        11.43
    6082.559     0.925000       890607        13.33
    6082.559     0.937500       890607        16.00
    6094.847     0.943750       896446        17.78
    6131.711     0.950000       902361        20.00
    6164.479     0.956250       908683        22.86
    6193.151     0.962500       913985        26.67
    6238.207     0.968750       920250        32.00
    6250.495     0.971875       922835        35.56
    6262.783     0.975000       926120        40.00
    6283.263     0.978125       929201        45.71
    6295.551     0.981250       933897        53.33
    6299.647     0.984375       935891        64.00
    6303.743     0.985938       937921        71.11
    6303.743     0.987500       937921        80.00
    6316.031     0.989062       939678        91.43
    6324.223     0.990625       941037       106.67
    6332.415     0.992188       942794       128.00
    6336.511     0.992969       943725       142.22
    6336.511     0.993750       943725       160.00
    6340.607     0.994531       944952       182.86
    6344.703     0.995313       946103       213.33
    6344.703     0.996094       946103       256.00
    6348.799     0.996484       948523       284.44
    6348.799     0.996875       948523       320.00
    6348.799     0.997266       948523       365.71
    6348.799     0.997656       948523       426.67
    6348.799     0.998047       948523       512.00
    6348.799     0.998242       948523       568.89
    6348.799     0.998437       948523       640.00
    6348.799     0.998633       948523       731.43
    6348.799     0.998828       948523       853.33
    6352.895     0.999023       949509      1024.00
    6352.895     1.000000       949509          inf
#[Mean    =     4449.694, StdDeviation   =     1266.732]
#[Max     =     6348.800, Total count    =       949509]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  1087135 requests in 1.00m, 69.46MB read
Requests/sec:  18118.98
Transfer/sec:      1.16MB
```

### Результаты профилирования async-profiler:

Большая часть работы CPU приходится на сеть. Около 45% приходится на работу с Selectors.
15% на чтение request. ~20% приходится на отправку ответа. ~10% garbage collector\
На запросы в бд тратится 5% времени. Хотчется также отметить, что база данных вызывает функцию flushInBd(), процент которой вырос от 10k запросов к 20k запросам
с 0.88% до 2% из-за увеличения кол-ва загружаемых данных.

На ServiceImpl приходится ~5% CPU при этом основная часть этой нагрузки приходится на метод ConcurrentSkipListMap.put(~3% от общего CPU), который в свою очередь
вызывает MemorySegmentComparator.compare. Так как ConcurrentSkipListMap поддерживает такие интерфейсы как SortedMap, NavigableMap, ConcurrentNavigableMap 
при использовании данной реализации базы данных стоит уделить внимание эффективности реализации функции compare для ее содержимого.

#### Основные данные по нагрузочному тестированию:
При rate=10000 сервер справляется с нагрузкой: среднее Latency 771.93us. При этом 95% запросов c latency < 1.5ms, 
а 99% запросов < 2ms.

При rate=15000 сервер уже плохо справляется и среднее Latency 403.26ms. \
Начиная с Percentile=0.9 время ожидания ответа >2s.

При rate=20000 сервер захлебнулся и среднее Latency 13.24s. \
Начиная с Percentile=0.6 время ожидания ответа >5s \
Requests/sec: 18118.98

Alloc: \
Основная часть аллокации памяти приходится на сеть ~65%.
Service аллоцирует ~25%.
Flush in bd на 10k занимает 2.79%, а при 15k ~25%, а при 20k ~10%. Что связано с увеличением размера и количества данных и тем, успевает
ли сервер и база данных обрабатывать запросы.

### Тестирование GET запросами:

При rate=3000 сервер справляется с нагрузкой: \
Average Latency     1.11ms \
Requests/sec:   2999.96
```
wrk2 -t 1 -c 1 -d 60s -R 3000 -s requests-wrk/get-requests.lua --latency http://localhost:42342
Running 1m test @ http://localhost:42342
  1 threads and 1 connections
  Thread calibration: mean lat.: 1.203ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.10ms  576.75us   3.93ms   66.90%
    Req/Sec     3.17k   291.80     4.11k    71.37%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.03ms
 75.000%    1.37ms
 90.000%    1.97ms
 99.000%    2.65ms
 99.900%    2.95ms
 99.990%    3.30ms
 99.999%    3.93ms
100.000%    3.93ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.184     0.000000            2         1.00
       0.401     0.100000        15070         1.11
       0.570     0.200000        30082         1.25
       0.729     0.300000        45002         1.43
       0.885     0.400000        60047         1.67
       1.033     0.500000        75086         2.00
       1.103     0.550000        82571         2.22
       1.170     0.600000        90006         2.50
       1.237     0.650000        97588         2.86
       1.299     0.700000       105050         3.33
       1.367     0.750000       112562         4.00
       1.425     0.775000       116276         4.44
       1.518     0.800000       120011         5.00
       1.620     0.825000       123752         5.71
       1.729     0.850000       127506         6.67
       1.848     0.875000       131252         8.00
       1.906     0.887500       133140         8.89
       1.965     0.900000       135011        10.00
       2.024     0.912500       136865        11.43
       2.091     0.925000       138774        13.33
       2.165     0.937500       140649        16.00
       2.201     0.943750       141547        17.78
       2.247     0.950000       142520        20.00
       2.291     0.956250       143431        22.86
       2.337     0.962500       144359        26.67
       2.393     0.968750       145310        32.00
       2.423     0.971875       145807        35.56
       2.451     0.975000       146235        40.00
       2.487     0.978125       146706        45.71
       2.523     0.981250       147179        53.33
       2.563     0.984375       147655        64.00
       2.583     0.985938       147880        71.11
       2.607     0.987500       148112        80.00
       2.631     0.989062       148351        91.43
       2.661     0.990625       148577       106.67
       2.687     0.992188       148826       128.00
       2.701     0.992969       148941       142.22
       2.717     0.993750       149053       160.00
       2.735     0.994531       149171       182.86
       2.753     0.995313       149283       213.33
       2.775     0.996094       149400       256.00
       2.787     0.996484       149456       284.44
       2.801     0.996875       149517       320.00
       2.817     0.997266       149577       365.71
       2.833     0.997656       149638       426.67
       2.851     0.998047       149696       512.00
       2.863     0.998242       149723       568.89
       2.879     0.998437       149749       640.00
       2.897     0.998633       149779       731.43
       2.927     0.998828       149809       853.33
       2.967     0.999023       149837      1024.00
       2.981     0.999121       149854      1137.78
       2.993     0.999219       149866      1280.00
       3.017     0.999316       149883      1462.86
       3.041     0.999414       149896      1706.67
       3.083     0.999512       149910      2048.00
       3.099     0.999561       149918      2275.56
       3.115     0.999609       149926      2560.00
       3.137     0.999658       149932      2925.71
       3.165     0.999707       149941      3413.33
       3.185     0.999756       149947      4096.00
       3.193     0.999780       149951      4551.11
       3.203     0.999805       149955      5120.00
       3.217     0.999829       149958      5851.43
       3.259     0.999854       149962      6826.67
       3.283     0.999878       149965      8192.00
       3.293     0.999890       149967      9102.22
       3.319     0.999902       149969     10240.00
       3.335     0.999915       149971     11702.86
       3.413     0.999927       149973     13653.33
       3.527     0.999939       149974     16384.00
       3.529     0.999945       149975     18204.44
       3.635     0.999951       149976     20480.00
       3.639     0.999957       149977     23405.71
       3.689     0.999963       149978     27306.67
       3.701     0.999969       149979     32768.00
       3.701     0.999973       149979     36408.89
       3.803     0.999976       149980     40960.00
       3.803     0.999979       149980     46811.43
       3.885     0.999982       149981     54613.33
       3.885     0.999985       149981     65536.00
       3.885     0.999986       149981     72817.78
       3.927     0.999988       149982     81920.00
       3.927     0.999989       149982     93622.86
       3.927     0.999991       149982    109226.67
       3.927     0.999992       149982    131072.00
       3.927     0.999993       149982    145635.56
       3.933     0.999994       149983    163840.00
       3.933     1.000000       149983          inf
#[Mean    =        1.096, StdDeviation   =        0.577]
#[Max     =        3.932, Total count    =       149983]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  179997 requests in 1.00m, 11.57MB read
Requests/sec:   2999.96
Transfer/sec:    197.41KB
```

При rate=5000 сервер после Percentile=0.9 отвечает ~ 1 секунду, что уже довольно много: \
Average Latency    32.17ms \
Requests/sec:   4904.79 
```
     wrk2 -t 1 -c 1 -d 60s -R 5000 -s requests-wrk/get-requests.lua --latency http://localhost:42342
Running 1m test @ http://localhost:42342
  1 threads and 1 connections
  Thread calibration: mean lat.: 2.150ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency    32.17ms  154.11ms   1.14s    95.67%
    Req/Sec     5.16k   638.26     7.11k    79.48%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    0.86ms
 75.000%    1.19ms
 90.000%    2.06ms
 99.000%  905.22ms
 99.900%    1.12s 
 99.990%    1.14s 
 99.999%    1.14s 
100.000%    1.14s 

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.140     0.000000            2         1.00
       0.310     0.100000        24521         1.11
       0.453     0.200000        49041         1.25
       0.590     0.300000        73469         1.43
       0.727     0.400000        97872         1.67
       0.863     0.500000       122163         2.00
       0.932     0.550000       134506         2.22
       1.000     0.600000       146558         2.50
       1.070     0.650000       158904         2.86
       1.137     0.700000       171042         3.33
       1.194     0.750000       183209         4.00
       1.221     0.775000       189545         4.44
       1.246     0.800000       195458         5.00
       1.272     0.825000       201536         5.71
       1.301     0.850000       207665         6.67
       1.407     0.875000       213747         8.00
       1.662     0.887500       216786         8.89
       2.063     0.900000       219841        10.00
       2.599     0.912500       222901        11.43
       3.381     0.925000       225948        13.33
       4.971     0.937500       229001        16.00
       7.075     0.943750       230523        17.78
      25.455     0.950000       232049        20.00
     173.823     0.956250       233576        22.86
     351.231     0.962500       235104        26.67
     521.727     0.968750       236630        32.00
     635.391     0.971875       237395        35.56
     722.431     0.975000       238171        40.00
     760.831     0.978125       238919        45.71
     806.399     0.981250       239690        53.33
     849.407     0.984375       240455        64.00
     871.935     0.985938       240846        71.11
     889.855     0.987500       241268        80.00
     901.631     0.989062       241626        91.43
     907.775     0.990625       242017       106.67
     942.079     0.992188       242362       128.00
     950.271     0.992969       242550       142.22
     975.359     0.993750       242736       160.00
    1004.543     0.994531       242927       182.86
    1033.727     0.995313       243121       213.33
    1062.911     0.996094       243314       256.00
    1078.271     0.996484       243404       284.44
    1086.463     0.996875       243506       320.00
    1094.655     0.997266       243609       365.71
    1099.775     0.997656       243714       426.67
    1105.919     0.998047       243789       512.00
    1106.943     0.998242       243844       568.89
    1110.015     0.998437       243911       640.00
    1113.087     0.998633       243943       731.43
    1114.111     0.998828       243977       853.33
    1118.207     0.999023       244042      1024.00
    1120.255     0.999121       244049      1137.78
    1124.351     0.999219       244081      1280.00
    1128.447     0.999316       244096      1462.86
    1130.495     0.999414       244125      1706.67
    1134.591     0.999512       244159      2048.00
    1134.591     0.999561       244159      2275.56
    1135.615     0.999609       244183      2560.00
    1135.615     0.999658       244183      2925.71
    1136.639     0.999707       244198      3413.33
    1139.711     0.999756       244227      4096.00
    1139.711     0.999780       244227      4551.11
    1139.711     0.999805       244227      5120.00
    1139.711     0.999829       244227      5851.43
    1139.711     0.999854       244227      6826.67
    1140.735     0.999878       244259      8192.00
    1140.735     0.999890       244259      9102.22
    1140.735     0.999902       244259     10240.00
    1140.735     0.999915       244259     11702.86
    1140.735     0.999927       244259     13653.33
    1140.735     0.999939       244259     16384.00
    1140.735     0.999945       244259     18204.44
    1140.735     0.999951       244259     20480.00
    1140.735     0.999957       244259     23405.71
    1140.735     0.999963       244259     27306.67
    1140.735     0.999969       244259     32768.00
    1140.735     0.999973       244259     36408.89
    1140.735     0.999976       244259     40960.00
    1140.735     0.999979       244259     46811.43
    1140.735     0.999982       244259     54613.33
    1140.735     0.999985       244259     65536.00
    1140.735     0.999986       244259     72817.78
    1141.759     0.999988       244260     81920.00
    1141.759     0.999989       244260     93622.86
    1141.759     0.999991       244260    109226.67
    1142.783     0.999992       244262    131072.00
    1142.783     1.000000       244262          inf
#[Mean    =       32.167, StdDeviation   =      154.113]
#[Max     =     1141.760, Total count    =       244262]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  294287 requests in 1.00m, 18.98MB read
Requests/sec:   4904.79
Transfer/sec:    323.90KB
```

При rate=7000 сервер захлебнулся: \
Average Latency 5.73s  \
Requests/sec:   6093.28

```
wrk2 -t 1 -c 1 -d 60s -R 7000 -s requests-wrk/get-requests.lua --latency http://localhost:42342
Running 1m test @ http://localhost:42342
  1 threads and 1 connections
  Thread calibration: mean lat.: 2179.892ms, rate sampling interval: 6381ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     5.73s     1.26s    7.77s    58.68%
    Req/Sec     6.36k    91.78     6.45k    85.71%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    5.80s 
 75.000%    6.83s 
 90.000%    7.40s 
 99.000%    7.74s 
 99.900%    7.77s 
 99.990%    7.77s 
 99.999%    7.77s 
100.000%    7.77s 

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

    3295.231     0.000000           44         1.00
    3917.823     0.100000        31892         1.11
    4468.735     0.200000        63767         1.25
    4907.007     0.300000        95758         1.43
    5361.663     0.400000       127479         1.67
    5795.839     0.500000       159534         2.00
    6004.735     0.550000       175439         2.22
    6217.727     0.600000       191198         2.50
    6414.335     0.650000       207302         2.86
    6623.231     0.700000       223069         3.33
    6828.031     0.750000       239417         4.00
    6930.431     0.775000       246960         4.44
    7036.927     0.800000       255366         5.00
    7127.039     0.825000       263139         5.71
    7225.343     0.850000       271172         6.67
    7315.455     0.875000       279200         8.00
    7356.415     0.887500       283140         8.89
    7397.375     0.900000       286796        10.00
    7446.527     0.912500       290801        11.43
    7495.679     0.925000       294755        13.33
    7540.735     0.937500       298999        16.00
    7565.311     0.943750       300777        17.78
    7585.791     0.950000       302988        20.00
    7610.367     0.956250       304970        22.86
    7643.135     0.962500       306911        26.67
    7663.615     0.968750       308675        32.00
    7679.999     0.971875       309771        35.56
    7692.287     0.975000       310900        40.00
    7700.479     0.978125       311917        45.71
    7708.671     0.981250       312844        53.33
    7725.055     0.984375       313784        64.00
    7729.151     0.985938       314235        71.11
    7737.343     0.987500       315187        80.00
    7737.343     0.989062       315187        91.43
    7741.439     0.990625       315855       106.67
    7745.535     0.992188       316168       128.00
    7749.631     0.992969       316424       142.22
    7753.727     0.993750       316654       160.00
    7757.823     0.994531       317060       182.86
    7761.919     0.995313       317431       213.33
    7761.919     0.996094       317431       256.00
    7766.015     0.996484       317919       284.44
    7766.015     0.996875       317919       320.00
    7766.015     0.997266       317919       365.71
    7766.015     0.997656       317919       426.67
    7770.111     0.998047       318403       512.00
    7770.111     0.998242       318403       568.89
    7770.111     0.998437       318403       640.00
    7770.111     0.998633       318403       731.43
    7770.111     0.998828       318403       853.33
    7770.111     0.999023       318403      1024.00
    7770.111     0.999121       318403      1137.78
    7770.111     0.999219       318403      1280.00
    7774.207     0.999316       318626      1462.86
    7774.207     1.000000       318626          inf
#[Mean    =     5729.293, StdDeviation   =     1256.589]
#[Max     =     7770.112, Total count    =       318626]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  365596 requests in 1.00m, 23.60MB read
Requests/sec:   6093.28
Transfer/sec:    402.82KB
```

### Результаты профилирования async-profiler:

При аллокации памяти 99% приходится на Storage.entryIndex MapMemorySegment.asSlice, что логично так как у нас заполненная база данных,
и основная работа это поиск и считывание данных из базы. 

Для CPU:\

rate=3000: \
Сервер стабильно справляется с нагрузкой. Среднее Latency 1.10ms, а максимальное 3.93ms.

При rate=5000 сервер после Percentile=0.9 отвечает ~ 1 секунду:
среднее Latency    32.17ms
обрабатываем Requests/sec:   4904.79

При rate=7000 сервер захлебнулся.
Среднее latency 5.73s . \
Requests/sec:   6093.28

Большую часть CPU 93% работа с базой данных(MemorySegmentDao). 
Обработка request занимает 2%. Selectors - 2%. Garbage Collector - 2%.

Основное время тратится на getOffset из jdk.incubator.foreign.MemoryAccess и Comparator compare в entryIndex. 
В данном случае трудно будет оптимизировать данный код, так как это основная функция для чтения данных для нашей реализации Storage.
Однако неплохой идеей оптимизации могут быть кэширование наиболее частых запросов. Также можно распараллеливать запросы, 
в таком случае для синхронизации можно использование read-write locks.
Также как при put запросах значительная часть CPU тратится на сравнение элементов, 
поэтому важна эффективность реализации функции compare для содержимого базы. 

Графики [`Latency от Percentile`](http://hdrhistogram.github.io/HdrHistogram/plotFiles.html) находятся в папке [`hdrhistogram`](../../hdrhistogram). 
Подробнее о построении можно прочитать на странице Acknowledgements [wrk2](https://github.com/giltene/wrk2). \
Заметим, что при стабильной работе сервера, изменение Latency на графиках(get3000, put-10000) практически не заметно. \
При увеличении нагрузки на сервер наблюдаем рост Latency: для get5000 начиная с 95%, а для put 15000 с 77%. \
Когда сервер захлебывается резкий рост Latency проиcходит сразу со старта: графики (put20000, get8000). 
