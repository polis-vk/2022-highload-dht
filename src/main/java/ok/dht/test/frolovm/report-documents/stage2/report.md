## Этап 2. Асинхронный сервер (deadline 2022-10-05 23:59:59 MSK)

Вынесите **обработку** запросов в отдельный `ExecutorService` с ограниченной очередью, чтобы разгрузить `SelectorThread`ы HTTP сервера.

Проведите нагрузочное тестирование с помощью [wrk2](https://github.com/giltene/wrk2) с **большим количеством соединений** (не меньше 64) `PUT` и `GET` запросами.

Отпрофилируйте приложение (CPU, alloc и lock) под `PUT` и `GET` нагрузкой с помощью [async-profiler](https://github.com/Artyomcool/async-profiler).

Для проведения нагрузочного тестирования для утилиты wrk были использованы Scripting(смотри [wrk2](https://github.com/giltene/wrk2), [wrk](https://github.com/wg/wrk/tree/master/scripts)) \
put-request.lua
```
cou = 0
request = function()
    cou = cou + 1
    path="/v0/entity?id=" .. cou
    body=cou
    return wrk.format("PUT", path, nil, body)
end
```

get-request.lua
```
cou = 0
request = function()
    path="/v0/entity?id=" .. math.random(1, 100000)
    return wrk.format("GET", path)
end
```

### Синхронная реализация 

### PUT

```
wrk2 -t 6 -c 64 -d 60s -R 50000 -s requests-wrk/put-requests.lua --latency http://localhost:42342
    Running 1m test @ http://localhost:42342
  6 threads and 64 connections
  Thread calibration: mean lat.: 1.577ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.585ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.569ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.560ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.639ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.661ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.64ms    4.42ms  94.46ms   99.01%
    Req/Sec     8.79k   766.17    19.22k    81.30%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.22ms
 75.000%    1.66ms
 90.000%    2.11ms
 99.000%    5.53ms
 99.900%   75.14ms
 99.990%   90.11ms
 99.999%   92.61ms
100.000%   94.53ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.041     0.000000            1         1.00
       0.534     0.100000       250357         1.11
       0.728     0.200000       499609         1.25
       0.896     0.300000       750549         1.43
       1.056     0.400000       999180         1.67
       1.217     0.500000      1248850         2.00
       1.300     0.550000      1374832         2.22
       1.384     0.600000      1498637         2.50
       1.472     0.650000      1624180         2.86
       1.564     0.700000      1748587         3.33
       1.665     0.750000      1873800         4.00
       1.720     0.775000      1936090         4.44
       1.780     0.800000      1998680         5.00
       1.845     0.825000      2060547         5.71
       1.918     0.850000      2123306         6.67
       2.003     0.875000      2185730         8.00
       2.051     0.887500      2216745         8.89
       2.105     0.900000      2248753        10.00
       2.163     0.912500      2279121        11.43
       2.233     0.925000      2310818        13.33
       2.311     0.937500      2341402        16.00
       2.357     0.943750      2357057        17.78
       2.409     0.950000      2372805        20.00
       2.467     0.956250      2388579        22.86
       2.535     0.962500      2404190        26.67
       2.615     0.968750      2419708        32.00
       2.663     0.971875      2427506        35.56
       2.717     0.975000      2435255        40.00
       2.781     0.978125      2443036        45.71
       2.859     0.981250      2450712        53.33
       2.969     0.984375      2458458        64.00
       3.049     0.985938      2462417        71.11
       3.173     0.987500      2466287        80.00
       3.681     0.989062      2470166        91.43
       9.703     0.990625      2474066       106.67
      20.383     0.992188      2477972       128.00
      23.615     0.992969      2479921       142.22
      26.511     0.993750      2481875       160.00
      30.511     0.994531      2483823       182.86
      34.655     0.995313      2485783       213.33
      39.071     0.996094      2487728       256.00
      42.111     0.996484      2488700       284.44
      48.191     0.996875      2489679       320.00
      54.783     0.997266      2490652       365.71
      58.687     0.997656      2491626       426.67
      62.015     0.998047      2492604       512.00
      63.807     0.998242      2493090       568.89
      66.431     0.998437      2493583       640.00
      69.375     0.998633      2494072       731.43
      72.511     0.998828      2494556       853.33
      75.519     0.999023      2495047      1024.00
      76.991     0.999121      2495289      1137.78
      78.527     0.999219      2495528      1280.00
      80.063     0.999316      2495775      1462.86
      81.535     0.999414      2496021      1706.67
      83.071     0.999512      2496267      2048.00
      83.775     0.999561      2496387      2275.56
      84.415     0.999609      2496508      2560.00
      85.311     0.999658      2496635      2925.71
      86.271     0.999707      2496751      3413.33
      87.231     0.999756      2496870      4096.00
      87.743     0.999780      2496937      4551.11
      88.191     0.999805      2496994      5120.00
      88.703     0.999829      2497062      5851.43
      89.151     0.999854      2497119      6826.67
      89.663     0.999878      2497182      8192.00
      89.855     0.999890      2497207      9102.22
      90.175     0.999902      2497242     10240.00
      90.367     0.999915      2497270     11702.86
      90.623     0.999927      2497301     13653.33
      90.943     0.999939      2497332     16384.00
      91.199     0.999945      2497351     18204.44
      91.327     0.999951      2497364     20480.00
      91.391     0.999957      2497374     23405.71
      91.647     0.999963      2497396     27306.67
      91.775     0.999969      2497408     32768.00
      91.839     0.999973      2497418     36408.89
      91.903     0.999976      2497420     40960.00
      91.967     0.999979      2497426     46811.43
      92.159     0.999982      2497435     54613.33
      92.287     0.999985      2497443     65536.00
      92.351     0.999986      2497447     72817.78
      92.415     0.999988      2497449     81920.00
      92.543     0.999989      2497453     93622.86
      92.607     0.999991      2497457    109226.67
      92.735     0.999992      2497461    131072.00
      92.863     0.999993      2497462    145635.56
      92.991     0.999994      2497464    163840.00
      93.055     0.999995      2497466    187245.71
      93.119     0.999995      2497468    218453.33
      93.183     0.999996      2497471    262144.00
      93.183     0.999997      2497471    291271.11
      93.311     0.999997      2497473    327680.00
      93.311     0.999997      2497473    374491.43
      93.439     0.999998      2497475    436906.67
      93.439     0.999998      2497475    524288.00
      93.439     0.999998      2497475    582542.22
      93.503     0.999998      2497476    655360.00
      93.503     0.999999      2497476    748982.86
      93.759     0.999999      2497477    873813.33
      93.759     0.999999      2497477   1048576.00
      93.759     0.999999      2497477   1165084.44
      94.207     0.999999      2497478   1310720.00
      94.207     0.999999      2497478   1497965.71
      94.207     0.999999      2497478   1747626.67
      94.207     1.000000      2497478   2097152.00
      94.207     1.000000      2497478   2330168.89
      94.527     1.000000      2497479   2621440.00
      94.527     1.000000      2497479          inf
#[Mean    =        1.642, StdDeviation   =        4.423]
#[Max     =       94.464, Total count    =      2497479]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  2990648 requests in 1.00m, 191.09MB read
Requests/sec:  49843.68
Transfer/sec:      3.18MB
```

CPU
![img_2.png](img_2.png)

ALLOC
![img_3.png](img_3.png)

LOCK
![img_4.png](img_4.png)


### GET 
```
Running 1m test @ http://localhost:42342
  6 threads and 64 connections
  Thread calibration: mean lat.: 1.889ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 2.189ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 2.153ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.857ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.840ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 2.150ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.41ms    2.04ms  46.43ms   99.23%
    Req/Sec     8.79k   648.34    17.33k    71.57%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.22ms
 75.000%    1.67ms
 90.000%    2.10ms
 99.000%    3.06ms
 99.900%   37.98ms
 99.990%   43.84ms
 99.999%   45.82ms
100.000%   46.46ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.039     0.000000            1         1.00
       0.544     0.100000       250024         1.11
       0.737     0.200000       499629         1.25
       0.904     0.300000       749348         1.43
       1.064     0.400000       999258         1.67
       1.224     0.500000      1249329         2.00
       1.306     0.550000      1374076         2.22
       1.390     0.600000      1499156         2.50
       1.478     0.650000      1624075         2.86
       1.570     0.700000      1748486         3.33
       1.670     0.750000      1873289         4.00
       1.725     0.775000      1936558         4.44
       1.783     0.800000      1998744         5.00
       1.846     0.825000      2060496         5.71
       1.917     0.850000      2123219         6.67
       1.998     0.875000      2185954         8.00
       2.044     0.887500      2216992         8.89
       2.095     0.900000      2248257        10.00
       2.151     0.912500      2279192        11.43
       2.215     0.925000      2310365        13.33
       2.291     0.937500      2341798        16.00
       2.333     0.943750      2357048        17.78
       2.381     0.950000      2372921        20.00
       2.435     0.956250      2388712        22.86
       2.493     0.962500      2403890        26.67
       2.565     0.968750      2419634        32.00
       2.605     0.971875      2427327        35.56
       2.649     0.975000      2435067        40.00
       2.701     0.978125      2442857        45.71
       2.763     0.981250      2450798        53.33
       2.837     0.984375      2458576        64.00
       2.881     0.985938      2462478        71.11
       2.937     0.987500      2466345        80.00
       3.007     0.989062      2470267        91.43
       3.109     0.990625      2474091       106.67
       3.371     0.992188      2477978       128.00
       4.055     0.992969      2479925       142.22
       5.371     0.993750      2481874       160.00
       7.059     0.994531      2483825       182.86
       9.407     0.995313      2485780       213.33
      14.567     0.996094      2487728       256.00
      17.983     0.996484      2488705       284.44
      21.839     0.996875      2489684       320.00
      25.263     0.997266      2490653       365.71
      28.351     0.997656      2491629       426.67
      32.303     0.998047      2492606       512.00
      33.535     0.998242      2493101       568.89
      34.527     0.998437      2493588       640.00
      35.679     0.998633      2494071       731.43
      36.895     0.998828      2494569       853.33
      38.111     0.999023      2495046      1024.00
      38.719     0.999121      2495296      1137.78
      39.295     0.999219      2495540      1280.00
      39.903     0.999316      2495789      1462.86
      40.543     0.999414      2496021      1706.67
      41.183     0.999512      2496271      2048.00
      41.503     0.999561      2496397      2275.56
      41.791     0.999609      2496511      2560.00
      42.111     0.999658      2496641      2925.71
      42.431     0.999707      2496760      3413.33
      42.751     0.999756      2496879      4096.00
      42.943     0.999780      2496940      4551.11
      43.103     0.999805      2497000      5120.00
      43.295     0.999829      2497067      5851.43
      43.455     0.999854      2497125      6826.67
      43.615     0.999878      2497178      8192.00
      43.711     0.999890      2497209      9102.22
      43.839     0.999902      2497240     10240.00
      43.999     0.999915      2497273     11702.86
      44.127     0.999927      2497301     13653.33
      44.287     0.999939      2497336     16384.00
      44.351     0.999945      2497346     18204.44
      44.479     0.999951      2497364     20480.00
      44.575     0.999957      2497377     23405.71
      44.735     0.999963      2497394     27306.67
      44.863     0.999969      2497407     32768.00
      44.991     0.999973      2497415     36408.89
      45.119     0.999976      2497422     40960.00
      45.247     0.999979      2497429     46811.43
      45.407     0.999982      2497437     54613.33
      45.503     0.999985      2497445     65536.00
      45.631     0.999986      2497450     72817.78
      45.663     0.999988      2497452     81920.00
      45.791     0.999989      2497456     93622.86
      45.855     0.999991      2497460    109226.67
      45.951     0.999992      2497464    131072.00
      45.983     0.999993      2497465    145635.56
      46.047     0.999994      2497468    163840.00
      46.111     0.999995      2497469    187245.71
      46.143     0.999995      2497471    218453.33
      46.239     0.999996      2497473    262144.00
      46.303     0.999997      2497475    291271.11
      46.303     0.999997      2497475    327680.00
      46.335     0.999997      2497476    374491.43
      46.367     0.999998      2497477    436906.67
      46.399     0.999998      2497479    524288.00
      46.399     0.999998      2497479    582542.22
      46.399     0.999998      2497479    655360.00
      46.399     0.999999      2497479    748982.86
      46.431     0.999999      2497480    873813.33
      46.431     0.999999      2497480   1048576.00
      46.431     0.999999      2497480   1165084.44
      46.463     0.999999      2497482   1310720.00
      46.463     1.000000      2497482          inf
#[Mean    =        1.407, StdDeviation   =        2.042]
#[Max     =       46.432, Total count    =      2497482]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  2998811 requests in 1.00m, 191.30MB read
Requests/sec:  49979.88
Transfer/sec:      3.19MB
```

CPU
![img_5.png](img_5.png)
ALLOC
![img_6.png](img_6.png)
LOCK
![img_7.png](img_7.png)


Как мы видим в синхронной реализации запросы обрабатываются с использованием Selectors: \
Handle request, send response и в целом обработка запроса занимают 67% CPU, при этом оставшиеся 33% CPU - 
это метод SelectorImpl.lockAndDoSelect, забирающий из
очереди запросов следующий запрос. \
Соответственно видим проблему запросы стоят в очереди, постараемся решить ее с помощью 
добавления асинхронности в наш Service.


### Асинхронная реализация

Добавим в нашу реализацию ThreadPoll.

Параметры для ThreadPoolExecutor:

Размер пула потоков зависит от типа задачи и характеристик системы: \
Тестирование проводится на MacBook Pro (16-inch, 2019) Procesor 2,6 GHz 6-Core Intel Core i7 \
Если пул потоков слишком велик, большое количество потоков будет конкурировать за относительно меньший объем процессора и
ограниченные ресурсы памяти, что не только повлияет на производительность, но и приведет к чрезмерному потреблению памяти.
Слишком маленький пул потоков приведет к неполному использованию процессора.

![img.png](img.png)
![img_1.png](img_1.png)

Источник: [Java Concurrency In Practice, section 8.2 Sizing Thread Pools.](https://www.amazon.com/dp/0321349601)

CorePoolSize = N_cpu * U_cpu * (1 + W / С). \
Так как у нас много взаимодействия с диском,
рекомендуется брать U_cpu * (1 + W / С) примерно равное 2. Поэтому
CorePoolSize = Runtime.getRuntime().availableProcessors() * 2


Определившись с выбором размера пулла, посмотрим на нагрузочное тестирование нашей асинхронной реализации.

#PUT Queue_size = 128

```
wrk2 -t 6 -c 64 -d 60s -R 50000 -s requests-wrk/put-requests.lua --latency http://localhost:42342
Running 1m test @ http://localhost:42342
  6 threads and 64 connections
  Thread calibration: mean lat.: 2.212ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 2.322ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 2.300ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 2.264ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 2.263ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 2.253ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.50ms    2.99ms  75.01ms   99.17%
    Req/Sec     8.79k   713.44    15.33k    78.07%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.25ms
 75.000%    1.70ms
 90.000%    2.12ms
 99.000%    3.61ms
 99.900%   54.88ms
 99.990%   67.71ms
 99.999%   72.51ms
100.000%   75.07ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.047     0.000000            1         1.00
       0.573     0.100000       250779         1.11
       0.763     0.200000       500767         1.25
       0.928     0.300000       749941         1.43
       1.088     0.400000       999064         1.67
       1.249     0.500000      1250260         2.00
       1.330     0.550000      1373612         2.22
       1.415     0.600000      1499530         2.50
       1.503     0.650000      1624573         2.86
       1.595     0.700000      1748752         3.33
       1.695     0.750000      1873170         4.00
       1.750     0.775000      1936464         4.44
       1.808     0.800000      1998079         5.00
       1.872     0.825000      2060848         5.71
       1.943     0.850000      2123248         6.67
       2.024     0.875000      2185284         8.00
       2.071     0.887500      2216980         8.89
       2.121     0.900000      2247964        10.00
       2.179     0.912500      2279909        11.43
       2.243     0.925000      2310999        13.33
       2.317     0.937500      2341757        16.00
       2.361     0.943750      2357408        17.78
       2.409     0.950000      2372958        20.00
       2.465     0.956250      2388692        22.86
       2.529     0.962500      2404256        26.67
       2.605     0.968750      2419473        32.00
       2.651     0.971875      2427308        35.56
       2.705     0.975000      2435179        40.00
       2.767     0.978125      2442881        45.71
       2.845     0.981250      2450666        53.33
       2.951     0.984375      2458470        64.00
       3.027     0.985938      2462412        71.11
       3.133     0.987500      2466263        80.00
       3.339     0.989062      2470148        91.43
       3.875     0.990625      2474043       106.67
       4.903     0.992188      2477934       128.00
       5.643     0.992969      2479891       142.22
       6.551     0.993750      2481838       160.00
       7.819     0.994531      2483786       182.86
      15.143     0.995313      2485737       213.33
      24.527     0.996094      2487692       256.00
      27.311     0.996484      2488663       284.44
      30.895     0.996875      2489639       320.00
      37.023     0.997266      2490615       365.71
      42.879     0.997656      2491592       426.67
      46.847     0.998047      2492566       512.00
      48.447     0.998242      2493062       568.89
      49.919     0.998437      2493549       640.00
      51.423     0.998633      2494030       731.43
      53.183     0.998828      2494518       853.33
      55.167     0.999023      2495014      1024.00
      56.223     0.999121      2495248      1137.78
      57.407     0.999219      2495497      1280.00
      58.495     0.999316      2495737      1462.86
      59.679     0.999414      2495981      1706.67
      60.799     0.999512      2496228      2048.00
      61.407     0.999561      2496350      2275.56
      61.983     0.999609      2496468      2560.00
      62.655     0.999658      2496592      2925.71
      63.359     0.999707      2496717      3413.33
      64.223     0.999756      2496840      4096.00
      64.607     0.999780      2496895      4551.11
      65.119     0.999805      2496956      5120.00
      65.663     0.999829      2497019      5851.43
      66.303     0.999854      2497079      6826.67
      67.071     0.999878      2497141      8192.00
      67.391     0.999890      2497171      9102.22
      67.839     0.999902      2497202     10240.00
      68.287     0.999915      2497233     11702.86
      68.735     0.999927      2497264     13653.33
      69.247     0.999939      2497293     16384.00
      69.567     0.999945      2497308     18204.44
      69.887     0.999951      2497322     20480.00
      70.207     0.999957      2497339     23405.71
      70.527     0.999963      2497353     27306.67
      70.847     0.999969      2497367     32768.00
      71.103     0.999973      2497376     36408.89
      71.359     0.999976      2497385     40960.00
      71.487     0.999979      2497390     46811.43
      71.807     0.999982      2497400     54613.33
      72.063     0.999985      2497406     65536.00
      72.127     0.999986      2497410     72817.78
      72.383     0.999988      2497414     81920.00
      72.447     0.999989      2497417     93622.86
      72.767     0.999991      2497422    109226.67
      72.895     0.999992      2497424    131072.00
      73.023     0.999993      2497426    145635.56
      73.087     0.999994      2497428    163840.00
      73.215     0.999995      2497430    187245.71
      73.407     0.999995      2497433    218453.33
      73.471     0.999996      2497434    262144.00
      73.599     0.999997      2497435    291271.11
      73.663     0.999997      2497436    327680.00
      73.791     0.999997      2497437    374491.43
      73.919     0.999998      2497438    436906.67
      73.983     0.999998      2497439    524288.00
      73.983     0.999998      2497439    582542.22
      74.303     0.999998      2497441    655360.00
      74.303     0.999999      2497441    748982.86
      74.303     0.999999      2497441    873813.33
      74.303     0.999999      2497441   1048576.00
      74.303     0.999999      2497441   1165084.44
      74.623     0.999999      2497442   1310720.00
      74.623     0.999999      2497442   1497965.71
      74.623     0.999999      2497442   1747626.67
      74.623     1.000000      2497442   2097152.00
      74.623     1.000000      2497442   2330168.89
      75.071     1.000000      2497443   2621440.00
      75.071     1.000000      2497443          inf
#[Mean    =        1.505, StdDeviation   =        2.994]
#[Max     =       75.008, Total count    =      2497443]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  2998780 requests in 1.00m, 191.61MB read
Requests/sec:  49980.35
Transfer/sec:      3.19MB
```

CPU
![img_9.png](img_9.png)
ALLOC
![img_8.png](img_8.png)
LOCK
![img_10.png](img_10.png)

#GET Queue_size = 128

```
wrk2 -t 6 -c 64 -d 60s -R 50000 -s requests-wrk/get-requests.lua --latency http://localhost:42342
Running 1m test @ http://localhost:42342
  6 threads and 64 connections
  Thread calibration: mean lat.: 15.313ms, rate sampling interval: 87ms
  Thread calibration: mean lat.: 14.938ms, rate sampling interval: 84ms
  Thread calibration: mean lat.: 14.619ms, rate sampling interval: 81ms
  Thread calibration: mean lat.: 15.165ms, rate sampling interval: 84ms
  Thread calibration: mean lat.: 14.685ms, rate sampling interval: 76ms
  Thread calibration: mean lat.: 13.939ms, rate sampling interval: 78ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.71ms    3.57ms  78.40ms   97.81%
    Req/Sec     8.39k   345.05    13.34k    96.95%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.27ms
 75.000%    1.72ms
 90.000%    2.18ms
 99.000%   14.25ms
 99.900%   57.82ms
 99.990%   72.96ms
 99.999%   76.67ms
100.000%   78.46ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.048     0.000000            2         1.00
       0.594     0.100000       250590         1.11
       0.786     0.200000       499927         1.25
       0.953     0.300000       750577         1.43
       1.112     0.400000       999953         1.67
       1.270     0.500000      1248886         2.00
       1.352     0.550000      1374502         2.22
       1.437     0.600000      1499456         2.50
       1.526     0.650000      1624259         2.86
       1.621     0.700000      1749325         3.33
       1.724     0.750000      1874167         4.00
       1.780     0.775000      1935719         4.44
       1.841     0.800000      1998125         5.00
       1.909     0.825000      2061035         5.71
       1.984     0.850000      2122939         6.67
       2.073     0.875000      2186075         8.00
       2.123     0.887500      2216883         8.89
       2.179     0.900000      2248160        10.00
       2.243     0.912500      2279726        11.43
       2.317     0.925000      2310430        13.33
       2.409     0.937500      2341877        16.00
       2.463     0.943750      2357346        17.78
       2.527     0.950000      2372708        20.00
       2.607     0.956250      2388400        22.86
       2.711     0.962500      2403914        26.67
       2.871     0.968750      2419509        32.00
       3.005     0.971875      2427184        35.56
       3.345     0.975000      2434997        40.00
       5.311     0.978125      2442799        45.71
       8.015     0.981250      2450597        53.33
      10.319     0.984375      2458402        64.00
      11.431     0.985938      2462326        71.11
      12.503     0.987500      2466222        80.00
      13.519     0.989062      2470140        91.43
      14.871     0.990625      2474009       106.67
      18.495     0.992188      2477931       128.00
      20.543     0.992969      2479879       142.22
      22.607     0.993750      2481819       160.00
      24.799     0.994531      2483782       182.86
      26.959     0.995313      2485727       213.33
      29.215     0.996094      2487684       256.00
      30.591     0.996484      2488650       284.44
      33.151     0.996875      2489623       320.00
      38.015     0.997266      2490598       365.71
      43.199     0.997656      2491579       426.67
      46.687     0.998047      2492548       512.00
      48.287     0.998242      2493039       568.89
      50.079     0.998437      2493521       640.00
      52.351     0.998633      2494013       731.43
      55.135     0.998828      2494496       853.33
      58.207     0.999023      2494986      1024.00
      59.775     0.999121      2495231      1137.78
      61.215     0.999219      2495471      1280.00
      62.751     0.999316      2495717      1462.86
      64.255     0.999414      2495961      1706.67
      65.855     0.999512      2496208      2048.00
      66.623     0.999561      2496329      2275.56
      67.455     0.999609      2496452      2560.00
      68.287     0.999658      2496579      2925.71
      69.055     0.999707      2496696      3413.33
      69.887     0.999756      2496820      4096.00
      70.335     0.999780      2496885      4551.11
      70.783     0.999805      2496937      5120.00
      71.295     0.999829      2496997      5851.43
      71.807     0.999854      2497059      6826.67
      72.383     0.999878      2497120      8192.00
      72.767     0.999890      2497155      9102.22
      73.023     0.999902      2497185     10240.00
      73.343     0.999915      2497211     11702.86
      73.727     0.999927      2497240     13653.33
      74.175     0.999939      2497272     16384.00
      74.367     0.999945      2497285     18204.44
      74.623     0.999951      2497301     20480.00
      74.943     0.999957      2497318     23405.71
      75.199     0.999963      2497332     27306.67
      75.519     0.999969      2497348     32768.00
      75.711     0.999973      2497356     36408.89
      75.839     0.999976      2497365     40960.00
      75.967     0.999979      2497370     46811.43
      76.223     0.999982      2497379     54613.33
      76.415     0.999985      2497385     65536.00
      76.543     0.999986      2497388     72817.78
      76.607     0.999988      2497392     81920.00
      76.671     0.999989      2497397     93622.86
      76.799     0.999991      2497401    109226.67
      76.927     0.999992      2497403    131072.00
      76.991     0.999993      2497406    145635.56
      77.055     0.999994      2497411    163840.00
      77.055     0.999995      2497411    187245.71
      77.055     0.999995      2497411    218453.33
      77.247     0.999996      2497413    262144.00
      77.311     0.999997      2497414    291271.11
      77.375     0.999997      2497416    327680.00
      77.375     0.999997      2497416    374491.43
      77.503     0.999998      2497417    436906.67
      77.567     0.999998      2497418    524288.00
      77.567     0.999998      2497418    582542.22
      77.759     0.999998      2497419    655360.00
      77.759     0.999999      2497419    748982.86
      77.823     0.999999      2497421    873813.33
      77.823     0.999999      2497421   1048576.00
      77.823     0.999999      2497421   1165084.44
      77.823     0.999999      2497421   1310720.00
      77.823     0.999999      2497421   1497965.71
      77.823     0.999999      2497421   1747626.67
      77.823     1.000000      2497421   2097152.00
      77.823     1.000000      2497421   2330168.89
      78.463     1.000000      2497422   2621440.00
      78.463     1.000000      2497422          inf
#[Mean    =        1.713, StdDeviation   =        3.567]
#[Max     =       78.400, Total count    =      2497422]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  2998741 requests in 1.00m, 191.29MB read
Requests/sec:  49979.38
Transfer/sec:      3.19MB
```

CPU
![img_12.png](img_12.png)
ALLOC
![img_11.png](img_11.png)
LOCK
![img_13.png](img_13.png)


Заметим, что у нас вырос Requests/sec для PUT \
При синхронной реализации 49843.68 \
При асинхронной реализации 49980.35

Requests/sec практически для GET почти не изменился \
При синхронной реализации 49979.88 \
При асинхронной реализации 49979.38

Однако Latency при PUT запросах практически не изменилась \
Для синхронной реализации \
Mean    =        1.642 \
Max     =       94.464 \
Для асинхронной реализации \
Mean    =        1.505 \
Max     =       75.008 \
В то же Latency на GET выросло: \
Для синхронной реализации \
Mean    =        1.407 \
Max     =       46.432 \

Для асинхронной реализации \
Mean    =        1.713 \
Max     =       78.400, \

Рассмотрим основную информацию о нашем сервисе:

Основная часть ресурсов уходит на блокировки. Для полученной асинхронной реализации видно, что для на 
ThreadPollExecutor ArrayBlockingQueue.take приходится почти 66% lock и 22% CPU. Доля метода SelectorImpl.lockAndDoSelect 
снизилась до 22% CPU по сравнению с 34% для синхронной реализации. При этом lock берется на ThreadPollExecutor ArrayBlockingQueue.offer
и занимает 32% всего lock.

В отличие от синхронной реализации heatmap для lock стала намного более насыщенной, что логично ведь добавив ThreadPoll,
мы увеличили число переключений между потоками, а значит и блокировок.

Попробуем уменьшить процент блокировок и повысить производительность за счет увеличения очереди увеличить размер очереди:

#PUT Queue_size = 512

```
Running 1m test @ http://localhost:42342
  6 threads and 64 connections
  Thread calibration: mean lat.: 5.181ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 5.507ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 6.232ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 5.383ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 5.331ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 4.350ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     8.62ms   24.02ms 214.66ms   91.82%
    Req/Sec     8.86k     1.82k   31.10k    90.19%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.41ms
 75.000%    2.05ms
 90.000%   19.39ms
 99.000%  126.33ms
 99.900%  172.16ms
 99.990%  194.18ms
 99.999%  211.71ms
100.000%  214.78ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.044     0.000000            1         1.00
       0.630     0.100000       249805         1.11
       0.845     0.200000       499621         1.25
       1.033     0.300000       748351         1.43
       1.218     0.400000       997818         1.67
       1.409     0.500000      1247305         2.00
       1.511     0.550000      1371959         2.22
       1.620     0.600000      1497344         2.50
       1.740     0.650000      1622132         2.86
       1.878     0.700000      1746431         3.33
       2.053     0.750000      1870897         4.00
       2.167     0.775000      1932971         4.44
       2.313     0.800000      1995449         5.00
       2.527     0.825000      2057725         5.71
       3.017     0.850000      2120090         6.67
       8.303     0.875000      2182346         8.00
      13.455     0.887500      2213529         8.89
      19.391     0.900000      2244753        10.00
      27.759     0.912500      2275877        11.43
      38.623     0.925000      2307070        13.33
      50.527     0.937500      2338243        16.00
      56.895     0.943750      2353792        17.78
      63.263     0.950000      2369409        20.00
      70.079     0.956250      2385116        22.86
      77.311     0.962500      2400646        26.67
      85.823     0.968750      2416237        32.00
      90.175     0.971875      2423980        35.56
      94.783     0.975000      2431792        40.00
     100.031     0.978125      2439583        45.71
     106.431     0.981250      2447354        53.33
     112.831     0.984375      2455123        64.00
     116.287     0.985938      2459017        71.11
     119.999     0.987500      2462905        80.00
     123.647     0.989062      2466830        91.43
     128.447     0.990625      2470703       106.67
     134.271     0.992188      2474621       128.00
     137.471     0.992969      2476563       142.22
     140.415     0.993750      2478530       160.00
     143.743     0.994531      2480481       182.86
     146.815     0.995313      2482412       213.33
     150.911     0.996094      2484337       256.00
     153.215     0.996484      2485362       284.44
     155.391     0.996875      2486293       320.00
     157.823     0.997266      2487315       365.71
     160.255     0.997656      2488285       426.67
     163.071     0.998047      2489227       512.00
     164.735     0.998242      2489722       568.89
     166.399     0.998437      2490182       640.00
     168.319     0.998633      2490688       731.43
     170.111     0.998828      2491165       853.33
     172.543     0.999023      2491673      1024.00
     173.695     0.999121      2491904      1137.78
     174.975     0.999219      2492130      1280.00
     176.511     0.999316      2492381      1462.86
     178.047     0.999414      2492617      1706.67
     179.711     0.999512      2492875      2048.00
     180.607     0.999561      2492994      2275.56
     181.503     0.999609      2493114      2560.00
     182.911     0.999658      2493240      2925.71
     184.319     0.999707      2493358      3413.33
     185.983     0.999756      2493471      4096.00
     186.623     0.999780      2493530      4551.11
     187.647     0.999805      2493594      5120.00
     188.671     0.999829      2493656      5851.43
     190.463     0.999854      2493715      6826.67
     192.127     0.999878      2493774      8192.00
     193.151     0.999890      2493805      9102.22
     194.303     0.999902      2493836     10240.00
     195.199     0.999915      2493869     11702.86
     195.967     0.999927      2493900     13653.33
     196.479     0.999939      2493928     16384.00
     196.991     0.999945      2493942     18204.44
     197.631     0.999951      2493960     20480.00
     198.911     0.999957      2493972     23405.71
     200.191     0.999963      2493987     27306.67
     201.215     0.999969      2494003     32768.00
     203.647     0.999973      2494010     36408.89
     206.079     0.999976      2494018     40960.00
     208.511     0.999979      2494025     46811.43
     209.407     0.999982      2494034     54613.33
     209.919     0.999985      2494041     65536.00
     210.047     0.999986      2494045     72817.78
     210.943     0.999988      2494049     81920.00
     211.199     0.999989      2494052     93622.86
     212.223     0.999991      2494056    109226.67
     212.479     0.999992      2494060    131072.00
     212.607     0.999993      2494061    145635.56
     212.863     0.999994      2494063    163840.00
     213.119     0.999995      2494066    187245.71
     213.247     0.999995      2494068    218453.33
     213.375     0.999996      2494071    262144.00
     213.375     0.999997      2494071    291271.11
     213.375     0.999997      2494071    327680.00
     213.503     0.999997      2494073    374491.43
     213.503     0.999998      2494073    436906.67
     213.631     0.999998      2494075    524288.00
     213.631     0.999998      2494075    582542.22
     213.631     0.999998      2494075    655360.00
     213.631     0.999999      2494075    748982.86
     213.759     0.999999      2494076    873813.33
     213.759     0.999999      2494076   1048576.00
     213.759     0.999999      2494076   1165084.44
     214.143     0.999999      2494077   1310720.00
     214.143     0.999999      2494077   1497965.71
     214.143     0.999999      2494077   1747626.67
     214.143     1.000000      2494077   2097152.00
     214.143     1.000000      2494077   2330168.89
     214.783     1.000000      2494078   2621440.00
     214.783     1.000000      2494078          inf
#[Mean    =        8.623, StdDeviation   =       24.021]
#[Max     =      214.656, Total count    =      2494078]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  2995425 requests in 1.00m, 191.40MB read
Requests/sec:  49924.28
Transfer/sec:      3.19MB
```

#GET Queue_size = 512

```
Running 1m test @ http://localhost:42342
  6 threads and 64 connections
  Thread calibration: mean lat.: 1.298ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.300ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.300ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.304ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.300ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.325ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     2.14ms    7.63ms 160.90ms   98.23%
    Req/Sec     8.80k     0.86k   19.78k    81.63%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.27ms
 75.000%    1.72ms
 90.000%    2.19ms
 99.000%   28.98ms
 99.900%  121.09ms
 99.990%  145.66ms
 99.999%  155.13ms
100.000%  161.02ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.050     0.000000            1         1.00
       0.584     0.100000       250698         1.11
       0.776     0.200000       500200         1.25
       0.943     0.300000       749786         1.43
       1.104     0.400000       999021         1.67
       1.266     0.500000      1249049         2.00
       1.349     0.550000      1374507         2.22
       1.435     0.600000      1499661         2.50
       1.525     0.650000      1624699         2.86
       1.620     0.700000      1748966         3.33
       1.724     0.750000      1873389         4.00
       1.781     0.775000      1936133         4.44
       1.843     0.800000      1998421         5.00
       1.911     0.825000      2060588         5.71
       1.988     0.850000      2122994         6.67
       2.079     0.875000      2185877         8.00
       2.131     0.887500      2217114         8.89
       2.189     0.900000      2248041        10.00
       2.255     0.912500      2279188        11.43
       2.333     0.925000      2310260        13.33
       2.431     0.937500      2341622        16.00
       2.491     0.943750      2357178        17.78
       2.563     0.950000      2372597        20.00
       2.655     0.956250      2388340        22.86
       2.781     0.962500      2403875        26.67
       3.007     0.968750      2419432        32.00
       3.317     0.971875      2427217        35.56
       4.467     0.975000      2435033        40.00
       6.023     0.978125      2442823        45.71
       8.375     0.981250      2450634        53.33
      13.743     0.984375      2458436        64.00
      16.351     0.985938      2462337        71.11
      19.343     0.987500      2466245        80.00
      25.039     0.989062      2470137        91.43
      31.983     0.990625      2474039       106.67
      39.775     0.992188      2477945       128.00
      44.479     0.992969      2479893       142.22
      49.823     0.993750      2481844       160.00
      56.959     0.994531      2483801       182.86
      64.351     0.995313      2485747       213.33
      72.383     0.996094      2487701       256.00
      76.799     0.996484      2488676       284.44
      81.471     0.996875      2489655       320.00
      85.951     0.997266      2490628       365.71
      91.711     0.997656      2491600       426.67
      99.071     0.998047      2492581       512.00
     103.423     0.998242      2493069       568.89
     107.775     0.998437      2493549       640.00
     112.319     0.998633      2494037       731.43
     116.991     0.998828      2494532       853.33
     121.599     0.999023      2495015      1024.00
     123.775     0.999121      2495256      1137.78
     125.887     0.999219      2495501      1280.00
     128.127     0.999316      2495744      1462.86
     130.431     0.999414      2495992      1706.67
     132.735     0.999512      2496232      2048.00
     134.015     0.999561      2496357      2275.56
     135.167     0.999609      2496476      2560.00
     136.447     0.999658      2496611      2925.71
     137.727     0.999707      2496726      3413.33
     139.263     0.999756      2496848      4096.00
     140.031     0.999780      2496909      4551.11
     140.799     0.999805      2496968      5120.00
     141.823     0.999829      2497030      5851.43
     142.847     0.999854      2497091      6826.67
     144.255     0.999878      2497148      8192.00
     145.023     0.999890      2497178      9102.22
     145.791     0.999902      2497212     10240.00
     146.431     0.999915      2497241     11702.86
     147.327     0.999927      2497270     13653.33
     148.223     0.999939      2497305     16384.00
     148.607     0.999945      2497317     18204.44
     149.247     0.999951      2497331     20480.00
     149.759     0.999957      2497345     23405.71
     150.271     0.999963      2497360     27306.67
     150.783     0.999969      2497377     32768.00
     151.167     0.999973      2497383     36408.89
     151.935     0.999976      2497391     40960.00
     152.447     0.999979      2497398     46811.43
     153.215     0.999982      2497406     54613.33
     153.471     0.999985      2497413     65536.00
     153.855     0.999986      2497419     72817.78
     153.983     0.999988      2497421     81920.00
     155.135     0.999989      2497427     93622.86
     155.519     0.999991      2497429    109226.67
     155.903     0.999992      2497433    131072.00
     156.159     0.999993      2497434    145635.56
     156.671     0.999994      2497436    163840.00
     157.055     0.999995      2497439    187245.71
     157.183     0.999995      2497440    218453.33
     157.951     0.999996      2497442    262144.00
     158.335     0.999997      2497443    291271.11
     158.847     0.999997      2497444    327680.00
     159.615     0.999997      2497445    374491.43
     159.871     0.999998      2497446    436906.67
     160.255     0.999998      2497447    524288.00
     160.255     0.999998      2497447    582542.22
     160.511     0.999998      2497448    655360.00
     160.511     0.999999      2497448    748982.86
     160.639     0.999999      2497450    873813.33
     160.639     0.999999      2497450   1048576.00
     160.639     0.999999      2497450   1165084.44
     160.639     0.999999      2497450   1310720.00
     160.639     0.999999      2497450   1497965.71
     160.639     0.999999      2497450   1747626.67
     160.639     1.000000      2497450   2097152.00
     160.639     1.000000      2497450   2330168.89
     161.023     1.000000      2497451   2621440.00
     161.023     1.000000      2497451          inf
#[Mean    =        2.141, StdDeviation   =        7.626]
#[Max     =      160.896, Total count    =      2497451]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  2998781 requests in 1.00m, 191.29MB read
Requests/sec:  49979.81
Transfer/sec:      3.19MB

```


При увеличении размера очереди увеличилось latency запросов для Get на 23%. Для PUT в 5 раз.
При этом распределение ресурсов CPU, ALLOC и не поменялось.
Видим, что время взаимодействия с Selectors queue выросло, что говорит о том, что service не может эффективно 
распределить ресурсы.

Попробуем уменьшить размер очереди выберем размер равный числу соединений:

#PUT Queue_size = 64

```
Running 1m test @ http://localhost:42342
  6 threads and 64 connections
  Thread calibration: mean lat.: 2.266ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 2.340ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 2.247ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 2.282ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 2.310ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 2.330ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.57ms    3.68ms  87.55ms   99.25%
    Req/Sec     8.79k   727.37    25.30k    76.76%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.26ms
 75.000%    1.71ms
 90.000%    2.14ms
 99.000%    3.54ms
 99.900%   65.54ms
 99.990%   78.85ms
 99.999%   84.42ms
100.000%   87.61ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.044     0.000000            1         1.00
       0.575     0.100000       249870         1.11
       0.767     0.200000       500603         1.25
       0.934     0.300000       749756         1.43
       1.095     0.400000       999963         1.67
       1.257     0.500000      1250207         2.00
       1.339     0.550000      1374181         2.22
       1.424     0.600000      1499062         2.50
       1.512     0.650000      1623362         2.86
       1.606     0.700000      1748682         3.33
       1.707     0.750000      1873246         4.00
       1.762     0.775000      1935778         4.44
       1.821     0.800000      1998429         5.00
       1.885     0.825000      2061034         5.71
       1.957     0.850000      2123478         6.67
       2.039     0.875000      2185418         8.00
       2.087     0.887500      2217617         8.89
       2.137     0.900000      2247850        10.00
       2.195     0.912500      2279177        11.43
       2.261     0.925000      2310438        13.33
       2.337     0.937500      2341425        16.00
       2.381     0.943750      2357360        17.78
       2.431     0.950000      2373177        20.00
       2.485     0.956250      2388239        22.86
       2.551     0.962500      2404129        26.67
       2.629     0.968750      2419555        32.00
       2.675     0.971875      2427252        35.56
       2.729     0.975000      2435190        40.00
       2.791     0.978125      2442911        45.71
       2.867     0.981250      2450677        53.33
       2.971     0.984375      2458517        64.00
       3.043     0.985938      2462390        71.11
       3.145     0.987500      2466254        80.00
       3.325     0.989062      2470162        91.43
       3.783     0.990625      2474042       106.67
       4.887     0.992188      2477947       128.00
       5.811     0.992969      2479896       142.22
       7.067     0.993750      2481851       160.00
      13.463     0.994531      2483797       182.86
      23.151     0.995313      2485749       213.33
      31.951     0.996094      2487699       256.00
      37.951     0.996484      2488676       284.44
      43.551     0.996875      2489656       320.00
      48.607     0.997266      2490629       365.71
      52.863     0.997656      2491601       426.67
      56.703     0.998047      2492578       512.00
      58.495     0.998242      2493071       568.89
      60.287     0.998437      2493561       640.00
      62.047     0.998633      2494044       731.43
      63.839     0.998828      2494531       853.33
      65.727     0.999023      2495019      1024.00
      66.751     0.999121      2495274      1137.78
      67.903     0.999219      2495509      1280.00
      69.183     0.999316      2495753      1462.86
      70.527     0.999414      2495992      1706.67
      71.935     0.999512      2496246      2048.00
      72.575     0.999561      2496363      2275.56
      73.279     0.999609      2496484      2560.00
      74.047     0.999658      2496603      2925.71
      74.751     0.999707      2496727      3413.33
      75.519     0.999756      2496852      4096.00
      76.031     0.999780      2496914      4551.11
      76.479     0.999805      2496975      5120.00
      76.991     0.999829      2497028      5851.43
      77.567     0.999854      2497090      6826.67
      78.207     0.999878      2497151      8192.00
      78.527     0.999890      2497181      9102.22
      78.975     0.999902      2497214     10240.00
      79.423     0.999915      2497242     11702.86
      79.871     0.999927      2497274     13653.33
      80.511     0.999939      2497304     16384.00
      80.767     0.999945      2497317     18204.44
      81.151     0.999951      2497336     20480.00
      81.535     0.999957      2497348     23405.71
      82.047     0.999963      2497363     27306.67
      82.367     0.999969      2497378     32768.00
      82.687     0.999973      2497388     36408.89
      82.943     0.999976      2497395     40960.00
      83.135     0.999979      2497401     46811.43
      83.583     0.999982      2497411     54613.33
      83.903     0.999985      2497416     65536.00
      83.967     0.999986      2497420     72817.78
      84.095     0.999988      2497424     81920.00
      84.351     0.999989      2497428     93622.86
      84.543     0.999991      2497433    109226.67
      84.735     0.999992      2497435    131072.00
      84.927     0.999993      2497437    145635.56
      85.055     0.999994      2497440    163840.00
      85.119     0.999995      2497441    187245.71
      85.375     0.999995      2497443    218453.33
      85.631     0.999996      2497446    262144.00
      85.631     0.999997      2497446    291271.11
      86.143     0.999997      2497447    327680.00
      86.271     0.999997      2497448    374491.43
      86.335     0.999998      2497449    436906.67
      86.975     0.999998      2497450    524288.00
      86.975     0.999998      2497450    582542.22
      87.103     0.999998      2497451    655360.00
      87.103     0.999999      2497451    748982.86
      87.359     0.999999      2497452    873813.33
      87.359     0.999999      2497452   1048576.00
      87.359     0.999999      2497452   1165084.44
      87.487     0.999999      2497453   1310720.00
      87.487     0.999999      2497453   1497965.71
      87.487     0.999999      2497453   1747626.67
      87.487     1.000000      2497453   2097152.00
      87.487     1.000000      2497453   2330168.89
      87.615     1.000000      2497454   2621440.00
      87.615     1.000000      2497454          inf
#[Mean    =        1.569, StdDeviation   =        3.677]
#[Max     =       87.552, Total count    =      2497454]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  2998797 requests in 1.00m, 191.61MB read
Requests/sec:  49980.96
Transfer/sec:      3.19MB

```

#GET Queue_size = 64

```
Running 1m test @ http://localhost:42342
  6 threads and 64 connections
  Thread calibration: mean lat.: 1.309ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.301ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.311ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.310ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.305ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.306ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.44ms    1.65ms  51.14ms   98.10%
    Req/Sec     8.79k   761.12    15.60k    78.04%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.27ms
 75.000%    1.72ms
 90.000%    2.16ms
 99.000%    5.06ms
 99.900%   28.25ms
 99.990%   46.11ms
 99.999%   49.89ms
100.000%   51.17ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.047     0.000000            1         1.00
       0.593     0.100000       250127         1.11
       0.784     0.200000       499655         1.25
       0.950     0.300000       749284         1.43
       1.109     0.400000       999297         1.67
       1.269     0.500000      1249500         2.00
       1.351     0.550000      1374309         2.22
       1.436     0.600000      1498808         2.50
       1.525     0.650000      1624293         2.86
       1.619     0.700000      1749308         3.33
       1.720     0.750000      1873692         4.00
       1.775     0.775000      1936025         4.44
       1.835     0.800000      1998824         5.00
       1.900     0.825000      2060661         5.71
       1.973     0.850000      2122962         6.67
       2.057     0.875000      2185459         8.00
       2.105     0.887500      2216875         8.89
       2.157     0.900000      2247718        10.00
       2.217     0.912500      2279165        11.43
       2.285     0.925000      2310351        13.33
       2.367     0.937500      2341886        16.00
       2.413     0.943750      2357017        17.78
       2.467     0.950000      2372762        20.00
       2.531     0.956250      2388551        22.86
       2.607     0.962500      2404114        26.67
       2.705     0.968750      2419584        32.00
       2.769     0.971875      2427424        35.56
       2.845     0.975000      2435084        40.00
       2.949     0.978125      2442905        45.71
       3.115     0.981250      2450697        53.33
       3.501     0.984375      2458449        64.00
       3.863     0.985938      2462353        71.11
       4.283     0.987500      2466255        80.00
       4.751     0.989062      2470156        91.43
       5.279     0.990625      2474078       106.67
       5.955     0.992188      2477957       128.00
       6.415     0.992969      2479912       142.22
       7.047     0.993750      2481856       160.00
       7.887     0.994531      2483805       182.86
       9.479     0.995313      2485756       213.33
      11.455     0.996094      2487714       256.00
      12.663     0.996484      2488686       284.44
      14.375     0.996875      2489658       320.00
      16.511     0.997266      2490639       365.71
      18.207     0.997656      2491621       426.67
      19.519     0.998047      2492591       512.00
      20.271     0.998242      2493080       568.89
      21.151     0.998437      2493562       640.00
      23.007     0.998633      2494051       731.43
      25.055     0.998828      2494537       853.33
      28.799     0.999023      2495025      1024.00
      30.415     0.999121      2495267      1137.78
      32.015     0.999219      2495512      1280.00
      33.375     0.999316      2495761      1462.86
      34.687     0.999414      2496007      1706.67
      35.967     0.999512      2496243      2048.00
      36.799     0.999561      2496366      2275.56
      37.727     0.999609      2496488      2560.00
      38.719     0.999658      2496613      2925.71
      39.775     0.999707      2496731      3413.33
      40.991     0.999756      2496855      4096.00
      41.663     0.999780      2496915      4551.11
      42.495     0.999805      2496976      5120.00
      43.519     0.999829      2497040      5851.43
      44.511     0.999854      2497098      6826.67
      45.311     0.999878      2497158      8192.00
      45.727     0.999890      2497188      9102.22
      46.239     0.999902      2497222     10240.00
      46.943     0.999915      2497252     11702.86
      47.359     0.999927      2497280     13653.33
      47.775     0.999939      2497312     16384.00
      47.967     0.999945      2497327     18204.44
      48.127     0.999951      2497342     20480.00
      48.415     0.999957      2497358     23405.71
      48.671     0.999963      2497372     27306.67
      48.831     0.999969      2497387     32768.00
      48.991     0.999973      2497394     36408.89
      49.151     0.999976      2497406     40960.00
      49.247     0.999979      2497409     46811.43
      49.375     0.999982      2497417     54613.33
      49.503     0.999985      2497424     65536.00
      49.599     0.999986      2497428     72817.78
      49.791     0.999988      2497432     81920.00
      49.855     0.999989      2497436     93622.86
      49.951     0.999991      2497440    109226.67
      50.111     0.999992      2497443    131072.00
      50.143     0.999993      2497447    145635.56
      50.143     0.999994      2497447    163840.00
      50.239     0.999995      2497451    187245.71
      50.239     0.999995      2497451    218453.33
      50.303     0.999996      2497454    262144.00
      50.303     0.999997      2497454    291271.11
      50.367     0.999997      2497455    327680.00
      50.495     0.999997      2497456    374491.43
      50.559     0.999998      2497457    436906.67
      50.687     0.999998      2497459    524288.00
      50.687     0.999998      2497459    582542.22
      50.687     0.999998      2497459    655360.00
      50.687     0.999999      2497459    748982.86
      50.815     0.999999      2497460    873813.33
      50.815     0.999999      2497460   1048576.00
      50.815     0.999999      2497460   1165084.44
      50.879     0.999999      2497461   1310720.00
      50.879     0.999999      2497461   1497965.71
      50.879     0.999999      2497461   1747626.67
      50.879     1.000000      2497461   2097152.00
      50.879     1.000000      2497461   2330168.89
      51.167     1.000000      2497462   2621440.00
      51.167     1.000000      2497462          inf
#[Mean    =        1.444, StdDeviation   =        1.651]
#[Max     =       51.136, Total count    =      2497462]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  2998804 requests in 1.00m, 191.29MB read
Requests/sec:  49980.12
Transfer/sec:      3.19MB

```

Как можем заметить среднее Latency уменьшилось для PUT запросов на 15%, для GET на 18%.
Мы можем также пронаблюдать это на графиках CPU и lock и заметить сокращение работы с Selectors
разгрузка за счет увеличения процента lock в ThreadPollExecutor, а также увеличением процента ServiceImpl в CPU.
При этом Requests/sec практически не изменился.

Протестируем высокую нагрузку rate=75000

Ассинхронный:
```
wrk2 -t 6 -c 64 -d 60s -R 75000 -s requests-wrk/put-requests.lua -L http://localhost:42342
    Running 1m test @ http://localhost:42342
  6 threads and 64 connections
  Thread calibration: mean lat.: 122.378ms, rate sampling interval: 616ms
  Thread calibration: mean lat.: 128.516ms, rate sampling interval: 643ms
  Thread calibration: mean lat.: 123.803ms, rate sampling interval: 625ms
  Thread calibration: mean lat.: 127.729ms, rate sampling interval: 641ms
  Thread calibration: mean lat.: 122.102ms, rate sampling interval: 617ms
  Thread calibration: mean lat.: 127.103ms, rate sampling interval: 631ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency    40.44ms   70.50ms 321.02ms   86.34%
    Req/Sec    12.52k   538.86    13.95k    81.61%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    2.61ms
 75.000%   56.13ms
 90.000%  156.54ms
 99.000%  292.86ms
 99.900%  309.76ms
 99.990%  317.95ms
 99.999%  321.02ms
100.000%  321.28ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.056     0.000000            1         1.00
       0.935     0.100000       375611         1.11
       1.260     0.200000       749859         1.25
       1.587     0.300000      1125335         1.43
       1.981     0.400000      1500116         1.67
       2.613     0.500000      1874378         2.00
       3.527     0.550000      2061798         2.22
       7.099     0.600000      2249085         2.50
      11.151     0.650000      2436631         2.86
      40.415     0.700000      2623882         3.33
      56.127     0.750000      2811256         4.00
      59.711     0.775000      2905498         4.44
      65.151     0.800000      2999019         5.00
      76.671     0.825000      3092529         5.71
      95.871     0.850000      3186123         6.67
     121.407     0.875000      3280014         8.00
     131.583     0.887500      3326956         8.89
     156.543     0.900000      3373609        10.00
     172.927     0.912500      3420387        11.43
     185.087     0.925000      3467505        13.33
     200.447     0.937500      3514319        16.00
     208.383     0.943750      3537685        17.78
     216.959     0.950000      3561233        20.00
     225.535     0.956250      3584542        22.86
     233.471     0.962500      3608009        26.67
     242.943     0.968750      3631238        32.00
     250.239     0.971875      3642941        35.56
     260.095     0.975000      3654748        40.00
     269.823     0.978125      3666496        45.71
     277.503     0.981250      3678246        53.33
     284.671     0.984375      3690049        64.00
     287.231     0.985938      3695928        71.11
     289.535     0.987500      3701777        80.00
     291.839     0.989062      3707872        91.43
     293.887     0.990625      3713859       106.67
     295.935     0.992188      3719368       128.00
     297.215     0.992969      3722373       142.22
     298.239     0.993750      3725029       160.00
     299.519     0.994531      3727988       182.86
     300.799     0.995313      3731008       213.33
     302.079     0.996094      3733825       256.00
     302.847     0.996484      3735375       284.44
     303.871     0.996875      3736999       320.00
     304.639     0.997266      3738355       365.71
     305.407     0.997656      3739546       426.67
     306.687     0.998047      3741304       512.00
     307.199     0.998242      3741956       568.89
     307.711     0.998437      3742634       640.00
     308.223     0.998633      3743237       731.43
     308.991     0.998828      3743956       853.33
     309.759     0.999023      3744698      1024.00
     310.271     0.999121      3745176      1137.78
     310.783     0.999219      3745603      1280.00
     311.039     0.999316      3745780      1462.86
     311.807     0.999414      3746263      1706.67
     312.575     0.999512      3746521      2048.00
     313.087     0.999561      3746759      2275.56
     313.343     0.999609      3746875      2560.00
     313.855     0.999658      3747084      2925.71
     314.367     0.999707      3747252      3413.33
     314.879     0.999756      3747413      4096.00
     315.391     0.999780      3747561      4551.11
     315.647     0.999805      3747627      5120.00
     316.159     0.999829      3747704      5851.43
     316.927     0.999854      3747811      6826.67
     317.183     0.999878      3747879      8192.00
     317.439     0.999890      3747920      9102.22
     318.207     0.999902      3747970     10240.00
     318.719     0.999915      3748023     11702.86
     319.231     0.999927      3748078     13653.33
     319.487     0.999939      3748122     16384.00
     319.743     0.999945      3748158     18204.44
     319.743     0.999951      3748158     20480.00
     319.999     0.999957      3748222     23405.71
     319.999     0.999963      3748222     27306.67
     319.999     0.999969      3748222     32768.00
     320.255     0.999973      3748240     36408.89
     320.255     0.999976      3748240     40960.00
     320.511     0.999979      3748254     46811.43
     320.767     0.999982      3748278     54613.33
     320.767     0.999985      3748278     65536.00
     320.767     0.999986      3748278     72817.78
     321.023     0.999988      3748316     81920.00
     321.023     0.999989      3748316     93622.86
     321.023     0.999991      3748316    109226.67
     321.023     0.999992      3748316    131072.00
     321.023     0.999993      3748316    145635.56
     321.023     0.999994      3748316    163840.00
     321.023     0.999995      3748316    187245.71
     321.023     0.999995      3748316    218453.33
     321.023     0.999996      3748316    262144.00
     321.023     0.999997      3748316    291271.11
     321.279     0.999997      3748328    327680.00
     321.279     1.000000      3748328          inf
#[Mean    =       40.438, StdDeviation   =       70.499]
#[Max     =      321.024, Total count    =      3748328]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  4494807 requests in 1.00m, 287.20MB read
Requests/sec:  74914.48
Transfer/sec:      4.79MB
```

Синхронный:

```
   Running 1m test @ http://localhost:42342
  6 threads and 64 connections
  Thread calibration: mean lat.: 1353.361ms, rate sampling interval: 5644ms
  Thread calibration: mean lat.: 1355.525ms, rate sampling interval: 5652ms
  Thread calibration: mean lat.: 1353.529ms, rate sampling interval: 5644ms
  Thread calibration: mean lat.: 1352.889ms, rate sampling interval: 5640ms
  Thread calibration: mean lat.: 1326.447ms, rate sampling interval: 5550ms
  Thread calibration: mean lat.: 1353.571ms, rate sampling interval: 5644ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     6.52s     1.80s    9.93s    67.41%
    Req/Sec    10.73k     2.11k   14.22k    62.50%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    5.82s 
 75.000%    8.44s 
 90.000%    9.53s 
 99.000%    9.81s 
 99.900%    9.90s 
 99.990%    9.93s 
 99.999%    9.94s 
100.000%    9.94s 

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

    3028.991     0.000000            1         1.00
    4886.527     0.100000       331236         1.11
    5148.671     0.200000       664000         1.25
    5357.567     0.300000       995771         1.43
    5627.903     0.400000      1320106         1.67
    5824.511     0.500000      1652143         2.00
    5902.335     0.550000      1816021         2.22
    6004.735     0.600000      1984048         2.50
    6103.039     0.650000      2151692         2.86
    6569.983     0.700000      2308409         3.33
    8437.759     0.750000      2473377         4.00
    8863.743     0.775000      2556210         4.44
    9183.231     0.800000      2639748         5.00
    9297.919     0.825000      2723731         5.71
    9396.223     0.850000      2809861         6.67
    9461.759     0.875000      2886623         8.00
    9494.527     0.887500      2927739         8.89
    9527.295     0.900000      2968162        10.00
    9568.255     0.912500      3019070        11.43
    9592.831     0.925000      3050422        13.33
    9625.599     0.937500      3091489        16.00
    9650.175     0.943750      3120549        17.78
    9666.559     0.950000      3138728        20.00
    9682.943     0.956250      3157906        22.86
    9699.327     0.962500      3175764        26.67
    9723.903     0.968750      3199925        32.00
    9732.095     0.971875      3208085        35.56
    9740.287     0.975000      3216140        40.00
    9756.671     0.978125      3230455        45.71
    9764.863     0.981250      3237050        53.33
    9781.247     0.984375      3249697        64.00
    9789.439     0.985938      3255616        71.11
    9797.631     0.987500      3261108        80.00
    9805.823     0.989062      3266130        91.43
    9814.015     0.990625      3270916       106.67
    9822.207     0.992188      3275079       128.00
    9822.207     0.992969      3275079       142.22
    9830.399     0.993750      3278728       160.00
    9838.591     0.994531      3281676       182.86
    9846.783     0.995313      3284577       213.33
    9846.783     0.996094      3284577       256.00
    9854.975     0.996484      3287116       284.44
    9854.975     0.996875      3287116       320.00
    9863.167     0.997266      3289182       365.71
    9871.359     0.997656      3291069       426.67
    9871.359     0.998047      3291069       512.00
    9879.551     0.998242      3292588       568.89
    9879.551     0.998437      3292588       640.00
    9887.743     0.998633      3293773       731.43
    9887.743     0.998828      3293773       853.33
    9895.935     0.999023      3294706      1024.00
    9895.935     0.999121      3294706      1137.78
    9904.127     0.999219      3295475      1280.00
    9904.127     0.999316      3295475      1462.86
    9904.127     0.999414      3295475      1706.67
    9912.319     0.999512      3296058      2048.00
    9912.319     0.999561      3296058      2275.56
    9912.319     0.999609      3296058      2560.00
    9920.511     0.999658      3296693      2925.71
    9920.511     0.999707      3296693      3413.33
    9920.511     0.999756      3296693      4096.00
    9920.511     0.999780      3296693      4551.11
    9920.511     0.999805      3296693      5120.00
    9928.703     0.999829      3297228      5851.43
    9928.703     0.999854      3297228      6826.67
    9928.703     0.999878      3297228      8192.00
    9928.703     0.999890      3297228      9102.22
    9928.703     0.999902      3297228     10240.00
    9928.703     0.999915      3297228     11702.86
    9928.703     0.999927      3297228     13653.33
    9928.703     0.999939      3297228     16384.00
    9928.703     0.999945      3297228     18204.44
    9928.703     0.999951      3297228     20480.00
    9928.703     0.999957      3297228     23405.71
    9928.703     0.999963      3297228     27306.67
    9936.895     0.999969      3297334     32768.00
    9936.895     1.000000      3297334          inf
#[Mean    =     6521.364, StdDeviation   =     1797.473]
#[Max     =     9928.704, Total count    =      3297334]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  3812195 requests in 1.00m, 243.58MB read
Requests/sec:  63538.10
Transfer/sec:      4.06MB     
```

## Итоги
В ходе реализации получилось уменьшить нагрузку на Selectors и перенести нагрузку на наш пулл потоков. 
По сравнению с синхронной реализацией процент lock на SelectorThread уменьшился со 100% до 25%. \
Однако ощутимого выигрыша в RPS и Latency в данной реализации получено не было. Во многом это связано с тем, что 
основные ресурсы затрачиваются на работу со стандартными инструментами/библиотеками, а наш сервис тратит не так много CPU 
и памяти. Заметим также, что под капотом nio также использует ThreadPoll для асинхронной обработки запросов, во многом из-за этого
мы и не увидели большого прироста в производительности, так как подобный poll для селекторов уже был реализован.

Были подобраны наиболее удачные параметры Threadpoll, в частности был выбран CorePoolSize = Runtime.getRuntime().availableProcessors() * 2
и подобран наиболее удачный размер очереди = 64-128, 
причем дальнейшее уменьшение размера приводит к тому что запросы не помещаются в очередь и в какой-то момент выбрасываются, что 
сопровождается ростом Non-2xx or 3xx responses, а увеличение в свою очередь снижает эффективность использования ресурсов, 
поэтому увеличивается latency.

Около 50% ресурсов процессора тратится на синхронизацию потоков,так например заметный процент работы CPU занимает lock 
в ThreadPoolExecutor.BlockingQueue ~25%, что наводит на мысль о неблокирующей реализации. 

Аллокация памяти происходит в основном при работе с сетью, из возможных улучшений для нашего сервиса - это 
отправка и хранение byte[] вместо конвертации в обе стороны, что задействует лишние ресурсы процессора и память. 
Selector thread аллоцирует память преимущественно на итератор и создания новых вершин для очереди событий, поэтому 
разгрузка очереди уменьшает аллокацию памяти.

Получили, что при rate=75000 асинхронный сервер смог справиться с нагрузкой(Requests/sec:  74914.48/75k Average Latency 40.44ms), 
тогда как синхронный `захлебнулся`(Requests/sec:  63538.10/75k. Avg Latency 6.52s)
Что говорит, о том что полученная реализация является более эффективной при высокой нагрузке.