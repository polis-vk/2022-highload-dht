# Нарузочное тестирование

Нарузочное тестирование базы данных проводилось при помощи wrk2.  
Генерация запросов производилась при помощи put.lua, на каждый ключ размера примерно 10 байт 
записыаем значение размера 360 байт.
Подаем rate = 10000 запросов/сек и нагружаем в течение 5 минут:  

```bash
veronika@MacBook-Pro-Veronika lua % wrk2 -t 1 -c 1 -d 5m -R 10000 -L -s put.lua  http://localhost:8080
Running 5m test @ http://localhost:8080
1 threads and 1 connections
Thread calibration: mean lat.: 12.130ms, rate sampling interval: 10ms
Thread Stats   Avg      Stdev     Max   +/- Stdev
Latency   723.99us  706.26us  37.89ms   97.25%
Req/Sec    10.56k     0.86k   24.11k    69.56%
Latency Distribution (HdrHistogram - Recorded Latency)
50.000%  687.00us
75.000%    0.99ms
90.000%    1.16ms
99.000%    2.06ms
99.900%    7.82ms
99.990%   32.22ms
99.999%   37.31ms
100.000%   37.92ms

Detailed Percentile spectrum:
Value   Percentile   TotalCount 1/(1-Percentile)

0.021     0.000000            2         1.00
0.196     0.100000       290245         1.11
0.321     0.200000       581116         1.25
0.444     0.300000       870823         1.43
0.566     0.400000      1161401         1.67
0.687     0.500000      1450894         2.00
0.747     0.550000      1595181         2.22
0.807     0.600000      1740003         2.50
0.867     0.650000      1884980         2.86
0.927     0.700000      2030494         3.33
0.987     0.750000      2177073         4.00
1.016     0.775000      2247835         4.44
1.046     0.800000      2321478         5.00
1.075     0.825000      2393019         5.71
1.105     0.850000      2467395         6.67
1.134     0.875000      2539756         8.00
1.148     0.887500      2574875         8.89
1.163     0.900000      2612324        10.00
1.177     0.912500      2647226        11.43
1.192     0.925000      2684561        13.33
1.207     0.937500      2720760        16.00
1.215     0.943750      2737683        17.78
1.226     0.950000      2755468        20.00
1.244     0.956250      2773293        22.86
1.275     0.962500      2791268        26.67
1.351     0.968750      2809375        32.00
1.415     0.971875      2818417        35.56
1.496     0.975000      2827533        40.00
1.590     0.978125      2836576        45.71
1.696     0.981250      2845604        53.33
1.816     0.984375      2854677        64.00
1.881     0.985938      2859245        71.11
1.947     0.987500      2863712        80.00
2.017     0.989062      2868272        91.43
2.095     0.990625      2872817       106.67
2.181     0.992188      2877316       128.00
2.235     0.992969      2879615       142.22
2.367     0.993750      2881853       160.00
2.623     0.994531      2884101       182.86
2.943     0.995313      2886377       213.33
3.327     0.996094      2888641       256.00
3.573     0.996484      2889763       284.44
3.867     0.996875      2890898       320.00
4.187     0.997266      2892030       365.71
4.635     0.997656      2893165       426.67
5.219     0.998047      2894295       512.00
5.575     0.998242      2894866       568.89
6.011     0.998437      2895431       640.00
6.439     0.998633      2895997       731.43
7.039     0.998828      2896560       853.33
7.939     0.999023      2897127      1024.00
8.655     0.999121      2897412      1137.78
9.551     0.999219      2897694      1280.00
10.207     0.999316      2897978      1462.86
10.943     0.999414      2898259      1706.67
11.847     0.999512      2898543      2048.00
12.391     0.999561      2898686      2275.56
13.911     0.999609      2898826      2560.00
16.231     0.999658      2898967      2925.71
17.407     0.999707      2899109      3413.33
18.495     0.999756      2899251      4096.00
20.127     0.999780      2899321      4551.11
21.855     0.999805      2899393      5120.00
22.351     0.999829      2899464      5851.43
24.751     0.999854      2899535      6826.67
28.879     0.999878      2899605      8192.00
31.055     0.999890      2899640      9102.22
32.559     0.999902      2899675     10240.00
33.567     0.999915      2899711     11702.86
34.591     0.999927      2899746     13653.33
35.487     0.999939      2899783     16384.00
35.583     0.999945      2899801     18204.44
35.903     0.999951      2899817     20480.00
36.191     0.999957      2899836     23405.71
36.351     0.999963      2899852     27306.67
36.479     0.999969      2899870     32768.00
36.767     0.999973      2899880     36408.89
36.991     0.999976      2899893     40960.00
37.023     0.999979      2899899     46811.43
37.055     0.999982      2899910     54613.33
37.119     0.999985      2899918     65536.00
37.151     0.999986      2899922     72817.78
37.183     0.999988      2899924     81920.00
37.279     0.999989      2899928     93622.86
37.407     0.999991      2899932    109226.67
37.535     0.999992      2899936    131072.00
37.631     0.999993      2899939    145635.56
37.695     0.999994      2899943    163840.00
37.695     0.999995      2899943    187245.71
37.727     0.999995      2899946    218453.33
37.759     0.999996      2899949    262144.00
37.759     0.999997      2899949    291271.11
37.823     0.999997      2899950    327680.00
37.855     0.999997      2899954    374491.43
37.855     0.999998      2899954    436906.67
37.855     0.999998      2899954    524288.00
37.855     0.999998      2899954    582542.22
37.855     0.999998      2899954    655360.00
37.887     0.999999      2899955    748982.86
37.887     0.999999      2899955    873813.33
37.919     0.999999      2899958   1048576.00
37.919     1.000000      2899958          inf
#[Mean    =        0.724, StdDeviation   =        0.706]
#[Max     =       37.888, Total count    =      2899958]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
2999995 requests in 5.00m, 191.69MB read
Requests/sec:   9999.99
Transfer/sec:    654.30KB
```

Получаем, что средняя скорость на запись составляет 0.724ms, 
что является вполне хорошим результатом.

Запросы на чтение генерировались в get.lua. 
Подаем такие же параметры, rate = 10000 запросов / сек и нагружаем в течение 5 минут.  

```bash
veronika@MacBook-Pro-Veronika lua % wrk2 -t 1 -c 1 -d 5m -R 10000 -L -s get.lua  http://localhost:8080
Running 5m test @ http://localhost:8080
1 threads and 1 connections
Thread calibration: mean lat.: 4902.699ms, rate sampling interval: 16580ms
Thread Stats   Avg      Stdev     Max   +/- Stdev
Latency     2.49m     1.31m    4.64m    57.18%
Req/Sec   709.35     54.78   822.00     70.59%
Latency Distribution (HdrHistogram - Recorded Latency)
50.000%    2.53m
75.000%    3.65m
90.000%    4.26m
99.000%    4.61m
99.900%    4.64m
99.990%    4.64m
99.999%    4.65m
100.000%    4.65m

Detailed Percentile spectrum:
Value   Percentile   TotalCount 1/(1-Percentile)

    9379.839     0.000000            2         1.00
38338.559     0.100000        20716         1.11
66945.023     0.200000        41395         1.25
94961.663     0.300000        62115         1.43
122814.463     0.400000        82790         1.67
151519.231     0.500000       103563         2.00
165675.007     0.550000       113867         2.22
179699.711     0.600000       124290         2.50
193855.487     0.650000       134615         2.86
206438.399     0.700000       144933         3.33
219152.383     0.750000       155300         4.00
225312.767     0.775000       160401         4.44
231211.007     0.800000       165611         5.00
237109.247     0.825000       170831         5.71
244187.135     0.850000       175931         6.67
250085.375     0.875000       181106         8.00
253100.031     0.887500       183757         8.89
255852.543     0.900000       186287        10.00
258736.127     0.912500       188961        11.43
261619.711     0.925000       191446        13.33
264634.367     0.937500       194119        16.00
265945.087     0.943750       195338        17.78
267517.951     0.950000       196672        20.00
268959.743     0.956250       197968        22.86
270532.607     0.962500       199419        26.67
271843.327     0.968750       200614        32.00
272629.759     0.971875       201332        35.56
273154.047     0.975000       201816        40.00
273940.479     0.978125       202532        45.71
274726.911     0.981250       203266        53.33
275251.199     0.984375       203757        64.00
275775.487     0.985938       204245        71.11
276037.631     0.987500       204489        80.00
276299.775     0.989062       204736        91.43
276824.063     0.990625       205228       106.67
277086.207     0.992188       205472       128.00
277348.351     0.992969       205718       142.22
277348.351     0.993750       205718       160.00
277610.495     0.994531       205964       182.86
277872.639     0.995313       206209       213.33
277872.639     0.996094       206209       256.00
278134.783     0.996484       206454       284.44
278134.783     0.996875       206454       320.00
278134.783     0.997266       206454       365.71
278396.927     0.997656       206698       426.67
278396.927     0.998047       206698       512.00
278396.927     0.998242       206698       568.89
278396.927     0.998437       206698       640.00
278396.927     0.998633       206698       731.43
278659.071     0.998828       206946       853.33
278659.071     0.999023       206946      1024.00
278659.071     0.999121       206946      1137.78
278659.071     0.999219       206946      1280.00
278659.071     0.999316       206946      1462.86
278659.071     0.999414       206946      1706.67
278659.071     0.999512       206946      2048.00
278659.071     0.999561       206946      2275.56
278659.071     0.999609       206946      2560.00
278659.071     0.999658       206946      2925.71
278659.071     0.999707       206946      3413.33
278659.071     0.999756       206946      4096.00
278659.071     0.999780       206946      4551.11
278659.071     0.999805       206946      5120.00
278659.071     0.999829       206946      5851.43
278659.071     0.999854       206946      6826.67
278659.071     0.999878       206946      8192.00
278659.071     0.999890       206946      9102.22
278659.071     0.999902       206946     10240.00
278659.071     0.999915       206946     11702.86
278659.071     0.999927       206946     13653.33
278921.215     0.999939       206961     16384.00
278921.215     1.000000       206961          inf
#[Mean    =   149481.865, StdDeviation   =    78578.897]
#[Max     =   278659.072, Total count    =       206961]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
213247 requests in 5.00m, 86.23MB read
Requests/sec:    710.82
Transfer/sec:    294.32KB
```

Видим, что на чтение скорость заметно меньше.  
Это связано с тем, что LSM структура данных дает более быструю скорость записи данных 
по сравнению с чтением.    
Так же размер возвращаемых данных достаточно большой 
(примерно 360 байт на ключ). 
Уменьшив rate до 300 запросов / сек получаем значительно лучший результат, в среднем 3ms.

```bash
veronika@MacBook-Pro-Veronika lua % wrk2 -t 1 -c 1 -d 40s -R 300 -L -s get.lua  http://localhost:8080
Running 40s test @ http://localhost:8080
1 threads and 1 connections
Thread calibration: mean lat.: 66.460ms, rate sampling interval: 799ms
Thread Stats   Avg      Stdev     Max   +/- Stdev
Latency     3.08ms    2.96ms  51.26ms   97.73%
Req/Sec   299.76      0.43   300.00    100.00%
Latency Distribution (HdrHistogram - Recorded Latency)
50.000%    2.60ms
75.000%    3.04ms
90.000%    4.22ms
99.000%   13.43ms
99.900%   47.01ms
99.990%   50.34ms
99.999%   51.30ms
100.000%   51.30ms

Detailed Percentile spectrum:
Value   Percentile   TotalCount 1/(1-Percentile)

       1.317     0.000000            1         1.00
       1.978     0.100000          902         1.11
       2.165     0.200000         1804         1.25
       2.313     0.300000         2700         1.43
       2.455     0.400000         3606         1.67
       2.603     0.500000         4507         2.00
       2.673     0.550000         4953         2.22
       2.749     0.600000         5406         2.50
       2.831     0.650000         5850         2.86
       2.925     0.700000         6305         3.33
       3.035     0.750000         6755         4.00
       3.101     0.775000         6980         4.44
       3.187     0.800000         7202         5.00
       3.315     0.825000         7426         5.71
       3.561     0.850000         7651         6.67
       3.861     0.875000         7876         8.00
       4.013     0.887500         7987         8.89
       4.223     0.900000         8100        10.00
       4.423     0.912500         8213        11.43
       4.611     0.925000         8325        13.33
       4.799     0.937500         8438        16.00
       4.915     0.943750         8493        17.78
       5.055     0.950000         8551        20.00
       5.167     0.956250         8608        22.86
       5.327     0.962500         8662        26.67
       5.535     0.968750         8718        32.00
       5.659     0.971875         8746        35.56
       5.835     0.975000         8775        40.00
       6.099     0.978125         8803        45.71
       6.387     0.981250         8831        53.33
       6.799     0.984375         8859        64.00
       7.287     0.985938         8873        71.11
       8.623     0.987500         8887        80.00
      10.759     0.989062         8901        91.43
      14.527     0.990625         8915       106.67
      17.903     0.992188         8929       128.00
      20.799     0.992969         8936       142.22
      21.647     0.993750         8943       160.00
      22.447     0.994531         8950       182.86
      27.119     0.995313         8957       213.33
      31.151     0.996094         8964       256.00
      32.479     0.996484         8968       284.44
      34.399     0.996875         8971       320.00
      35.967     0.997266         8976       365.71
      36.223     0.997656         8978       426.67
      39.903     0.998047         8983       512.00
      40.543     0.998242         8984       568.89
      42.399     0.998437         8985       640.00
      44.543     0.998633         8987       731.43
      46.655     0.998828         8989       853.33
      47.391     0.999023         8991      1024.00
      48.959     0.999121         8992      1137.78
      48.959     0.999219         8992      1280.00
      49.439     0.999316         8993      1462.86
      49.663     0.999414         8994      1706.67
      49.791     0.999512         8995      2048.00
      50.015     0.999561         8996      2275.56
      50.015     0.999609         8996      2560.00
      50.015     0.999658         8996      2925.71
      50.079     0.999707         8997      3413.33
      50.079     0.999756         8997      4096.00
      50.335     0.999780         8998      4551.11
      50.335     0.999805         8998      5120.00
      50.335     0.999829         8998      5851.43
      50.335     0.999854         8998      6826.67
      50.335     0.999878         8998      8192.00
      51.295     0.999890         8999      9102.22
      51.295     1.000000         8999          inf
#[Mean    =        3.077, StdDeviation   =        2.961]
#[Max     =       51.264, Total count    =         8999]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
12001 requests in 40.00s, 4.85MB read
Requests/sec:    300.00
Transfer/sec:    124.22KB
```

# Профилирование
Запустить async-profiler на Mac M1 не получилось, падал с такой ошибкой:

```bash
veronika@MacBook-Pro-Veronika async-profiler % ./profiler.sh -f profiler_put.jfr start DemoServer 
Failed to inject profiler into 41659
/Users/veronika/Documents/Github/async-profiler/build/libasyncProfiler.so:
	build/libasyncProfiler.so (compatibility version 0.0.0, current version 0.0.0)
	/usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1311.100.3)
	/usr/lib/libc++.1.dylib (compatibility version 1.0.0, current version 1300.23.0)
```
Поэтому я использовала idea async profiler.
## PUT  

### CPU  
Большую долю времени занимает обработка запросов - 40% а также select - 32%. 
Помимо этого около 10% времени занимает непосредственная запись в бд.  

### ALLOC  
70% аллокаций были заняты обработкой запросов, 15% заняли select. 
Всего 10% заняла непосредственная запись в бд.

## GET

### CPU
Аналогично с PUT, 45% занимает обработка запросов, 33% select, 
19% времени занимает формирование ответа базой данных.

### ALLOC
Почти весь процент памяти - 90% - занимает обработка запросов, так как в базу мы ничего не записываем.