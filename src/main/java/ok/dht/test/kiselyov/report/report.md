> В качестве БД была взята собственная БД с прошлого семестра.

PUT запросы на стабильной нагрузке к пустой БД:
-
> $ wrk -t 1 -c 1 -R 20000 -d 1m -s put.lua -L http://localhost:19234

Running 1m test @ http://localhost:19234

1 threads and 1 connections

Thread calibration: mean lat.: 1.010ms, rate sampling interval: 10ms

    Thread Stats   Avg      Stdev      Max   +/- Stdev
    Latency   828.07us     1.20ms  20.51ms      95.34%
    Req/Sec     21.09k      2.08k   56.78k      70.23%
***
    Latency Distribution (HdrHistogram - Recorded Latency)
    50.000%  650.00us
    75.000%    0.93ms
    90.000%    1.12ms
    99.000%    6.39ms
    99.900%   15.77ms
    99.990%   19.77ms
    99.999%   20.21ms
    100.000%  20.53ms

Detailed Percentile spectrum:

       Value   Percentile   TotalCount 1/(1-Percentile)

       0.008     0.000000            3         1.00
       0.158     0.100000       100208         1.11
       0.285     0.200000       200113         1.25
       0.411     0.300000       300286         1.43
       0.533     0.400000       400003         1.67
       0.650     0.500000       500271         2.00
       0.707     0.550000       550423         2.22
       0.763     0.600000       600605         2.50
       0.818     0.650000       650432         2.86
       0.873     0.700000       700535         3.33
       0.928     0.750000       750760         4.00
       0.955     0.775000       775387         4.44
       0.982     0.800000       800098         5.00
       1.010     0.825000       825538         5.71
       1.037     0.850000       850511         6.67
       1.064     0.875000       875252         8.00
       1.078     0.887500       888243         8.89
       1.121     0.900000       899988        10.00
       1.292     0.912500       912410        11.43
       1.497     0.925000       924930        13.33
       1.711     0.937500       937408        16.00
       1.830     0.943750       943709        17.78
       1.957     0.950000       949931        20.00
       2.111     0.956250       956160        22.86
       2.381     0.962500       962408        26.67
       2.723     0.968750       968650        32.00
       2.975     0.971875       971780        35.56
       3.281     0.975000       974905        40.00
       3.703     0.978125       978025        45.71
       4.191     0.981250       981158        53.33
       4.703     0.984375       984284        64.00
       5.023     0.985938       985854        71.11
       5.459     0.987500       987407        80.00
       5.991     0.989062       988970        91.43
       6.643     0.990625       990527       106.67
       7.287     0.992188       992088       128.00
       7.559     0.992969       992872       142.22
       8.099     0.993750       993647       160.00
       8.911     0.994531       994431       182.86
       9.527     0.995313       995209       213.33
      10.055     0.996094       995991       256.00
      10.327     0.996484       996387       284.44
      10.879     0.996875       996777       320.00
      11.751     0.997266       997164       365.71
      12.295     0.997656       997553       426.67
      12.887     0.998047       997946       512.00
      13.359     0.998242       998140       568.89
      14.095     0.998437       998335       640.00
      14.847     0.998633       998530       731.43
      15.295     0.998828       998726       853.33
      15.799     0.999023       998920      1024.00
      16.087     0.999121       999018      1137.78
      16.415     0.999219       999118      1280.00
      16.607     0.999316       999237      1462.86
      17.135     0.999414       999311      1706.67
      17.951     0.999512       999409      2048.00
      18.303     0.999561       999457      2275.56
      18.607     0.999609       999506      2560.00
      18.911     0.999658       999556      2925.71
      19.151     0.999707       999604      3413.33
      19.359     0.999756       999657      4096.00
      19.423     0.999780       999684      4551.11
      19.455     0.999805       999702      5120.00
      19.535     0.999829       999727      5851.43
      19.615     0.999854       999751      6826.67
      19.695     0.999878       999775      8192.00
      19.743     0.999890       999791      9102.22
      19.775     0.999902       999804     10240.00
      19.791     0.999915       999812     11702.86
      19.823     0.999927       999825     13653.33
      19.839     0.999939       999840     16384.00
      19.871     0.999945       999842     18204.44
      19.919     0.999951       999851     20480.00
      19.951     0.999957       999856     23405.71
      19.967     0.999963       999861     27306.67
      19.999     0.999969       999869     32768.00
      19.999     0.999973       999869     36408.89
      20.015     0.999976       999872     40960.00
      20.047     0.999979       999875     46811.43
      20.079     0.999982       999878     54613.33
      20.111     0.999985       999881     65536.00
      20.127     0.999986       999883     72817.78
      20.143     0.999988       999884     81920.00
      20.207     0.999989       999886     93622.86
      20.239     0.999991       999887    109226.67
      20.319     0.999992       999889    131072.00
      20.367     0.999993       999890    145635.56
      20.367     0.999994       999890    163840.00
      20.399     0.999995       999891    187245.71
      20.431     0.999995       999892    218453.33
      20.463     0.999996       999893    262144.00
      20.463     0.999997       999893    291271.11
      20.463     0.999997       999893    327680.00
      20.495     0.999997       999894    374491.43
      20.495     0.999998       999894    436906.67
      20.527     0.999998       999896    524288.00
      20.527     1.000000       999896          inf
***
    #[Mean    =        0.828, StdDeviation   =        1.203]
    #[Max     =       20.512, Total count    =       999896]
    #[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
1199973 requests in 1.00m, 76.67MB read

Requests/sec:  19999.58

Transfer/sec:      1.28MB

---

> $ wrk -t 1 -c 1 -R 30000 -d 1m -s put.lua -L http://localhost:19234

Running 1m test @ http://localhost:19234

1 threads and 1 connections

Thread calibration: mean lat.: 2.111ms, rate sampling interval: 10ms

    Thread Stats   Avg      Stdev      Max   +/- Stdev
    Latency     2.33ms     6.06ms  88.00ms      92.93%
    Req/Sec     31.67k      6.96k  116.78k      86.84%
***
    Latency Distribution (HdrHistogram - Recorded Latency)
    50.000%  725.00us
    75.000%    1.04ms
    90.000%    5.31ms
    99.000%   31.14ms
    99.900%   72.45ms
    99.990%   87.81ms
    99.999%   88.00ms
    100.000%  88.06ms

Detailed Percentile spectrum:

       Value   Percentile   TotalCount 1/(1-Percentile)

       0.009     0.000000            1         1.00
       0.170     0.100000       150667         1.11
       0.315     0.200000       300456         1.25
       0.457     0.300000       450788         1.43
       0.593     0.400000       600140         1.67
       0.725     0.500000       750512         2.00
       0.790     0.550000       825990         2.22
       0.853     0.600000       900173         2.50
       0.917     0.650000       975528         2.86
       0.980     0.700000      1050175         3.33
       1.043     0.750000      1125329         4.00
       1.075     0.775000      1162451         4.44
       1.364     0.800000      1199938         5.00
       1.800     0.825000      1237430         5.71
       2.491     0.850000      1274940         6.67
       3.629     0.875000      1312428         8.00
       4.391     0.887500      1331231         8.89
       5.311     0.900000      1349925        10.00
       6.435     0.912500      1368667        11.43
       7.831     0.925000      1387445        13.33
       9.479     0.937500      1406180        16.00
      10.311     0.943750      1415568        17.78
      11.439     0.950000      1424905        20.00
      12.999     0.956250      1434294        22.86
      14.799     0.962500      1443669        26.67
      16.479     0.968750      1453044        32.00
      17.535     0.971875      1457724        35.56
      18.799     0.975000      1462404        40.00
      20.223     0.978125      1467108        45.71
      21.871     0.981250      1471815        53.33
      24.847     0.984375      1476475        64.00
      26.623     0.985938      1478804        71.11
      28.175     0.987500      1481160        80.00
      30.031     0.989062      1483511        91.43
      31.999     0.990625      1485838       106.67
      34.175     0.992188      1488203       128.00
      35.743     0.992969      1489348       142.22
      37.055     0.993750      1490609       160.00
      39.199     0.994531      1491704       182.86
      41.791     0.995313      1492872       213.33
      44.511     0.996094      1494044       256.00
      45.695     0.996484      1494638       284.44
      47.199     0.996875      1495208       320.00
      49.311     0.997266      1495797       365.71
      51.711     0.997656      1496393       426.67
      53.407     0.998047      1496965       512.00
      56.287     0.998242      1497258       568.89
      60.383     0.998437      1497552       640.00
      65.023     0.998633      1497845       731.43
      69.375     0.998828      1498140       853.33
      72.831     0.999023      1498431      1024.00
      74.751     0.999121      1498579      1137.78
      76.991     0.999219      1498727      1280.00
      78.975     0.999316      1498872      1462.86
      81.023     0.999414      1499019      1706.67
      82.815     0.999512      1499164      2048.00
      83.711     0.999561      1499237      2275.56
      84.607     0.999609      1499314      2560.00
      85.439     0.999658      1499386      2925.71
      86.207     0.999707      1499457      3413.33
      86.719     0.999756      1499534      4096.00
      86.911     0.999780      1499565      4551.11
      87.167     0.999805      1499606      5120.00
      87.359     0.999829      1499645      5851.43
      87.551     0.999854      1499687      6826.67
      87.679     0.999878      1499715      8192.00
      87.743     0.999890      1499735      9102.22
      87.807     0.999902      1499761     10240.00
      87.871     0.999915      1499789     11702.86
      87.871     0.999927      1499789     13653.33
      87.935     0.999939      1499823     16384.00
      87.935     0.999945      1499823     18204.44
      87.935     0.999951      1499823     20480.00
      87.999     0.999957      1499893     23405.71
      87.999     0.999963      1499893     27306.67
      87.999     0.999969      1499893     32768.00
      87.999     0.999973      1499893     36408.89
      87.999     0.999976      1499893     40960.00
      87.999     0.999979      1499893     46811.43
      87.999     0.999982      1499893     54613.33
      87.999     0.999985      1499893     65536.00
      87.999     0.999986      1499893     72817.78
      87.999     0.999988      1499893     81920.00
      87.999     0.999989      1499893     93622.86
      87.999     0.999991      1499893    109226.67
      87.999     0.999992      1499893    131072.00
      87.999     0.999993      1499893    145635.56
      87.999     0.999994      1499893    163840.00
      87.999     0.999995      1499893    187245.71
      87.999     0.999995      1499893    218453.33
      87.999     0.999996      1499893    262144.00
      87.999     0.999997      1499893    291271.11
      87.999     0.999997      1499893    327680.00
      87.999     0.999997      1499893    374491.43
      87.999     0.999998      1499893    436906.67
      87.999     0.999998      1499893    524288.00
      87.999     0.999998      1499893    582542.22
      87.999     0.999998      1499893    655360.00
      87.999     0.999999      1499893    748982.86
      87.999     0.999999      1499893    873813.33
      87.999     0.999999      1499893   1048576.00
      87.999     0.999999      1499893   1165084.44
      87.999     0.999999      1499893   1310720.00
      87.999     0.999999      1499893   1497965.71
      88.063     0.999999      1499894   1747626.67
      88.063     1.000000      1499894          inf
***
    #[Mean    =        2.332, StdDeviation   =        6.062]
    #[Max     =       88.000, Total count    =      1499894]
    #[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
1799958 requests in 1.00m, 115.01MB read

Requests/sec:  29999.46

Transfer/sec:      1.92MB

> Хит мап и флейм граф в файлах put_alloc.html и put_cpu.html.

GET запросы на стабильной нагрузке к наполненной БД:
-
> Было добавлено 1_000_000 записей в БД перед тестированием

> $ wrk -t 1 -c 1 -R 15000 -d 1m -s get.lua -L http://localhost:19234

Running 1m test @ http://localhost:19234

1 threads and 1 connections

Thread calibration: mean lat.: 0.847ms, rate sampling interval: 10ms

    Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency   795.40us  618.76us   7.46ms   81.28%
    Req/Sec    15.81k     1.32k   25.33k    74.49%
***
    Latency Distribution (HdrHistogram - Recorded Latency)
    50.000%  718.00us
    75.000%    1.00ms
    90.000%    1.41ms
    99.000%    3.32ms
    99.900%    5.44ms
    99.990%    7.24ms
    99.999%    7.45ms
    100.000%    7.46ms

Detailed Percentile spectrum:

       Value   Percentile   TotalCount 1/(1-Percentile)

       0.009     0.000000            2         1.00
       0.192     0.100000        75315         1.11
       0.331     0.200000       150253         1.25
       0.465     0.300000       225479         1.43
       0.594     0.400000       300126         1.67
       0.718     0.500000       375323         2.00
       0.777     0.550000       412918         2.22
       0.835     0.600000       450601         2.50
       0.891     0.650000       487489         2.86
       0.947     0.700000       525105         3.33
       1.003     0.750000       562957         4.00
       1.029     0.775000       581222         4.44
       1.055     0.800000       600169         5.00
       1.082     0.825000       619333         5.71
       1.113     0.850000       637634         6.67
       1.236     0.875000       656293         8.00
       1.317     0.887500       665648         8.89
       1.407     0.900000       675007        10.00
       1.505     0.912500       684379        11.43
       1.606     0.925000       693741        13.33
       1.724     0.937500       703085        16.00
       1.789     0.943750       707786        17.78
       1.856     0.950000       712482        20.00
       1.926     0.956250       717124        22.86
       2.000     0.962500       721810        26.67
       2.085     0.968750       726524        32.00
       2.183     0.971875       728864        35.56
       2.315     0.975000       731181        40.00
       2.459     0.978125       733537        45.71
       2.615     0.981250       735885        53.33
       2.825     0.984375       738222        64.00
       2.937     0.985938       739388        71.11
       3.061     0.987500       740566        80.00
       3.203     0.989062       741737        91.43
       3.411     0.990625       742898       106.67
       3.649     0.992188       744072       128.00
       3.773     0.992969       744662       142.22
       3.899     0.993750       745241       160.00
       4.053     0.994531       745830       182.86
       4.195     0.995313       746418       213.33
       4.343     0.996094       747000       256.00
       4.435     0.996484       747296       284.44
       4.527     0.996875       747593       320.00
       4.615     0.997266       747892       365.71
       4.723     0.997656       748170       426.67
       4.895     0.998047       748463       512.00
       5.003     0.998242       748614       568.89
       5.115     0.998437       748756       640.00
       5.203     0.998633       748906       731.43
       5.307     0.998828       749051       853.33
       5.467     0.999023       749197      1024.00
       5.583     0.999121       749268      1137.78
       5.695     0.999219       749342      1280.00
       5.927     0.999316       749415      1462.86
       6.147     0.999414       749488      1706.67
       6.379     0.999512       749561      2048.00
       6.495     0.999561       749598      2275.56
       6.615     0.999609       749636      2560.00
       6.723     0.999658       749672      2925.71
       6.811     0.999707       749709      3413.33
       6.879     0.999756       749744      4096.00
       6.959     0.999780       749764      4551.11
       7.011     0.999805       749783      5120.00
       7.071     0.999829       749799      5851.43
       7.119     0.999854       749818      6826.67
       7.175     0.999878       749837      8192.00
       7.211     0.999890       749845      9102.22
       7.239     0.999902       749854     10240.00
       7.279     0.999915       749863     11702.86
       7.335     0.999927       749873     13653.33
       7.403     0.999939       749882     16384.00
       7.415     0.999945       749888     18204.44
       7.419     0.999951       749891     20480.00
       7.427     0.999957       749895     23405.71
       7.435     0.999963       749901     27306.67
       7.443     0.999969       749908     32768.00
       7.443     0.999973       749908     36408.89
       7.447     0.999976       749912     40960.00
       7.447     0.999979       749912     46811.43
       7.451     0.999982       749916     54613.33
       7.451     0.999985       749916     65536.00
       7.455     0.999986       749923     72817.78
       7.455     0.999988       749923     81920.00
       7.455     0.999989       749923     93622.86
       7.455     0.999991       749923    109226.67
       7.455     0.999992       749923    131072.00
       7.455     0.999993       749923    145635.56
       7.455     0.999994       749923    163840.00
       7.455     0.999995       749923    187245.71
       7.459     0.999995       749925    218453.33
       7.459     0.999996       749925    262144.00
       7.459     0.999997       749925    291271.11
       7.459     0.999997       749925    327680.00
       7.459     0.999997       749925    374491.43
       7.463     0.999998       749927    436906.67
       7.463     1.000000       749927          inf
 ***
    #[Mean    =        0.795, StdDeviation   =        0.619]
    #[Max     =        7.460, Total count    =       749927]
    #[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
899982 requests in 1.00m, 58.27MB read

Requests/sec:  14999.77

Transfer/sec:      0.97MB

---

> wrk -t 1 -c 1 -R 20000 -d 1m -s get.lua -L http://localhost:19234

Running 1m test @ http://localhost:19234

1 threads and 1 connections

Thread calibration: mean lat.: 16.976ms, rate sampling interval: 100ms

    Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     3.72ms    7.10ms  69.82ms   90.43%
    Req/Sec    20.10k     1.65k   29.94k    80.56%
***
    Latency Distribution (HdrHistogram - Recorded Latency)
    50.000%    1.05ms
    75.000%    3.09ms
    90.000%   10.45ms
    99.000%   38.24ms
    99.900%   62.49ms
    99.990%   69.63ms
    99.999%   69.89ms
    100.000%   69.89ms

Detailed Percentile spectrum:

       Value   Percentile   TotalCount 1/(1-Percentile)

       0.010     0.000000            8         1.00
       0.265     0.100000       100185         1.11
       0.484     0.200000       200238         1.25
       0.687     0.300000       300166         1.43
       0.879     0.400000       400107         1.67
       1.054     0.500000       500479         2.00
       1.203     0.550000       550182         2.22
       1.450     0.600000       600007         2.50
       1.730     0.650000       650105         2.86
       2.042     0.700000       700086         3.33
       3.087     0.750000       750026         4.00
       3.789     0.775000       775029         4.44
       4.655     0.800000       800096         5.00
       5.623     0.825000       824997         5.71
       6.899     0.850000       850042         6.67
       8.463     0.875000       875059         8.00
       9.415     0.887500       887563         8.89
      10.447     0.900000       900020        10.00
      11.551     0.912500       912502        11.43
      12.999     0.925000       925034        13.33
      14.903     0.937500       937496        16.00
      15.983     0.943750       943766        17.78
      17.183     0.950000       950013        20.00
      18.623     0.956250       956300        22.86
      20.207     0.962500       962505        26.67
      22.079     0.968750       968761        32.00
      23.359     0.971875       971862        35.56
      24.735     0.975000       974986        40.00
      26.815     0.978125       978117        45.71
      28.895     0.981250       981230        53.33
      31.471     0.984375       984362        64.00
      33.311     0.985938       985928        71.11
      35.327     0.987500       987499        80.00
      37.279     0.989062       989071        91.43
      38.975     0.990625       990612       106.67
      40.927     0.992188       992185       128.00
      41.983     0.992969       992954       142.22
      43.199     0.993750       993742       160.00
      43.999     0.994531       994519       182.86
      45.119     0.995313       995301       213.33
      47.391     0.996094       996079       256.00
      48.383     0.996484       996468       284.44
      48.863     0.996875       996870       320.00
      50.815     0.997266       997252       365.71
      52.415     0.997656       997648       426.67
      53.663     0.998047       998028       512.00
      55.135     0.998242       998226       568.89
      57.567     0.998437       998429       640.00
      58.207     0.998633       998613       731.43
      60.511     0.998828       998808       853.33
      62.687     0.999023       999005      1024.00
      63.391     0.999121       999107      1137.78
      63.647     0.999219       999202      1280.00
      64.287     0.999316       999298      1462.86
      65.215     0.999414       999396      1706.67
      66.111     0.999512       999491      2048.00
      66.687     0.999561       999542      2275.56
      67.199     0.999609       999593      2560.00
      67.647     0.999658       999647      2925.71
      68.159     0.999707       999689      3413.33
      68.415     0.999756       999761      4096.00
      68.415     0.999780       999761      4551.11
      68.735     0.999805       999791      5120.00
      69.055     0.999829       999813      5851.43
      69.311     0.999854       999836      6826.67
      69.503     0.999878       999866      8192.00
      69.567     0.999890       999873      9102.22
      69.631     0.999902       999899     10240.00
      69.631     0.999915       999899     11702.86
      69.695     0.999927       999907     13653.33
      69.823     0.999939       999932     16384.00
      69.823     0.999945       999932     18204.44
      69.823     0.999951       999932     20480.00
      69.887     0.999957       999979     23405.71
      69.887     1.000000       999979          inf
 ***
    #[Mean    =        3.717, StdDeviation   =        7.095]
    #[Max     =       69.824, Total count    =       999979]
    #[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
1199981 requests in 1.00m, 77.69MB read

Requests/sec:  19999.81

Transfer/sec:      1.29MB

> Хит мап и флейм граф в файлах get_alloc.html и get_cpu.html.

Выводы:
-
Put:

Скорость обработки поступающих запросов в обычном режиме составляет примерно 20000 r/s. При этом latency в среднем

составляет примерно 0.83ms. 90% запросов выполняются за 1.12ms в среднем, а 99% - за 15.04ms. При скорости обработки

запросов в 30000 r/s и более сервис начинает тормозить и latency в среднем составляет уже примерно 2.3ms и будет

постепенно увеличиваться. 90% запросов при такой скорости выполняются за 5.31ms в среднем, а 99% - уже за 31.14ms.

Процессорное время делится следующим образом: примерно 40% времени занимает работа G1 сборщика мусора. Он проходится

по хипу и помечает объекты как живые довольно часто, поскольку в операции PUT задействовано много обращений к памяти.

Оставшееся время (приблизительно 60%) приходится на системные вызовы и flush данных (особенно на поздних этапах, когда

число байт на каждую запись увеличивается в связи с большими номерами key и value и приходится часто обращаться к памяти,

чтобы зафлашить данные на диск (происходит переполнение flushThresholdBytes)).

Память распределяется следующим образом: приблизительно 50% памяти выделяется на генерацию объекта ArrayQueueItem из

класса one.nio.net.Session. Данный объект представляет собой набор данных, которые необходимо обернуть в определенную

структуру и отправить клиенту. Оставшаяся память (приблизительно 50%) выделяется под парсинг строк (для получения id, 

например), копирование массивов и т. п.

Рост времени на высоких процентилях вызван тем, что особенно на начальных этапах происходит активная JIT-компиляция

кода, также в определенные моменты подключается G1 сборщик мусора на хипе (помечает блоки памяти для последующего

удаления). Проблему представляют селекторы, которые блокируются из-за операции upsert при большом количестве попыток

соединения от клиентов. Для улучшения данной операции необходимо добавить очередь из запросов и воркеров, которые будут 

эти очереди обрабатывать. Также проблему представляет небольшой размер flushThresholdBytes, что сказывается на частоте

операции фонового flush. Данный порог можно увеличить, что положительно скажется на производительности системы.


Get:

Скорость обработки поступающих запросов в обычном режиме составляет примерно 15000 r/s. При этом latency в среднем

составляет примерно 0.8ms. 90% запросов выполняются за 1.41ms в среднем, а 99% - за 3.32ms. При скорости обработки

запросов в 20000 r/s и более сервис начинает тормозить и latency в среднем составляет уже примерно 3.72ms и будет

постепенно увеличиваться. 90% запросов при такой скорости выполняются за 10.45ms в среднем, а 99% - уже за 38.24ms.

Процессорное время делится следующим образом: примерно 80% уходит на работу G1 сборщика мусора. Он проходится

по хипу и помечает объекты как живые довольно часто, поскольку в операции GET задействовано много обращений к памяти.

Оставшееся время (приблизительно 20%) занимаемся системными вызовами и поиском данных в БД.

Память аллоцирована на PriorityQueue, что объясняется тем, что данная структура представляет собой приоритетную 

очередь из итераторов по таблицам в БД. То есть память выделяется на получение Entry из таблиц и их индексов

и сравнение Entry между собой по ключам. 

Рост времени на высоких процентилях вызван JIT-компиляцией на начальных этапах, работой сборщика мусора. Проблему так

же представляют селекторы, которые не позволяют работать с большим количеством клиентов. Необходимо добавить очередь из

запросов и воркеров, которые будут обрабатывать очереди. Также имеет смысл автоматически компактить данные для того,

чтобы уменьшать количество обращений к данным и уменьшать количество могил. Также стоит добавить блум фильтр для того,

чтобы пропускать таблицы, в которых гарантированно не содержится искомый ключ, что опять же сократит количество

системных обращений.