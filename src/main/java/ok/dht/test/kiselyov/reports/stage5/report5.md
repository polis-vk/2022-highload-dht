Нагрузочное тестирование проводилось на 3 нодах. Для GET запросов предварительно была сгенерирована БД с 100_000
записей. PUT запросы проходили с рейтом 20000 на 64 соединениях и 64 потоках, GET запросы - 5000 с тем же количеством
соединений и потоков.

По PUT нагрузке видно, что с увеличением требуемых подтверждений ack время ответов от сервера несколько увеличилось
(с 1.32ms до 1.59ms на 99% персентиле). Уменьшилось время ответа по сравнению с решением без асинхронности
(с 1.79ms до 1.32ms на 99% персентиле).

По GET нагрузке видно, что с увеличением требуемых подтверждений ack время ответов от сервера несколько увеличилось
(с 1.38ms до 1.59ms на 99% персентиле). Уменьшилось время ответа по сравнению с решением без асинхронности
(с 1.91ms до 1.38ms на 99% персентиле).

Поскольку по сравнению с синхронным решением теперь нет необходимости дожидаться ответа от ноды, то видно улучшение по 
производительности системы. Но при этом требуется некоторое время на перемещение запросов из потока воркеров в поток 
внутреннего клиента (при обмене информации между нодами внутри системы).

Также стоит отметить таймаут некоторых запросов, особенно при ack=3 и from=3. Данную особенность можно объяснить тем, 
что сервис не успевает обработать их в очереди ввиду слишком большого количества запросов. Ошибки 504 в запросах с 
ack=3 и from=3 объясняются тем, что ввиду слишком высокой загруженности отдельных нод в определенные моменты собрать 
3 подтверждения до таймаута не получается.

PUT профилирование (3 ноды):

Распределение процессорного времени аналогично stage4. Среди отличий стоит выделить 
HttpClientImpl.SelectorManager (18.41% времени), который занимается обработкой асинхронных событий: берет задачи из 
очереди, очищает ненужные задачи (из-за таймаута или в ситуации, когда ответ клиенту уже отправлен). Из аллокаций стал 
заметен ForkJoinWorkerThread (4.58%), который отвечает за формирование response - ответ клиенту, а также за аллокации на
CopyOnWriteArrayList. В локах увеличилось число блокировок на CompletableFuture (до 10.59%). Это связано с блокировками
на обработке ответов от других нод.

GET профилирование (3 ноды):

По сравнению со stage4 увеличилось процессорное время на обработку CompletableFuture (до 17.46% времени). Аналогично с 
PUT работает ForkJoinWorkerThread (1.42% аллокаций). Основное количество блокировок связано с пулом соединений: 
returnToPool (9.66%), getConnection (0.62%). На обработку CompletableFuture уходит 10.34% локов.

Наибольшее время в PUT и GET запросах уходит на передачу HTTP запросов между нодами. Для сокращения этого времени можно
выполнять фоновую операцию compact, использовать фильтр Блума.


PUT запросы с 3 нодами (from = 3, ack = 1)
-

> wrk -t 64 -c 64 -R 20000 -d 1m -s put.lua -L http://localhost:19234

Running 1m test @ http://localhost:19234

64 threads and 64 connections

Thread calibration: mean lat.: 19.282ms, rate sampling interval: 43ms

...

Thread calibration: mean lat.: 18.605ms, rate sampling interval: 40ms

    Thread Stats   Avg      Stdev      Max   +/- Stdev
    Latency   749.40us   316.22us   7.36ms      61.28%
    Req/Sec       9.43      55.71   500.00      97.18%
***
    Latency Distribution (HdrHistogram - Recorded Latency)
    50.000%  739.00us
    75.000%    1.01ms
    90.000%    1.16ms
    99.000%    1.32ms
    99.900%    1.49ms
    99.990%    4.32ms
    99.999%    7.36ms
    100.000%   7.36ms

Detailed Percentile spectrum:

       Value   Percentile   TotalCount 1/(1-Percentile)

       0.048     0.000000            1         1.00
       0.340     0.100000         1570         1.11
       0.443     0.200000         3128         1.25
       0.540     0.300000         4703         1.43
       0.636     0.400000         6255         1.67
       0.739     0.500000         7812         2.00
       0.791     0.550000         8597         2.22
       0.843     0.600000         9380         2.50
       0.900     0.650000        10159         2.86
       0.955     0.700000        10953         3.33
       1.008     0.750000        11731         4.00
       1.035     0.775000        12113         4.44
       1.063     0.800000        12505         5.00
       1.086     0.825000        12890         5.71
       1.112     0.850000        13292         6.67
       1.138     0.875000        13677         8.00
       1.150     0.887500        13867         8.89
       1.164     0.900000        14063        10.00
       1.177     0.912500        14257        11.43
       1.191     0.925000        14460        13.33
       1.207     0.937500        14648        16.00
       1.216     0.943750        14748        17.78
       1.225     0.950000        14853        20.00
       1.234     0.956250        14953        22.86
       1.244     0.962500        15041        26.67
       1.256     0.968750        15136        32.00
       1.263     0.971875        15187        35.56
       1.269     0.975000        15234        40.00
       1.279     0.978125        15286        45.71
       1.288     0.981250        15335        53.33
       1.296     0.984375        15381        64.00
       1.303     0.985938        15406        71.11
       1.308     0.987500        15427        80.00
       1.315     0.989062        15454        91.43
       1.322     0.990625        15478       106.67
       1.332     0.992188        15501       128.00
       1.338     0.992969        15513       142.22
       1.345     0.993750        15525       160.00
       1.355     0.994531        15537       182.86
       1.364     0.995313        15550       213.33
       1.373     0.996094        15561       256.00
       1.382     0.996484        15568       284.44
       1.392     0.996875        15576       320.00
       1.402     0.997266        15580       365.71
       1.407     0.997656        15586       426.67
       1.423     0.998047        15592       512.00
       1.434     0.998242        15595       568.89
       1.447     0.998437        15598       640.00
       1.456     0.998633        15601       731.43
       1.465     0.998828        15604       853.33
       1.512     0.999023        15607      1024.00
       1.518     0.999121        15609      1137.78
       1.566     0.999219        15610      1280.00
       1.596     0.999316        15612      1462.86
       1.605     0.999414        15613      1706.67
       1.904     0.999512        15615      2048.00
       1.963     0.999561        15616      2275.56
       1.963     0.999609        15616      2560.00
       2.067     0.999658        15617      2925.71
       2.245     0.999707        15618      3413.33
       4.083     0.999756        15619      4096.00
       4.083     0.999780        15619      4551.11
       4.083     0.999805        15619      5120.00
       4.315     0.999829        15620      5851.43
       4.315     0.999854        15620      6826.67
       7.147     0.999878        15621      8192.00
       7.147     0.999890        15621      9102.22
       7.147     0.999902        15621     10240.00
       7.147     0.999915        15621     11702.86
       7.147     0.999927        15621     13653.33
       7.363     0.999939        15622     16384.00
       7.363     1.000000        15622          inf
***
    #[Mean    =        0.749, StdDeviation   =        0.316]
    #[Max     =        7.360, Total count    =        15622]
    #[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
18815 requests in 1.00m, 1.20MB read

Socket errors: connect 0, read 0, write 0, timeout 1854

Requests/sec:    313.50

Transfer/sec:     20.51KB

PUT запросы с 3 нодами (from = 3, ack = 3)
-

> wrk -t 64 -c 64 -R 20000 -d 1m -s put.lua -L http://localhost:19234

Running 1m test @ http://localhost:19234

64 threads and 64 connections

Thread calibration: mean lat.: 1.053ms, rate sampling interval: 10ms

...

Thread calibration: mean lat.: 0.853ms, rate sampling interval: 10ms

    Thread Stats   Avg      Stdev      Max   +/- Stdev
    Latency     1.01ms   327.44us   9.08ms      64.20%
    Req/Sec       5.18      41.50   500.00      98.44%
***
    Latency Distribution (HdrHistogram - Recorded Latency)
    50.000%    1.01ms
    75.000%    1.26ms
    90.000%    1.42ms
    99.000%    1.59ms
    99.900%    1.94ms
    99.990%    6.39ms
    99.999%    9.09ms
    100.000%   9.09ms

Detailed Percentile spectrum:

       Value   Percentile   TotalCount 1/(1-Percentile)

       0.143     0.000000            1         1.00
       0.593     0.100000         1564         1.11
       0.699     0.200000         3135         1.25
       0.803     0.300000         4701         1.43
       0.904     0.400000         6260         1.67
       1.006     0.500000         7813         2.00
       1.058     0.550000         8594         2.22
       1.109     0.600000         9378         2.50
       1.162     0.650000        10166         2.86
       1.211     0.700000        10943         3.33
       1.264     0.750000        11728         4.00
       1.287     0.775000        12111         4.44
       1.312     0.800000        12504         5.00
       1.338     0.825000        12895         5.71
       1.364     0.850000        13278         6.67
       1.390     0.875000        13667         8.00
       1.404     0.887500        13866         8.89
       1.417     0.900000        14061        10.00
       1.432     0.912500        14261        11.43
       1.447     0.925000        14462        13.33
       1.462     0.937500        14651        16.00
       1.471     0.943750        14744        17.78
       1.481     0.950000        14850        20.00
       1.491     0.956250        14946        22.86
       1.500     0.962500        15043        26.67
       1.512     0.968750        15133        32.00
       1.520     0.971875        15187        35.56
       1.526     0.975000        15229        40.00
       1.539     0.978125        15280        45.71
       1.549     0.981250        15328        53.33
       1.562     0.984375        15375        64.00
       1.571     0.985938        15401        71.11
       1.577     0.987500        15426        80.00
       1.587     0.989062        15453        91.43
       1.598     0.990625        15473       106.67
       1.618     0.992188        15498       128.00
       1.625     0.992969        15510       142.22
       1.633     0.993750        15522       160.00
       1.649     0.994531        15534       182.86
       1.661     0.995313        15547       213.33
       1.675     0.996094        15559       256.00
       1.680     0.996484        15565       284.44
       1.688     0.996875        15571       320.00
       1.710     0.997266        15577       365.71
       1.720     0.997656        15583       426.67
       1.742     0.998047        15589       512.00
       1.756     0.998242        15592       568.89
       1.769     0.998437        15595       640.00
       1.797     0.998633        15598       731.43
       1.911     0.998828        15601       853.33
       1.996     0.999023        15604      1024.00
       2.115     0.999121        15606      1137.78
       2.123     0.999219        15607      1280.00
       2.239     0.999316        15609      1462.86
       2.269     0.999414        15610      1706.67
       2.659     0.999512        15612      2048.00
       3.539     0.999561        15613      2275.56
       3.539     0.999609        15613      2560.00
       3.679     0.999658        15614      2925.71
       3.689     0.999707        15615      3413.33
       6.199     0.999756        15616      4096.00
       6.199     0.999780        15616      4551.11
       6.199     0.999805        15616      5120.00
       6.391     0.999829        15617      5851.43
       6.391     0.999854        15617      6826.67
       8.855     0.999878        15618      8192.00
       8.855     0.999890        15618      9102.22
       8.855     0.999902        15618     10240.00
       8.855     0.999915        15618     11702.86
       8.855     0.999927        15618     13653.33
       9.087     0.999939        15619     16384.00
       9.087     1.000000        15619          inf
***
    #[Mean    =        1.009, StdDeviation   =        0.327]
    #[Max     =        9.080, Total count    =        15619]
    #[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
20009 requests in 1.00m, 1.29MB read

Socket errors: connect 0, read 0, write 0, timeout 1870

Non-2xx or 3xx responses: 1488

Requests/sec:    333.40

Transfer/sec:     22.01KB

GET запросы с 3 нодами (from = 3, ack = 1)
-

> wrk -t 64 -c 64 -R 5000 -d 1m -s get.lua -L http://localhost:19234

Running 1m test @ http://localhost:19234

64 threads and 64 connections

Thread calibration: mean lat.: 0.807ms, rate sampling interval: 10ms

...

Thread calibration: mean lat.: 0.796ms, rate sampling interval: 10ms

    Thread Stats   Avg      Stdev      Max   +/- Stdev
    Latency   807.49us   303.85us   6.06ms      60.53%
    Req/Sec       3.41      18.40   111.00      96.68%
***
    Latency Distribution (HdrHistogram - Recorded Latency)
    50.000%  805.00us
    75.000%    1.06ms
    90.000%    1.21ms
    99.000%    1.38ms
    99.900%    1.53ms
    99.990%    2.02ms
    99.999%    6.06ms
    100.000%   6.06ms

Detailed Percentile spectrum:

       Value   Percentile   TotalCount 1/(1-Percentile)

       0.027     0.000000            1         1.00
       0.399     0.100000         1061         1.11
       0.504     0.200000         2130         1.25
       0.607     0.300000         3181         1.43
       0.706     0.400000         4234         1.67
       0.805     0.500000         5292         2.00
       0.859     0.550000         5818         2.22
       0.910     0.600000         6349         2.50
       0.961     0.650000         6882         2.86
       1.011     0.700000         7402         3.33
       1.056     0.750000         7933         4.00
       1.084     0.775000         8197         4.44
       1.108     0.800000         8461         5.00
       1.134     0.825000         8729         5.71
       1.160     0.850000         8987         6.67
       1.186     0.875000         9261         8.00
       1.197     0.887500         9383         8.89
       1.210     0.900000         9526        10.00
       1.223     0.912500         9656        11.43
       1.237     0.925000         9785        13.33
       1.250     0.937500         9911        16.00
       1.257     0.943750         9983        17.78
       1.264     0.950000        10053        20.00
       1.271     0.956250        10113        22.86
       1.281     0.962500        10177        26.67
       1.291     0.968750        10245        32.00
       1.301     0.971875        10278        35.56
       1.307     0.975000        10309        40.00
       1.318     0.978125        10344        45.71
       1.331     0.981250        10373        53.33
       1.344     0.984375        10408        64.00
       1.355     0.985938        10426        71.11
       1.361     0.987500        10439        80.00
       1.373     0.989062        10456        91.43
       1.382     0.990625        10474       106.67
       1.399     0.992188        10489       128.00
       1.410     0.992969        10497       142.22
       1.424     0.993750        10507       160.00
       1.437     0.994531        10515       182.86
       1.443     0.995313        10522       213.33
       1.453     0.996094        10531       256.00
       1.457     0.996484        10535       284.44
       1.459     0.996875        10538       320.00
       1.476     0.997266        10543       365.71
       1.480     0.997656        10547       426.67
       1.494     0.998047        10551       512.00
       1.512     0.998242        10553       568.89
       1.518     0.998437        10555       640.00
       1.524     0.998633        10557       731.43
       1.525     0.998828        10559       853.33
       1.533     0.999023        10561      1024.00
       1.534     0.999121        10562      1137.78
       1.543     0.999219        10563      1280.00
       1.581     0.999316        10564      1462.86
       1.590     0.999414        10566      1706.67
       1.590     0.999512        10566      2048.00
       1.603     0.999561        10567      2275.56
       1.603     0.999609        10567      2560.00
       1.605     0.999658        10568      2925.71
       1.605     0.999707        10568      3413.33
       1.687     0.999756        10569      4096.00
       1.687     0.999780        10569      4551.11
       1.687     0.999805        10569      5120.00
       2.023     0.999829        10570      5851.43
       2.023     0.999854        10570      6826.67
       2.023     0.999878        10570      8192.00
       2.023     0.999890        10570      9102.22
       2.023     0.999902        10570     10240.00
       6.063     0.999915        10571     11702.86
       6.063     1.000000        10571          inf
***
    #[Mean    =        0.807, StdDeviation   =        0.304]
    #[Max     =        6.060, Total count    =        10571]
    #[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
14613 requests in 1.00m, 0.90MB read

Socket errors: connect 0, read 0, write 0, timeout 1805

Requests/sec:    243.49

Transfer/sec:     15.43KB

GET запросы с 3 нодами (from = 3, ack = 3)
-

> wrk -t 64 -c 64 -R 5000 -d 1m -s get.lua -L http://localhost:19234

Running 1m test @ http://localhost:19234

64 threads and 64 connections

Thread calibration: mean lat.: 1.178ms, rate sampling interval: 10ms

...

Thread calibration: mean lat.: 0.189ms, rate sampling interval: 10ms

    Thread Stats   Avg      Stdev      Max   +/- Stdev
    Latency     0.92ms   331.57us   5.62ms      65.09%
    Req/Sec       2.92      17.19   111.00      97.18%
***
    Latency Distribution (HdrHistogram - Recorded Latency)
    50.000%    0.92ms
    75.000%    1.17ms
    90.000%    1.35ms
    99.000%    1.62ms
    99.900%    1.78ms
    99.990%    2.08ms
    99.999%    5.62ms
    100.000%   5.62ms

Detailed Percentile spectrum:

       Value   Percentile   TotalCount 1/(1-Percentile)

       0.162     0.000000            1         1.00
       0.479     0.100000          870         1.11
       0.611     0.200000         1728         1.25
       0.721     0.300000         2596         1.43
       0.819     0.400000         3455         1.67
       0.923     0.500000         4313         2.00
       0.978     0.550000         4747         2.22
       1.024     0.600000         5176         2.50
       1.075     0.650000         5614         2.86
       1.124     0.700000         6045         3.33
       1.174     0.750000         6475         4.00
       1.199     0.775000         6698         4.44
       1.220     0.800000         6900         5.00
       1.248     0.825000         7119         5.71
       1.276     0.850000         7340         6.67
       1.307     0.875000         7549         8.00
       1.327     0.887500         7655         8.89
       1.351     0.900000         7764        10.00
       1.374     0.912500         7873        11.43
       1.402     0.925000         7979        13.33
       1.434     0.937500         8088        16.00
       1.450     0.943750         8141        17.78
       1.466     0.950000         8195        20.00
       1.484     0.956250         8248        22.86
       1.500     0.962500         8306        26.67
       1.521     0.968750         8358        32.00
       1.532     0.971875         8388        35.56
       1.542     0.975000         8410        40.00
       1.556     0.978125         8437        45.71
       1.573     0.981250         8466        53.33
       1.591     0.984375         8491        64.00
       1.603     0.985938         8506        71.11
       1.611     0.987500         8523        80.00
       1.618     0.989062         8533        91.43
       1.629     0.990625         8546       106.67
       1.638     0.992188         8558       128.00
       1.653     0.992969         8566       142.22
       1.662     0.993750         8573       160.00
       1.670     0.994531         8578       182.86
       1.680     0.995313         8586       213.33
       1.700     0.996094         8592       256.00
       1.702     0.996484         8595       284.44
       1.715     0.996875         8599       320.00
       1.720     0.997266         8602       365.71
       1.729     0.997656         8605       426.67
       1.739     0.998047         8609       512.00
       1.750     0.998242         8610       568.89
       1.756     0.998437         8612       640.00
       1.772     0.998633         8614       731.43
       1.774     0.998828         8615       853.33
       1.792     0.999023         8617      1024.00
       1.813     0.999121         8618      1137.78
       1.839     0.999219         8619      1280.00
       1.853     0.999316         8620      1462.86
       1.853     0.999414         8620      1706.67
       1.930     0.999512         8621      2048.00
       1.932     0.999561         8622      2275.56
       1.932     0.999609         8622      2560.00
       1.941     0.999658         8623      2925.71
       1.941     0.999707         8623      3413.33
       1.941     0.999756         8623      4096.00
       2.083     0.999780         8624      4551.11
       2.083     0.999805         8624      5120.00
       2.083     0.999829         8624      5851.43
       2.083     0.999854         8624      6826.67
       2.083     0.999878         8624      8192.00
       5.619     0.999890         8625      9102.22
       5.619     1.000000         8625          inf
***
    #[Mean    =        0.923, StdDeviation   =        0.332]
    #[Max     =        5.616, Total count    =         8625]
    #[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
12032 requests in 1.00m, 830.37KB read

Socket errors: connect 0, read 0, write 0, timeout 1796

Non-2xx or 3xx responses: 6884

Requests/sec:    200.48

Transfer/sec:     13.84KB